This file is a merged representation of a subset of the codebase, containing files not matching ignore patterns, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching these patterns are excluded: .firebase, node_modules, .vercel, coverage, .git, dist
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.env.example
.firebaserc
.gitignore
.vercelignore
database.rules.json
DEPLOY_INFO.md
deploy-vercel.ps1
DEPLOY.md
FIREBASE_SETUP.md
firebase-database-structure.json
firebase-import-helper.html
firebase.json
index.html
metadata.json
nul
package.json
project-memory.md
public/favicon.svg
README.md
scripts/debug-data.js
scripts/import-firebase-data.js
scripts/seed-attendance-data.js
src/App.test.tsx
src/App.tsx
src/components/auth/index.ts
src/components/auth/login.test.tsx
src/components/auth/login.tsx
src/components/employees/index.ts
src/components/hr/add-employee-row.tsx
src/components/hr/employee-detail-modal.tsx
src/components/hr/employee-table-row.tsx
src/components/hr/hr-helpers.ts
src/components/hr/hr-management.tsx
src/components/hr/hr-toolbar.tsx
src/components/hr/index.ts
src/components/index.ts
src/components/shared/backup-button.tsx
src/components/shared/image-capture.tsx
src/components/shared/index.ts
src/components/shared/settings.tsx
src/components/shared/sync-button.tsx
src/components/targets/index.ts
src/components/timesheet/add-employee-modal.tsx
src/components/timesheet/index.ts
src/components/timesheet/timesheet-grid.tsx
src/components/timesheet/timesheet-toolbar.tsx
src/constants/date.ts
src/constants/index.ts
src/core/app-header.tsx
src/core/app-layout.tsx
src/core/app-providers.tsx
src/core/index.ts
src/features/auth/auth-context.tsx
src/features/auth/index.ts
src/features/hr/employees-context.tsx
src/features/hr/index.ts
src/features/targets/components/index.ts
src/features/targets/components/roster-editor.tsx
src/features/targets/components/shift-manager.tsx
src/features/targets/components/target-form.tsx
src/features/targets/components/target-list-item.tsx
src/features/targets/components/target-management.tsx
src/features/targets/components/target-toolbar.tsx
src/features/targets/hooks/use-shift-options.ts
src/features/targets/index.ts
src/features/targets/targets-context.tsx
src/features/timesheet/index.ts
src/features/timesheet/timesheet-context.tsx
src/hooks/index.ts
src/hooks/use-auth.ts
src/hooks/use-autocomplete.ts
src/hooks/use-cell-selection.ts
src/hooks/use-employees.ts
src/hooks/use-sheets-sync.ts
src/hooks/use-targets.ts
src/index.tsx
src/lib/firebase.ts
src/services/backup-service.ts
src/services/firebase/employee-service.ts
src/services/firebase/index.ts
src/services/firebase/shift-service.ts
src/services/firebase/target-service.ts
src/services/firebase/timesheet-service.ts
src/services/gemini-service.ts
src/services/index.ts
src/services/realtime-database-service.ts
src/services/sheets-service.ts
src/services/sync-service.ts
src/test/mocks/handlers.ts
src/test/mocks/server.ts
src/test/setup.ts
src/types/employee.ts
src/types/index.ts
src/types/target.ts
src/types/timesheet.ts
src/utils/auth.ts
src/utils/date-helpers.ts
src/utils/excel-export.ts
src/utils/excel/common.ts
src/utils/excel/employee-excel.ts
src/utils/excel/index.ts
src/utils/excel/payroll-excel.ts
src/utils/excel/target-excel.ts
src/utils/excel/timesheet-excel.ts
src/utils/index.ts
src/utils/timesheet-helpers.ts
tsconfig.json
vercel.json
vite.config.ts
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="nul">
93 src/features/targets/components/roster-editor.tsx
  143 src/features/targets/components/shift-manager.tsx
   86 src/features/targets/components/target-form.tsx
   45 src/features/targets/components/target-list-item.tsx
  163 src/features/targets/components/target-management.tsx
   87 src/features/targets/components/target-toolbar.tsx
   72 src/features/targets/hooks/use-shift-options.ts
  689 total
</file>

<file path=".env.example">
# Firebase Realtime Database Configuration
VITE_FIREBASE_API_KEY=
VITE_FIREBASE_AUTH_DOMAIN=
VITE_FIREBASE_DATABASE_URL=
VITE_FIREBASE_PROJECT_ID=
VITE_FIREBASE_STORAGE_BUCKET=
VITE_FIREBASE_MESSAGING_SENDER_ID=
VITE_FIREBASE_APP_ID=

# Gemini API
VITE_GEMINI_API_KEY=
</file>

<file path=".firebaserc">
{
  "projects": {
    "default": "bachho-timesheet-2025"
  },
  "targets": {},
  "etags": {}
}
</file>

<file path=".gitignore">
# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

node_modules
dist
dist-ssr
*.local

# Editor directories and files
.vscode/*
!.vscode/extensions.json
.idea
.DS_Store
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?

.vercel
plans/

# Environment variables
.env
.env.local
.env.*.local
</file>

<file path=".vercelignore">
node_modules
.git
.env
.env.local
*.log
.DS_Store
dist
.vite
</file>

<file path="database.rules.json">
{
  "rules": {
    ".read": true,
    ".write": true
  }
}
</file>

<file path="DEPLOY_INFO.md">
# âœ… Deploy ThÃ nh CÃ´ng!

## ğŸŒ URLs

### Production (ChÃ­nh)
**https://timesheet-pro-vn.vercel.app**

### Preview
**https://timesheet-pro-hvo4pydo5-congs-projects-f25af77d.vercel.app**

## ğŸ“Š ThÃ´ng Tin Deploy

- âœ… **Status**: Deploy thÃ nh cÃ´ng
- âœ… **Build**: ThÃ nh cÃ´ng (2.46s)
- âœ… **Framework**: Vite
- âœ… **Output**: dist/
- âœ… **Bundle Size**: 271.85 kB (gzip: 81.34 kB)

## ğŸš€ Lá»‡nh Há»¯u Ãch

### Xem logs
```bash
vercel inspect https://timesheet-pro-vn.vercel.app --logs
```

### Redeploy
```bash
vercel redeploy
```

### Deploy láº¡i production
```bash
vercel --prod
```

### Xem táº¥t cáº£ deployments
```bash
vercel ls
```

## ğŸ“ LÆ°u Ã½

1. **Custom Domain**: Báº¡n cÃ³ thá»ƒ thÃªm custom domain trong Vercel Dashboard
2. **Environment Variables**: KhÃ´ng cáº§n cáº¥u hÃ¬nh (API key Ä‘Ã£ hardcode)
3. **Auto Deploy**: Náº¿u káº¿t ná»‘i GitHub, má»—i láº§n push sáº½ tá»± Ä‘á»™ng deploy

## ğŸ‰ HoÃ n thÃ nh!

á»¨ng dá»¥ng cá»§a báº¡n Ä‘Ã£ sáºµn sÃ ng sá»­ dá»¥ng táº¡i: **https://timesheet-pro-vn.vercel.app**
</file>

<file path="deploy-vercel.ps1">
# Script deploy lÃªn Vercel cho Windows PowerShell

Write-Host "ğŸš€ Báº¯t Ä‘áº§u deploy lÃªn Vercel..." -ForegroundColor Green

# Kiá»ƒm tra Vercel CLI
Write-Host "`nğŸ“¦ Kiá»ƒm tra Vercel CLI..." -ForegroundColor Yellow
$vercelInstalled = Get-Command vercel -ErrorAction SilentlyContinue

if (-not $vercelInstalled) {
    Write-Host "âš ï¸  Vercel CLI chÆ°a Ä‘Æ°á»£c cÃ i Ä‘áº·t!" -ForegroundColor Red
    Write-Host "Äang cÃ i Ä‘áº·t Vercel CLI..." -ForegroundColor Yellow
    npm i -g vercel
} else {
    Write-Host "âœ… Vercel CLI Ä‘Ã£ Ä‘Æ°á»£c cÃ i Ä‘áº·t" -ForegroundColor Green
}

# Build project
Write-Host "`nğŸ”¨ Äang build project..." -ForegroundColor Yellow
npm run build

if ($LASTEXITCODE -ne 0) {
    Write-Host "âŒ Build tháº¥t báº¡i!" -ForegroundColor Red
    exit 1
}

Write-Host "âœ… Build thÃ nh cÃ´ng!" -ForegroundColor Green

# Deploy
Write-Host "`nğŸš€ Äang deploy lÃªn Vercel..." -ForegroundColor Yellow
Write-Host "Láº§n Ä‘áº§u tiÃªn sáº½ yÃªu cáº§u Ä‘Äƒng nháº­p vÃ  cáº¥u hÃ¬nh." -ForegroundColor Cyan

vercel --prod

if ($LASTEXITCODE -eq 0) {
    Write-Host "`nâœ… Deploy thÃ nh cÃ´ng!" -ForegroundColor Green
    Write-Host "ğŸŒ á»¨ng dá»¥ng cá»§a báº¡n Ä‘Ã£ Ä‘Æ°á»£c deploy lÃªn Vercel!" -ForegroundColor Cyan
} else {
    Write-Host "`nâŒ Deploy tháº¥t báº¡i!" -ForegroundColor Red
    exit 1
}
</file>

<file path="DEPLOY.md">
# ğŸš€ HÆ°á»›ng Dáº«n Deploy LÃªn Vercel

## âœ… ÄÃ£ chuáº©n bá»‹ sáºµn

- âœ… `vercel.json` Ä‘Ã£ Ä‘Æ°á»£c cáº¥u hÃ¬nh Ä‘Ãºng
- âœ… Build script hoáº¡t Ä‘á»™ng tá»‘t
- âœ… Project Ä‘Ã£ sáºµn sÃ ng Ä‘á»ƒ deploy

## ğŸ“‹ CÃ¡ch Deploy

### CÃ¡ch 1: Sá»­ dá»¥ng Script PowerShell (Nhanh nháº¥t - Windows)

```powershell
.\deploy-vercel.ps1
```

Script sáº½ tá»± Ä‘á»™ng:
1. Kiá»ƒm tra vÃ  cÃ i Ä‘áº·t Vercel CLI (náº¿u chÆ°a cÃ³)
2. Build project
3. Deploy lÃªn Vercel

### CÃ¡ch 2: Deploy thá»§ cÃ´ng qua Vercel CLI

#### BÆ°á»›c 1: CÃ i Ä‘áº·t Vercel CLI
```bash
npm i -g vercel
```

#### BÆ°á»›c 2: ÄÄƒng nháº­p Vercel
```bash
vercel login
```
Sáº½ má»Ÿ trÃ¬nh duyá»‡t Ä‘á»ƒ Ä‘Äƒng nháº­p. Náº¿u chÆ°a cÃ³ tÃ i khoáº£n, Ä‘Äƒng kÃ½ táº¡i [vercel.com](https://vercel.com)

#### BÆ°á»›c 3: Deploy
```bash
vercel
```

Láº§n Ä‘áº§u tiÃªn, Vercel sáº½ há»i:
- **Set up and deploy?** â†’ Nháº¥n `Y`
- **Which scope?** â†’ Chá»n tÃ i khoáº£n cá»§a báº¡n
- **Link to existing project?** â†’ Nháº¥n `N` (táº¡o project má»›i)
- **Project name?** â†’ Nháº­p tÃªn (vÃ­ dá»¥: `timesheet-pro-vn`) hoáº·c Enter Ä‘á»ƒ dÃ¹ng tÃªn máº·c Ä‘á»‹nh
- **Directory?** â†’ Nháº¥n Enter (sá»­ dá»¥ng thÆ° má»¥c hiá»‡n táº¡i)
- **Override settings?** â†’ Nháº¥n `N`

#### BÆ°á»›c 4: Deploy Production
```bash
vercel --prod
```

Sau khi deploy thÃ nh cÃ´ng, báº¡n sáº½ nháº­n Ä‘Æ°á»£c URL nhÆ°: `https://timesheet-pro-vn.vercel.app`

### CÃ¡ch 3: Deploy qua GitHub (Khuyáº¿n nghá»‹ cho team)

#### BÆ°á»›c 1: Táº¡o repository trÃªn GitHub
```bash
git init
git add .
git commit -m "Initial commit"
git branch -M main
git remote add origin https://github.com/YOUR_USERNAME/timesheet-pro-vn.git
git push -u origin main
```

#### BÆ°á»›c 2: Káº¿t ná»‘i vá»›i Vercel
1. Truy cáº­p [vercel.com](https://vercel.com)
2. ÄÄƒng nháº­p báº±ng GitHub
3. Click **Add New Project** hoáº·c **Import Project**
4. Chá»n repository `timesheet-pro-vn`
5. Vercel sáº½ tá»± Ä‘á»™ng detect Vite vÃ  cáº¥u hÃ¬nh:
   - Framework: Vite
   - Build Command: `npm run build`
   - Output Directory: `dist`
6. Click **Deploy**

Vercel sáº½ tá»± Ä‘á»™ng deploy má»—i khi báº¡n push code lÃªn GitHub!

### CÃ¡ch 4: Deploy qua Vercel Dashboard (KhÃ´ng cáº§n CLI)

1. Truy cáº­p [vercel.com](https://vercel.com)
2. ÄÄƒng nháº­p
3. Click **Add New Project**
4. Upload thÆ° má»¥c project (zip) hoáº·c káº¿t ná»‘i Git repository
5. Vercel sáº½ tá»± Ä‘á»™ng detect vÃ  deploy

## âš™ï¸ Cáº¥u hÃ¬nh

File `vercel.json` Ä‘Ã£ Ä‘Æ°á»£c cáº¥u hÃ¬nh:
- âœ… Build command: `npm run build`
- âœ… Output directory: `dist`
- âœ… Framework: Vite
- âœ… SPA routing: Táº¥t cáº£ routes Ä‘á»u trá» vá» `/index.html`

## ğŸ“ LÆ°u Ã½ quan trá»ng

1. **API Key**: API Key Gemini Ä‘Ã£ Ä‘Æ°á»£c hardcode trong code, khÃ´ng cáº§n cáº¥u hÃ¬nh environment variables

2. **Node Version**: Vercel sáº½ tá»± Ä‘á»™ng sá»­ dá»¥ng Node.js 18+ (khÃ´ng cáº§n cáº¥u hÃ¬nh)

3. **Build**: Project Ä‘Ã£ Ä‘Æ°á»£c test build thÃ nh cÃ´ng âœ…

4. **Custom Domain**: Sau khi deploy, báº¡n cÃ³ thá»ƒ thÃªm custom domain trong Vercel Dashboard

## ğŸ”§ Troubleshooting

### Lá»—i build
```bash
# XÃ³a node_modules vÃ  cÃ i láº¡i
rm -rf node_modules package-lock.json
npm install
npm run build
```

### Lá»—i Vercel CLI
```bash
# CÃ i Ä‘áº·t láº¡i Vercel CLI
npm i -g vercel@latest
```

### Kiá»ƒm tra build local
```bash
npm run build
npm run preview
```

## ğŸ“ Há»— trá»£

- Vercel Docs: https://vercel.com/docs
- Vercel Discord: https://vercel.com/discord

---

**ChÃºc báº¡n deploy thÃ nh cÃ´ng! ğŸ‰**
</file>

<file path="FIREBASE_SETUP.md">
# HÆ°á»›ng dáº«n táº¡o Database Firebase Realtime Database

## ğŸš€ CÃ¡ch nhanh nháº¥t (Khuyáº¿n nghá»‹)

### Sá»­ dá»¥ng file HTML helper:
1. Má»Ÿ file `firebase-import-helper.html` trong trÃ¬nh duyá»‡t
2. Click nÃºt **"Copy JSON"** Ä‘á»ƒ copy dá»¯ liá»‡u
3. Má»Ÿ [Firebase Console](https://console.firebase.google.com/project/bachho-2062a/database/bachho-2062a-default-rtdb/data/)
4. Click biá»ƒu tÆ°á»£ng **"â‹®"** (3 cháº¥m) á»Ÿ gÃ³c trÃªn bÃªn pháº£i
5. Chá»n **"Import JSON"**
6. Paste JSON Ä‘Ã£ copy vÃ  click **"Import"**

## BÆ°á»›c 1: Truy cáº­p Firebase Console
1. Má»Ÿ link: https://console.firebase.google.com/project/bachho-2062a/database/bachho-2062a-default-rtdb/data/
2. ÄÄƒng nháº­p báº±ng tÃ i khoáº£n Google cá»§a báº¡n

## BÆ°á»›c 2: Táº¡o cáº¥u trÃºc Database

### CÃ¡ch 1: Import JSON (Khuyáº¿n nghá»‹)
1. Trong Firebase Console, click vÃ o biá»ƒu tÆ°á»£ng **"â‹®"** (3 cháº¥m) á»Ÿ gÃ³c trÃªn bÃªn pháº£i
2. Chá»n **"Import JSON"**
3. Copy toÃ n bá»™ ná»™i dung tá»« file `firebase-database-structure.json` hoáº·c dÃ¹ng file `firebase-import-helper.html`
4. Paste vÃ o vÃ  click **"Import"**

### CÃ¡ch 2: Táº¡o thá»§ cÃ´ng
Táº¡o cÃ¡c node sau trong Firebase Realtime Database:

#### 1. Node `employees` (Danh sÃ¡ch nhÃ¢n viÃªn)
```
employees/
  â”œâ”€â”€ 1/
  â”‚   â”œâ”€â”€ id: "1"
  â”‚   â”œâ”€â”€ code: "314"
  â”‚   â”œâ”€â”€ name: "Tráº§n Há»¯u LiÃªn Viá»‡t"
  â”‚   â”œâ”€â”€ department: "VÄƒn PhÃ²ng"
  â”‚   â”œâ”€â”€ shift: "08h00 - 17h00"
  â”‚   â”œâ”€â”€ password: "123"
  â”‚   â””â”€â”€ role: "admin"
  â”œâ”€â”€ 2/
  â”‚   â””â”€â”€ ... (tÆ°Æ¡ng tá»±)
  â””â”€â”€ ...
```

#### 2. Node `targets` (Má»¥c tiÃªu/PhÃ²ng ban)
```
targets/
  â”œâ”€â”€ t1/
  â”‚   â”œâ”€â”€ id: "t1"
  â”‚   â”œâ”€â”€ name: "VÄƒn PhÃ²ng ChÃ­nh"
  â”‚   â””â”€â”€ roster/
  â”‚       â”œâ”€â”€ 0/
  â”‚       â”‚   â”œâ”€â”€ employeeId: "1"
  â”‚       â”‚   â””â”€â”€ shift: "08h00 - 17h00"
  â”‚       â””â”€â”€ ...
  â””â”€â”€ ...
```

#### 3. Node `timesheets` (Dá»¯ liá»‡u cháº¥m cÃ´ng theo nÄƒm/thÃ¡ng)
```
timesheets/
  â””â”€â”€ 2025/
      â””â”€â”€ 12/  (thÃ¡ng 12)
          â”œâ”€â”€ 1/  (employeeId)
          â”‚   â”œâ”€â”€ id: "1"
          â”‚   â”œâ”€â”€ code: "314"
          â”‚   â”œâ”€â”€ name: "Tráº§n Há»¯u LiÃªn Viá»‡t"
          â”‚   â”œâ”€â”€ department: "VÄƒn PhÃ²ng"
          â”‚   â”œâ”€â”€ shift: "08h00 - 17h00"
          â”‚   â””â”€â”€ attendance/
          â”‚       â”œâ”€â”€ 1: "1"
          â”‚       â”œâ”€â”€ 2: "1"
          â”‚       â”œâ”€â”€ 6: "CN"
          â”‚       â””â”€â”€ ... (cÃ¡c ngÃ y khÃ¡c)
          â””â”€â”€ ...
```

#### 4. Node `workflows` (Quy trÃ¬nh sáº£n xuáº¥t - náº¿u cÃ³)
```
workflows/
  â””â”€â”€ workflow1/
      â”œâ”€â”€ id: "workflow1"
      â”œâ”€â”€ name: "Quy trÃ¬nh sáº£n xuáº¥t 1"
      â”œâ”€â”€ steps/
      â”‚   â”œâ”€â”€ step1/
      â”‚   â”‚   â”œâ”€â”€ id: "step1"
      â”‚   â”‚   â”œâ”€â”€ name: "BÆ°á»›c 1"
      â”‚   â”‚   â”œâ”€â”€ order: 1
      â”‚   â”‚   â””â”€â”€ note: ""  (ghi chÃº cho bÆ°á»›c nÃ y)
      â”‚   â””â”€â”€ ...
      â”œâ”€â”€ createdAt: "2025-01-01T00:00:00Z"
      â””â”€â”€ updatedAt: "2025-01-01T00:00:00Z"
```

## Cáº¥u trÃºc dá»¯ liá»‡u chi tiáº¿t

### Employee (NhÃ¢n viÃªn)
- `id`: ID duy nháº¥t
- `code`: MÃ£ nhÃ¢n viÃªn
- `name`: TÃªn Ä‘áº§y Ä‘á»§
- `department`: PhÃ²ng ban (VÄƒn PhÃ²ng, Kho A, Kho B, Káº¿ ToÃ¡n)
- `shift`: Ca lÃ m viá»‡c
- `password`: Máº­t kháº©u Ä‘Äƒng nháº­p
- `role`: Vai trÃ² ("admin" hoáº·c "staff")

### Target (Má»¥c tiÃªu)
- `id`: ID duy nháº¥t
- `name`: TÃªn má»¥c tiÃªu
- `roster`: Danh sÃ¡ch nhÃ¢n viÃªn trong má»¥c tiÃªu
  - `employeeId`: ID nhÃ¢n viÃªn
  - `shift`: Ca lÃ m viá»‡c

### Timesheet (Cháº¥m cÃ´ng)
- Cáº¥u trÃºc: `timesheets/{year}/{month}/{employeeId}`
- `attendance`: Object vá»›i key lÃ  sá»‘ ngÃ y (1-31), value lÃ :
  - `"1"`: LÃ m Ä‘á»§ cÃ´ng
  - `"0.5"`: Ná»­a cÃ´ng
  - `"P"`: Nghá»‰ phÃ©p
  - `"CN"`: Chá»§ nháº­t

### Workflow (Quy trÃ¬nh)
- `id`: ID duy nháº¥t
- `name`: TÃªn quy trÃ¬nh
- `steps`: CÃ¡c bÆ°á»›c trong quy trÃ¬nh
  - `id`: ID bÆ°á»›c
  - `name`: TÃªn bÆ°á»›c
  - `order`: Thá»© tá»±
  - `note`: Ghi chÃº (Ä‘á»ƒ láº¡i cho ngÆ°á»i lÃ m bÆ°á»›c tiáº¿p theo)

## LÆ°u Ã½
- Äáº£m báº£o Rules cá»§a Firebase cho phÃ©p Ä‘á»c/ghi dá»¯ liá»‡u
- CÃ³ thá»ƒ cáº§n cáº¥u hÃ¬nh Authentication náº¿u code yÃªu cáº§u
- Dá»¯ liá»‡u máº«u trong file JSON chá»‰ lÃ  vÃ­ dá»¥, báº¡n cÃ³ thá»ƒ thÃªm/sá»­a theo nhu cáº§u
</file>

<file path="firebase-database-structure.json">
{
  "employees": {
    "1": {
      "id": "1",
      "code": "314",
      "name": "Tráº§n Há»¯u LiÃªn Viá»‡t",
      "department": "VÄƒn PhÃ²ng",
      "shift": "08h00 - 17h00",
      "password": "123",
      "role": "admin"
    },
    "2": {
      "id": "2",
      "code": "111",
      "name": "Tráº§n XuÃ¢n Äá»©c",
      "department": "VÄƒn PhÃ²ng",
      "shift": "08h00 - 17h00",
      "password": "123",
      "role": "staff"
    },
    "3": {
      "id": "3",
      "code": "473",
      "name": "Nguyá»…n Quá»‘c PhÃ¡p",
      "department": "Kho A",
      "shift": "06h00 - 14h00",
      "password": "123",
      "role": "staff"
    },
    "4": {
      "id": "4",
      "code": "347",
      "name": "LÃª Anh Tuáº¥n",
      "department": "Kho A",
      "shift": "14h00 - 22h00",
      "password": "123",
      "role": "staff"
    },
    "5": {
      "id": "5",
      "code": "222",
      "name": "VÃµ Äá»©c LiÃªm",
      "department": "Kho B",
      "shift": "06h00 - 18h00",
      "password": "123",
      "role": "staff"
    },
    "6": {
      "id": "6",
      "code": "333",
      "name": "Nguyá»…n HÃ  Trang",
      "department": "VÄƒn PhÃ²ng",
      "shift": "08h00 - 17h00",
      "password": "123",
      "role": "staff"
    },
    "7": {
      "id": "7",
      "code": "444",
      "name": "LÃª Duy Há»£i",
      "department": "Kho B",
      "shift": "18h00 - 06h00",
      "password": "123",
      "role": "staff"
    },
    "8": {
      "id": "8",
      "code": "555",
      "name": "Pháº¡m Thá»‹ ThÃ¹y Linh",
      "department": "Káº¿ ToÃ¡n",
      "shift": "08h00 - 17h00",
      "password": "123",
      "role": "admin"
    }
  },
  "targets": {
    "t1": {
      "id": "t1",
      "name": "VÄƒn PhÃ²ng ChÃ­nh",
      "roster": {
        "0": {
          "employeeId": "1",
          "shift": "08h00 - 17h00"
        },
        "1": {
          "employeeId": "2",
          "shift": "08h00 - 17h00"
        },
        "2": {
          "employeeId": "6",
          "shift": "08h00 - 17h00"
        }
      }
    },
    "t2": {
      "id": "t2",
      "name": "Má»¥c TiÃªu Kho A",
      "roster": {
        "0": {
          "employeeId": "3",
          "shift": "06h00 - 14h00"
        },
        "1": {
          "employeeId": "4",
          "shift": "14h00 - 22h00"
        }
      }
    },
    "t3": {
      "id": "t3",
      "name": "Má»¥c TiÃªu Kho B",
      "roster": {
        "0": {
          "employeeId": "5",
          "shift": "06h00 - 18h00"
        },
        "1": {
          "employeeId": "7",
          "shift": "18h00 - 06h00"
        }
      }
    }
  },
  "timesheets": {
    "2025": {
      "12": {
        "1": {
          "id": "1",
          "code": "314",
          "name": "Tráº§n Há»¯u LiÃªn Viá»‡t",
          "department": "VÄƒn PhÃ²ng",
          "shift": "08h00 - 17h00",
          "attendance": {
            "1": "1",
            "2": "1",
            "3": "1",
            "4": "1",
            "5": "1",
            "6": "CN",
            "7": "CN",
            "8": "1",
            "9": "1",
            "10": "1",
            "11": "1",
            "12": "1",
            "13": "CN",
            "14": "CN",
            "15": "1",
            "16": "1",
            "17": "1",
            "18": "1",
            "19": "1",
            "20": "CN",
            "21": "CN",
            "22": "1",
            "23": "1",
            "24": "1",
            "25": "1",
            "26": "1",
            "27": "CN",
            "28": "CN",
            "29": "1",
            "30": "1",
            "31": "1"
          }
        },
        "2": {
          "id": "2",
          "code": "111",
          "name": "Tráº§n XuÃ¢n Äá»©c",
          "department": "VÄƒn PhÃ²ng",
          "shift": "08h00 - 17h00",
          "attendance": {
            "1": "1",
            "2": "1",
            "3": "1",
            "4": "1",
            "5": "1",
            "6": "CN",
            "7": "CN",
            "8": "1",
            "9": "1",
            "10": "1",
            "11": "1",
            "12": "1",
            "13": "CN",
            "14": "CN",
            "15": "1",
            "16": "1",
            "17": "1",
            "18": "1",
            "19": "1",
            "20": "CN",
            "21": "CN",
            "22": "1",
            "23": "1",
            "24": "1",
            "25": "1",
            "26": "1",
            "27": "CN",
            "28": "CN",
            "29": "1",
            "30": "1",
            "31": "1"
          }
        }
      }
    }
  },
  "workflows": {
    "workflow1": {
      "id": "workflow1",
      "name": "Quy trÃ¬nh sáº£n xuáº¥t 1",
      "steps": {
        "step1": {
          "id": "step1",
          "name": "BÆ°á»›c 1",
          "order": 1,
          "note": ""
        },
        "step2": {
          "id": "step2",
          "name": "BÆ°á»›c 2",
          "order": 2,
          "note": ""
        }
      },
      "createdAt": "2025-01-01T00:00:00Z",
      "updatedAt": "2025-01-01T00:00:00Z"
    }
  }
}
</file>

<file path="firebase-import-helper.html">
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Database Import Helper</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        .header p {
            opacity: 0.9;
            font-size: 16px;
        }
        .content {
            padding: 30px;
        }
        .step {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .step h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 20px;
        }
        .step ol {
            margin-left: 20px;
            line-height: 1.8;
        }
        .step li {
            margin-bottom: 10px;
        }
        .json-container {
            position: relative;
            margin: 20px 0;
        }
        textarea {
            width: 100%;
            min-height: 400px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            resize: vertical;
            background: #f8f9fa;
        }
        textarea:focus {
            outline: none;
            border-color: #667eea;
            background: white;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
        }
        .btn-copy {
            background: #667eea;
            color: white;
        }
        .btn-copy:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .btn-copy:active {
            transform: translateY(0);
        }
        .btn-select {
            background: #28a745;
            color: white;
        }
        .btn-select:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }
        .warning strong {
            display: block;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”¥ Firebase Database Import Helper</h1>
            <p>Copy JSON data Ä‘á»ƒ import vÃ o Firebase Realtime Database</p>
        </div>
        <div class="content">
            <div class="step">
                <h2>ğŸ“‹ HÆ°á»›ng dáº«n sá»­ dá»¥ng:</h2>
                <ol>
                    <li>Click nÃºt <strong>"Select All"</strong> Ä‘á»ƒ chá»n toÃ n bá»™ JSON</li>
                    <li>Click nÃºt <strong>"Copy"</strong> Ä‘á»ƒ copy vÃ o clipboard</li>
                    <li>Má»Ÿ <a href="https://console.firebase.google.com/project/bachho-2062a/database/bachho-2062a-default-rtdb/data/" target="_blank">Firebase Console</a></li>
                    <li>Click biá»ƒu tÆ°á»£ng <strong>"â‹®"</strong> (3 cháº¥m) á»Ÿ gÃ³c trÃªn bÃªn pháº£i</li>
                    <li>Chá»n <strong>"Import JSON"</strong></li>
                    <li>Paste JSON Ä‘Ã£ copy vÃ  click <strong>"Import"</strong></li>
                </ol>
            </div>

            <div class="warning">
                <strong>âš ï¸ LÆ°u Ã½:</strong>
                Import JSON sáº½ <strong>GHI ÄÃˆ</strong> toÃ n bá»™ dá»¯ liá»‡u hiá»‡n táº¡i trong database. HÃ£y Ä‘áº£m báº£o báº¡n Ä‘Ã£ backup dá»¯ liá»‡u cÅ© náº¿u cáº§n!
            </div>

            <div class="json-container">
                <textarea id="jsonData" readonly></textarea>
                <div class="button-group">
                    <button class="btn-select" onclick="selectAll()">ğŸ“‹ Select All</button>
                    <button class="btn-copy" onclick="copyToClipboard()">ğŸ“¥ Copy JSON</button>
                </div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification">
        âœ… ÄÃ£ copy vÃ o clipboard!
    </div>

    <script>
        // Load JSON data
        const jsonData = {
  "employees": {
    "1": {
      "id": "1",
      "code": "314",
      "name": "Tráº§n Há»¯u LiÃªn Viá»‡t",
      "department": "VÄƒn PhÃ²ng",
      "shift": "08h00 - 17h00",
      "password": "123",
      "role": "admin"
    },
    "2": {
      "id": "2",
      "code": "111",
      "name": "Tráº§n XuÃ¢n Äá»©c",
      "department": "VÄƒn PhÃ²ng",
      "shift": "08h00 - 17h00",
      "password": "123",
      "role": "staff"
    },
    "3": {
      "id": "3",
      "code": "473",
      "name": "Nguyá»…n Quá»‘c PhÃ¡p",
      "department": "Kho A",
      "shift": "06h00 - 14h00",
      "password": "123",
      "role": "staff"
    },
    "4": {
      "id": "4",
      "code": "347",
      "name": "LÃª Anh Tuáº¥n",
      "department": "Kho A",
      "shift": "14h00 - 22h00",
      "password": "123",
      "role": "staff"
    },
    "5": {
      "id": "5",
      "code": "222",
      "name": "VÃµ Äá»©c LiÃªm",
      "department": "Kho B",
      "shift": "06h00 - 18h00",
      "password": "123",
      "role": "staff"
    },
    "6": {
      "id": "6",
      "code": "333",
      "name": "Nguyá»…n HÃ  Trang",
      "department": "VÄƒn PhÃ²ng",
      "shift": "08h00 - 17h00",
      "password": "123",
      "role": "staff"
    },
    "7": {
      "id": "7",
      "code": "444",
      "name": "LÃª Duy Há»£i",
      "department": "Kho B",
      "shift": "18h00 - 06h00",
      "password": "123",
      "role": "staff"
    },
    "8": {
      "id": "8",
      "code": "555",
      "name": "Pháº¡m Thá»‹ ThÃ¹y Linh",
      "department": "Káº¿ ToÃ¡n",
      "shift": "08h00 - 17h00",
      "password": "123",
      "role": "admin"
    }
  },
  "targets": {
    "t1": {
      "id": "t1",
      "name": "VÄƒn PhÃ²ng ChÃ­nh",
      "roster": {
        "0": {
          "employeeId": "1",
          "shift": "08h00 - 17h00"
        },
        "1": {
          "employeeId": "2",
          "shift": "08h00 - 17h00"
        },
        "2": {
          "employeeId": "6",
          "shift": "08h00 - 17h00"
        }
      }
    },
    "t2": {
      "id": "t2",
      "name": "Má»¥c TiÃªu Kho A",
      "roster": {
        "0": {
          "employeeId": "3",
          "shift": "06h00 - 14h00"
        },
        "1": {
          "employeeId": "4",
          "shift": "14h00 - 22h00"
        }
      }
    },
    "t3": {
      "id": "t3",
      "name": "Má»¥c TiÃªu Kho B",
      "roster": {
        "0": {
          "employeeId": "5",
          "shift": "06h00 - 18h00"
        },
        "1": {
          "employeeId": "7",
          "shift": "18h00 - 06h00"
        }
      }
    }
  },
  "timesheets": {
    "2025": {
      "12": {
        "1": {
          "id": "1",
          "code": "314",
          "name": "Tráº§n Há»¯u LiÃªn Viá»‡t",
          "department": "VÄƒn PhÃ²ng",
          "shift": "08h00 - 17h00",
          "attendance": {
            "1": "1",
            "2": "1",
            "3": "1",
            "4": "1",
            "5": "1",
            "6": "CN",
            "7": "CN",
            "8": "1",
            "9": "1",
            "10": "1",
            "11": "1",
            "12": "1",
            "13": "CN",
            "14": "CN",
            "15": "1",
            "16": "1",
            "17": "1",
            "18": "1",
            "19": "1",
            "20": "CN",
            "21": "CN",
            "22": "1",
            "23": "1",
            "24": "1",
            "25": "1",
            "26": "1",
            "27": "CN",
            "28": "CN",
            "29": "1",
            "30": "1",
            "31": "1"
          }
        },
        "2": {
          "id": "2",
          "code": "111",
          "name": "Tráº§n XuÃ¢n Äá»©c",
          "department": "VÄƒn PhÃ²ng",
          "shift": "08h00 - 17h00",
          "attendance": {
            "1": "1",
            "2": "1",
            "3": "1",
            "4": "1",
            "5": "1",
            "6": "CN",
            "7": "CN",
            "8": "1",
            "9": "1",
            "10": "1",
            "11": "1",
            "12": "1",
            "13": "CN",
            "14": "CN",
            "15": "1",
            "16": "1",
            "17": "1",
            "18": "1",
            "19": "1",
            "20": "CN",
            "21": "CN",
            "22": "1",
            "23": "1",
            "24": "1",
            "25": "1",
            "26": "1",
            "27": "CN",
            "28": "CN",
            "29": "1",
            "30": "1",
            "31": "1"
          }
        }
      }
    }
  },
  "workflows": {
    "workflow1": {
      "id": "workflow1",
      "name": "Quy trÃ¬nh sáº£n xuáº¥t 1",
      "steps": {
        "step1": {
          "id": "step1",
          "name": "BÆ°á»›c 1",
          "order": 1,
          "note": ""
        },
        "step2": {
          "id": "step2",
          "name": "BÆ°á»›c 2",
          "order": 2,
          "note": ""
        }
      },
      "createdAt": "2025-01-01T00:00:00Z",
      "updatedAt": "2025-01-01T00:00:00Z"
    }
  }
};

        // Display formatted JSON
        document.getElementById('jsonData').value = JSON.stringify(jsonData, null, 2);

        function selectAll() {
            const textarea = document.getElementById('jsonData');
            textarea.select();
            textarea.setSelectionRange(0, 99999); // For mobile devices
        }

        function copyToClipboard() {
            const textarea = document.getElementById('jsonData');
            textarea.select();
            textarea.setSelectionRange(0, 99999);
            
            try {
                document.execCommand('copy');
                showNotification();
            } catch (err) {
                // Fallback for modern browsers
                navigator.clipboard.writeText(textarea.value).then(() => {
                    showNotification();
                }).catch(err => {
                    alert('KhÃ´ng thá»ƒ copy. Vui lÃ²ng chá»n vÃ  copy thá»§ cÃ´ng.');
                });
            }
        }

        function showNotification() {
            const notification = document.getElementById('notification');
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 2000);
        }
    </script>
</body>
</html>
</file>

<file path="firebase.json">
{
  "hosting": {
    "public": "dist",
    "ignore": [
      "firebase.json",
      "**/.*",
      "**/node_modules/**"
    ],
    "rewrites": [
      {
        "source": "**",
        "destination": "/index.html"
      }
    ]
  },
  "database": {
    "rules": "database.rules.json"
  }
}
</file>

<file path="metadata.json">
{
  "name": "Timesheet Pro VN",
  "description": "Pháº§n má»m quáº£n trá»‹ cháº¥m cÃ´ng nháº­p liá»‡u nhanh kiá»ƒu Excel, tÃ­ch há»£p AI phÃ¢n tÃ­ch dá»¯ liá»‡u.",
  "requestFramePermissions": []
}
</file>

<file path="package.json">
{
  "name": "timesheet-pro-vn",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview",
    "import-firebase": "node scripts/import-firebase-data.js",
    "seed-attendance": "node scripts/seed-attendance-data.js",
    "test": "vitest",
    "test:ui": "vitest --ui",
    "test:run": "vitest run",
    "test:coverage": "vitest run --coverage",
    "test:watch": "vitest --watch"
  },
  "dependencies": {
    "@google/genai": "^1.34.0",
    "firebase": "^12.7.0",
    "lucide-react": "^0.562.0",
    "react": "^19.2.3",
    "react-dom": "^19.2.3",
    "xlsx": "^0.18.5"
  },
  "devDependencies": {
    "@testing-library/jest-dom": "^6.9.1",
    "@testing-library/react": "^16.3.1",
    "@testing-library/user-event": "^14.6.1",
    "@types/node": "^22.14.0",
    "@vitejs/plugin-react": "^5.0.0",
    "@vitest/coverage-v8": "^4.0.16",
    "@vitest/ui": "^4.0.16",
    "jsdom": "^27.4.0",
    "msw": "^2.12.6",
    "typescript": "~5.8.2",
    "vite": "^6.2.0",
    "vitest": "^4.0.16"
  }
}
</file>

<file path="project-memory.md">
# Project Memory - timesheet-pro-vn

**Last Updated:** 2025-12-27 18:50
**Session:** Context Restoration (Ultrathink)

---

## Project Identity

| Field | Value |
|-------|-------|
| Name | timesheet-pro-vn |
| Type | Vietnamese Timesheet/Attendance App |
| Client | Báº¡ch Há»• Security (Bach Ho Security) |
| Stack | React 19 + Vite + Firebase + Gemini AI |
| Status | Development - Security Review Complete |

---

## Current State

### Progress
- **Active Plan:** `plans/251226-2123-codebase-improvement/` (4 phases)
- **Phase Status:** All PENDING (not started)
- **Branch:** main
- **Uncommitted:** Yes (plan files + code mods staged)

### Security Score: 2/10 (CRITICAL)
| Issue | Severity | Location |
|-------|----------|----------|
| Hardcoded API Key | CRITICAL | `geminiService.ts:5`, `ImageCapture.tsx:6` |
| Plaintext Passwords | CRITICAL | `constants.ts` |
| Client-side Auth Only | CRITICAL | `App.tsx:44-55` |
| No Data Persistence | HIGH | localStorage only |

---

## Architecture Quick Ref

### Structure
```
â”œâ”€â”€ components/          # 6 React components
â”‚   â”œâ”€â”€ Login.tsx
â”‚   â”œâ”€â”€ Settings.tsx
â”‚   â”œâ”€â”€ ImageCapture.tsx
â”‚   â”œâ”€â”€ TimesheetGrid.tsx  # 806 lines - needs split
â”‚   â”œâ”€â”€ TargetManagement.tsx
â”‚   â””â”€â”€ HRManagement.tsx   # 668 lines - needs split
â”œâ”€â”€ services/
â”‚   â””â”€â”€ geminiService.ts   # Gemini AI for OCR
â”œâ”€â”€ scripts/
â”œâ”€â”€ plans/                 # Improvement plan
â””â”€â”€ App.tsx
```

### Tech Stack
- **Frontend:** React 19, Vite, Lucide React icons
- **Backend:** Firebase (included but unused)
- **AI:** Google Gemini (@google/genai)
- **Types:** TypeScript ~5.8

---

## Active Plans

### 251226-2123-codebase-improvement (P1 - 20-27h)

| Phase | Name | Estimate | Status |
|-------|------|----------|--------|
| 1 | Security Hotfix | 2-3h | PENDING (URGENT) |
| 2 | Firebase Integration | 6-8h | Blocked by P1 |
| 3 | Architecture Refactoring | 8-10h | Blocked by P2 |
| 4 | Polish & Production | 4-6h | Blocked by P3 |

**Phase 1 Priority:**
1. Revoke exposed API key at Google AI Studio
2. Create `.env.local` + `.env.example`
3. Update code to use env vars
4. Add security headers to vercel.json

---

## Session Continuity

### Decisions Made
- 4-phase progressive disclosure plan created
- Security-first approach (Phase 1 must complete before deployment)
- Firebase modular SDK pattern selected

### Unresolved Questions
1. User migration strategy for password reset?
2. Is localStorage backup needed before Firebase migration?
3. Single company or multi-tenant?
4. Error monitoring (Sentry) in Phase 4?

### Next Session Actions
1. **URGENT:** Execute Phase 1 (Security Hotfix)
2. Follow `phases/phase-01-security-hotfix.md`
3. Commit plan files before starting implementation

---

## Reports Generated (2025-12-26)

| # | Report | Purpose |
|---|--------|---------|
| 001 | researcher-security-best-practices | React security patterns 2025 |
| 002 | researcher-firebase-integration | Firebase auth/Firestore patterns |
| 003 | code-review-security-architecture | Security audit (12 issues) |
| 004 | code-review-quality-performance | Quality/performance audit |
| 005 | planner-to-implementation-specialist-plan-report | Implementation handover |
| - | review-251226-2123-final-summary | Executive summary |

---

## Quick Commands

```bash
# Dev server
npm run dev

# Build
npm run build

# Read current plan
cat plans/251226-2123-codebase-improvement/plan.md

# Start Phase 1
cat plans/251226-2123-codebase-improvement/phases/phase-01-security-hotfix.md
```

---

*Memory updated: 2025-12-27 18:50*
</file>

<file path="public/favicon.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
  <rect width="100" height="100" rx="20" fill="#1d4ed8"/>
  <text x="50" y="70" font-size="60" text-anchor="middle" fill="white" font-family="Arial, sans-serif" font-weight="bold">BH</text>
</svg>
</file>

<file path="scripts/debug-data.js">
import { initializeApp } from 'firebase/app';
import { getDatabase, ref, get } from 'firebase/database';

const app = initializeApp({ databaseURL: 'https://bachho-timesheet-2025-default-rtdb.asia-southeast1.firebasedatabase.app' });
const db = getDatabase(app);

async function debug() {
    const snapshot = await get(ref(db, 'employees'));
    const data = snapshot.val();

    console.log('=== RAW DATA ===');
    console.log('Is Array:', Array.isArray(data));
    console.log('Keys:', Object.keys(data));

    // Exact employee-service transform
    const employees = Object.keys(data).map(key => ({
        id: key,
        attendance: {},
        ...data[key]
    }));

    console.log('\n=== TRANSFORMED ===');
    console.log('Count:', employees.length);

    employees.forEach((emp, idx) => {
        const attKeys = Object.keys(emp.attendance || {}).length;
        const att1 = emp.attendance?.[1];
        console.log(`${idx}) ID:${emp.id} Name:${emp.name} AttKeys:${attKeys} Att[1]:${att1}`);
    });

    // Calculate total
    const calculateTotal = (attendance) => {
        if (!attendance) return 0;
        let total = 0;
        Object.values(attendance).forEach((val) => {
            const num = parseFloat(val);
            if (!isNaN(num)) total += num;
        });
        return total;
    };

    const grandTotal = employees.reduce((acc, curr) => acc + calculateTotal(curr.attendance), 0);
    console.log('\nGrand Total:', grandTotal, 'cÃ´ng');

    process.exit(0);
}

debug();
</file>

<file path="scripts/import-firebase-data.js">
import { initializeApp } from 'firebase/app';
import { getDatabase, ref, set } from 'firebase/database';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Firebase configuration - must match lib/firebase.ts
const firebaseConfig = {
  databaseURL: 'https://bachho-timesheet-2025-default-rtdb.asia-southeast1.firebasedatabase.app'
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const database = getDatabase(app);

// Read JSON data
const jsonPath = path.join(__dirname, '..', 'firebase-database-structure.json');
const jsonData = JSON.parse(fs.readFileSync(jsonPath, 'utf8'));

async function importData() {
  console.log('ğŸš€ Báº¯t Ä‘áº§u import dá»¯ liá»‡u vÃ o Firebase...\n');

  try {
    // Import employees
    console.log('ğŸ“ Äang import employees...');
    for (const [key, employee] of Object.entries(jsonData.employees)) {
      await set(ref(database, `employees/${key}`), employee);
      console.log(`  âœ“ ÄÃ£ thÃªm nhÃ¢n viÃªn: ${employee.name} (${employee.code})`);
    }

    // Import targets
    console.log('\nğŸ“ Äang import targets...');
    for (const [key, target] of Object.entries(jsonData.targets)) {
      await set(ref(database, `targets/${key}`), target);
      console.log(`  âœ“ ÄÃ£ thÃªm má»¥c tiÃªu: ${target.name}`);
    }

    // Import timesheets
    console.log('\nğŸ“ Äang import timesheets...');
    for (const [year, yearData] of Object.entries(jsonData.timesheets)) {
      for (const [month, monthData] of Object.entries(yearData)) {
        for (const [employeeId, timesheet] of Object.entries(monthData)) {
          await set(ref(database, `timesheets/${year}/${month}/${employeeId}`), timesheet);
          console.log(`  âœ“ ÄÃ£ thÃªm cháº¥m cÃ´ng: ${timesheet.name} - ${month}/${year}`);
        }
      }
    }

    // Import workflows
    if (jsonData.workflows) {
      console.log('\nğŸ“ Äang import workflows...');
      for (const [key, workflow] of Object.entries(jsonData.workflows)) {
        await set(ref(database, `workflows/${key}`), workflow);
        console.log(`  âœ“ ÄÃ£ thÃªm workflow: ${workflow.name}`);
      }
    }

    console.log('\nâœ… HoÃ n thÃ nh! Táº¥t cáº£ dá»¯ liá»‡u Ä‘Ã£ Ä‘Æ°á»£c import vÃ o Firebase.');
    console.log('\nğŸ”— Kiá»ƒm tra táº¡i: https://console.firebase.google.com/project/bachho-2062a/database/bachho-2062a-default-rtdb/data/');
    
    process.exit(0);
  } catch (error) {
    console.error('\nâŒ Lá»—i khi import dá»¯ liá»‡u:', error);
    process.exit(1);
  }
}

// Run import
importData();
</file>

<file path="src/components/auth/login.test.tsx">
import { describe, it, expect, vi } from 'vitest'
import { render, screen, waitFor } from '@testing-library/react'
import userEvent from '@testing-library/user-event'
import { Login } from './Login'

describe('Login', () => {
  it('renders login form', () => {
    render(<Login onLogin={vi.fn()} />)

    // Check for form elements using the exact placeholder text
    const codeInput = screen.getByPlaceholderText(/Nháº­p mÃ£ sá»‘/i)
    const passwordInput = screen.getByPlaceholderText(/â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢/)
    const submitButton = screen.getByRole('button', { name: /ÄÄƒng nháº­p/i })

    expect(codeInput).toBeInTheDocument()
    expect(passwordInput).toBeInTheDocument()
    expect(submitButton).toBeInTheDocument()
  })

  it('calls onLogin when form submitted with valid credentials', async () => {
    const mockOnLogin = vi.fn().mockResolvedValue(undefined)
    const user = userEvent.setup()

    render(<Login onLogin={mockOnLogin} />)

    const codeInput = screen.getByPlaceholderText(/Nháº­p mÃ£ sá»‘/i)
    const passwordInput = screen.getByPlaceholderText(/â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢/)
    const submitButton = screen.getByRole('button', { name: /ÄÄƒng nháº­p/i })

    await user.type(codeInput, '001')
    await user.type(passwordInput, '123')
    await user.click(submitButton)

    // Wait for the simulated network delay (800ms) + a bit extra
    await waitFor(() => {
      expect(mockOnLogin).toHaveBeenCalledWith('001', '123')
    }, { timeout: 2000 })
  })

  it('shows loading state during login', async () => {
    const mockOnLogin = vi.fn().mockImplementation(() =>
      new Promise(resolve => setTimeout(resolve, 500))
    )
    const user = userEvent.setup()

    render(<Login onLogin={mockOnLogin} />)

    const codeInput = screen.getByPlaceholderText(/Nháº­p mÃ£ sá»‘/i)
    const passwordInput = screen.getByPlaceholderText(/â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢/)
    const submitButton = screen.getByRole('button', { name: /ÄÄƒng nháº­p/i })

    await user.type(codeInput, '001')
    await user.type(passwordInput, '123')
    await user.click(submitButton)

    // Check for loading state (button should be disabled or show loading text)
    expect(submitButton).toBeDisabled()
  })
})
</file>

<file path="src/components/auth/login.tsx">
/**
 * Login component
 * Authentication UI for employees
 */

import React, { useState } from 'react';

interface LoginProps {
  onLogin: (code: string, pass: string) => Promise<void>;
}

export const Login: React.FC<LoginProps> = ({ onLogin }) => {
  const [code, setCode] = useState('');
  const [password, setPassword] = useState('');
  const [showPassword, setShowPassword] = useState(false);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsLoading(true);
    setError(null);

    try {
      await new Promise(resolve => setTimeout(resolve, 800));
      await onLogin(code, password);
    } catch (err: any) {
      setError(err.message || "ÄÄƒng nháº­p tháº¥t báº¡i");
    } finally {
      setIsLoading(false);
    }
  };

  const logoUrl = "https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Fa95c8148.%E1%BA%A2nh.072220.jpg";

  return (
    <div className="bg-gray-50 min-h-screen flex items-center justify-center p-4 lg:p-0 font-[Montserrat]">
      <div className="w-full h-screen flex overflow-hidden">

        {/* Left Column: Background */}
        <div className="hidden lg:flex lg:w-1/2 relative bg-gray-900 overflow-hidden">
          <div className="absolute inset-0 bg-cover bg-center transition-transform duration-[40s] hover:scale-110"
            style={{ backgroundImage: "url('https://images.unsplash.com/photo-1595590424283-b8f17842773f?q=80&w=2070&auto=format&fit=crop')" }}>
          </div>
          <div className="absolute inset-0 pointer-events-none opacity-25 mix-blend-overlay bg-cover bg-center"
            style={{ backgroundImage: "url('https://images.unsplash.com/photo-1564349683136-77e08dba1ef7?q=80&w=2672&auto=format&fit=crop')" }}>
          </div>
          <div className="absolute inset-0 bg-gradient-to-t from-black via-gray-900/60 to-blue-900/20 mix-blend-multiply"></div>

          <div className="relative z-10 w-full flex flex-col justify-between p-12 text-white">
            <div className="flex items-center gap-3">
              <div className="w-12 h-12 bg-white/10 backdrop-blur-md rounded-full flex items-center justify-center shadow-lg border border-white/20 overflow-hidden">
                <img src={logoUrl} alt="Logo Small" className="w-full h-full object-cover" />
              </div>
              <span className="text-xl font-bold tracking-widest text-white uppercase drop-shadow-md border-l-2 border-amber-500 pl-3">
                Bach Ho Security
              </span>
            </div>

            <div className="mb-10">
              <div className="inline-block px-3 py-1 mb-4 border border-amber-500/50 rounded-full bg-black/40 backdrop-blur-sm text-amber-400 text-xs font-bold tracking-wider uppercase">
                Elite Protection Services
              </div>
              <h1 className="text-5xl font-extrabold leading-tight mb-6 drop-shadow-2xl">
                Báº£o Vá»‡ <br />
                <span className="text-transparent bg-clip-text bg-gradient-to-r from-amber-300 to-yellow-600">
                  ChuyÃªn Nghiá»‡p
                </span>
              </h1>
              <div className="backdrop-blur-md bg-black/40 p-6 rounded-2xl border border-white/10 max-w-lg shadow-2xl">
                <p className="text-gray-200 text-lg leading-relaxed font-light">
                  Äá»™i ngÅ© <strong className="text-white font-bold">Ä‘áº·c nhiá»‡m an ninh</strong> tinh nhuá»‡.
                </p>
              </div>
            </div>

            <div className="flex items-center gap-4 text-xs text-gray-500 font-medium tracking-wide">
              <p>Â© 2025 Bach Ho Security. All rights reserved.</p>
            </div>
          </div>
        </div>

        {/* Right Column: Login Form */}
        <div className="w-full lg:w-1/2 flex items-center justify-center bg-white relative overflow-hidden">
          <style>
            {`
            @keyframes blob {
              0% { transform: translate(0px, 0px) scale(1); }
              33% { transform: translate(30px, -50px) scale(1.1); }
              66% { transform: translate(-20px, 20px) scale(0.9); }
              100% { transform: translate(0px, 0px) scale(1); }
            }
            .animate-blob { animation: blob 7s infinite; }
            .animation-delay-2000 { animation-delay: 2s; }
            `}
          </style>

          <div className="absolute top-0 right-0 w-80 h-80 bg-amber-200 rounded-full mix-blend-multiply filter blur-3xl opacity-40 animate-blob"></div>
          <div className="absolute bottom-0 left-0 w-80 h-80 bg-blue-200 rounded-full mix-blend-multiply filter blur-3xl opacity-40 animate-blob animation-delay-2000"></div>

          <div className="w-full max-w-md p-8 relative z-20">
            <div className="text-center mb-8">
              <div className="mb-6 inline-block transform hover:scale-105 transition-transform duration-500">
                <div className="relative">
                  <div className="absolute inset-0 bg-amber-400 rounded-full blur opacity-40"></div>
                  <img src={logoUrl} alt="Logo" className="w-28 h-28 object-cover rounded-full relative z-10 border-4 border-white shadow-lg" />
                </div>
              </div>
              <h2 className="text-3xl font-extrabold text-gray-900 uppercase tracking-tight">Cá»•ng ThÃ´ng Tin</h2>
              <p className="text-sm font-semibold text-amber-600 mt-2 uppercase tracking-wide">Há»‡ Thá»‘ng Quáº£n LÃ½ Cháº¥m CÃ´ng</p>
            </div>

            <form onSubmit={handleSubmit} className="space-y-6">
              {error && (
                <div className="bg-red-50 border border-red-200 text-red-600 text-sm p-3 rounded-lg text-center animate-pulse">
                  {error}
                </div>
              )}

              <div>
                <label className="block text-sm font-bold text-gray-700 mb-2">MÃ£ nhÃ¢n viÃªn</label>
                <input
                  type="text"
                  required
                  value={code}
                  onChange={(e) => setCode(e.target.value)}
                  className="block w-full px-4 py-3.5 border border-gray-200 rounded-xl bg-gray-50 focus:outline-none focus:ring-2 focus:ring-amber-500"
                  placeholder="Nháº­p mÃ£ sá»‘ (VD: 314)..."
                />
              </div>

              <div>
                <label className="block text-sm font-bold text-gray-700 mb-2">Máº­t kháº©u</label>
                <div className="relative">
                  <input
                    type={showPassword ? "text" : "password"}
                    required
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    className="block w-full px-4 py-3.5 border border-gray-200 rounded-xl bg-gray-50 focus:outline-none focus:ring-2 focus:ring-amber-500"
                    placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                  />
                  <button
                    type="button"
                    onClick={() => setShowPassword(!showPassword)}
                    className="absolute inset-y-0 right-0 pr-4 flex items-center text-gray-400 hover:text-amber-600"
                  >
                    {showPassword ? 'ğŸ™ˆ' : 'ğŸ‘'}
                  </button>
                </div>
              </div>

              <button
                type="submit"
                disabled={isLoading}
                className={`w-full py-4 px-4 rounded-xl text-sm font-extrabold text-white uppercase tracking-wider transition-all
                  ${isLoading ? 'bg-gray-400 cursor-not-allowed' : 'bg-gradient-to-r from-gray-800 to-black hover:from-gray-700'}`}
              >
                {isLoading ? 'Äang xÃ¡c thá»±c...' : 'ÄÄ‚NG NHáº¬P'}
              </button>
            </form>

            <div className="mt-8 p-5 bg-gray-50 border border-gray-100 rounded-xl">
              <h3 className="text-xs font-bold text-gray-500 uppercase text-center mb-3">ThÃ´ng tin Demo</h3>
              <div className="flex gap-4">
                <div className="flex-1 bg-white p-3 rounded border text-center">
                  <div className="text-xs text-gray-400 mb-1">MÃ£ NV</div>
                  <div className="font-mono font-bold text-gray-800 text-lg">314</div>
                </div>
                <div className="flex-1 bg-white p-3 rounded border text-center">
                  <div className="text-xs text-gray-400 mb-1">Máº­t kháº©u</div>
                  <div className="font-mono font-bold text-gray-800 text-lg">123</div>
                </div>
              </div>
            </div>

            <div className="mt-8 text-center">
              <p className="text-xs text-gray-400">PhiÃªn báº£n 1.3.0</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default Login;
</file>

<file path="src/components/employees/index.ts">
/**
 * Employees components barrel export
 * Re-export from parent directory for backward compatibility
 */

export { HRManagement } from '../HRManagement'
</file>

<file path="src/components/hr/add-employee-row.tsx">
/**
 * Add Employee Row Component
 * Table row for adding new employee
 */

import React from 'react';
import { Key, Save, X } from 'lucide-react';
import type { Employee } from '../../types';

interface AddEmployeeRowProps {
  form: Partial<Employee>;
  onFormChange: (form: Partial<Employee>) => void;
  onSave: () => void;
  onCancel: () => void;
}

export const AddEmployeeRow: React.FC<AddEmployeeRowProps> = ({
  form,
  onFormChange,
  onSave,
  onCancel
}) => {
  return (
    <tr className="bg-green-50 border-2 border-green-300">
      <td className="px-6 py-4 whitespace-nowrap">
        <input
          type="text"
          placeholder="MÃ£ NV"
          className="border rounded px-2 py-1 w-full text-sm font-medium"
          value={form.code || ''}
          onChange={(e) => onFormChange({ ...form, code: e.target.value })}
        />
      </td>
      <td className="px-6 py-4 whitespace-nowrap">
        <input
          type="text"
          placeholder="Há» TÃªn"
          className="border rounded px-2 py-1 w-full text-sm"
          value={form.name || ''}
          onChange={(e) => onFormChange({ ...form, name: e.target.value })}
        />
      </td>
      <td className="px-6 py-4 whitespace-nowrap">
        <input
          type="text"
          placeholder="PhÃ²ng Ban"
          className="border rounded px-2 py-1 w-full text-sm"
          value={form.department || ''}
          onChange={(e) => onFormChange({ ...form, department: e.target.value })}
        />
      </td>
      <td className="px-6 py-4 whitespace-nowrap">
        <select
          className="border rounded px-2 py-1 text-sm"
          value={form.role || 'staff'}
          onChange={(e) => onFormChange({ ...form, role: e.target.value as 'admin' | 'staff' })}
        >
          <option value="staff">NhÃ¢n viÃªn</option>
          <option value="admin">Quáº£n trá»‹ viÃªn</option>
        </select>
      </td>
      <td className="px-6 py-4 whitespace-nowrap">
        <div className="flex items-center">
          <Key size={14} className="mr-1 text-gray-400" />
          <input
            type="text"
            placeholder="Máº­t kháº©u"
            className="border rounded px-2 py-1 w-24 text-sm font-mono"
            value={form.password || ''}
            onChange={(e) => onFormChange({ ...form, password: e.target.value })}
          />
        </div>
      </td>
      <td className="px-6 py-4 whitespace-nowrap text-right">
        <input
          type="number"
          placeholder="200000"
          className="border rounded px-2 py-1 w-24 text-sm text-right"
          value={form.dailyRate || ''}
          onChange={(e) => onFormChange({ ...form, dailyRate: parseInt(e.target.value) || 0 })}
        />
      </td>
      <td className="px-6 py-4 whitespace-nowrap text-right">
        <input
          type="number"
          placeholder="0"
          className="border rounded px-2 py-1 w-20 text-sm text-right"
          value={form.bonus || ''}
          onChange={(e) => onFormChange({ ...form, bonus: parseInt(e.target.value) || 0 })}
        />
      </td>
      <td className="px-6 py-4 whitespace-nowrap text-right">
        <input
          type="number"
          placeholder="0"
          className="border rounded px-2 py-1 w-20 text-sm text-right"
          value={form.penalty || ''}
          onChange={(e) => onFormChange({ ...form, penalty: parseInt(e.target.value) || 0 })}
        />
      </td>
      <td className="px-6 py-4 whitespace-nowrap text-right">
        <div className="flex justify-end space-x-2">
          <button onClick={onSave} className="text-green-600 hover:text-green-900" title="LÆ°u">
            <Save size={18} />
          </button>
          <button onClick={onCancel} className="text-gray-500 hover:text-gray-700" title="Há»§y">
            <X size={18} />
          </button>
        </div>
      </td>
    </tr>
  );
};
</file>

<file path="src/components/hr/employee-detail-modal.tsx">
/**
 * Employee Detail Modal Component
 * Shows detailed employee info, attendance grid, and payroll
 */

import React, { useState } from 'react';
import { User, X, Calendar, DollarSign, Edit } from 'lucide-react';
import type { Employee } from '../../types';
import { DAYS_OF_WEEK_EN } from '../../constants';
import { calculateEmployeeStats, calculatePayroll, getAttendanceCellColor } from './hr-helpers';

interface EmployeeDetailModalProps {
  employee: Employee;
  gridData: Employee[];
  year: number;
  month: number;
  isAdmin: boolean;
  onClose: () => void;
  onEdit: () => void;
}

export const EmployeeDetailModal: React.FC<EmployeeDetailModalProps> = ({
  employee,
  gridData,
  year,
  month,
  isAdmin,
  onClose,
  onEdit
}) => {
  const [viewMonth, setViewMonth] = useState(month);
  const [viewYear, setViewYear] = useState(year);

  const stats = calculateEmployeeStats(employee, gridData, viewMonth, viewYear);
  const payroll = calculatePayroll(employee, stats);

  const monthNames = ['ThÃ¡ng 1', 'ThÃ¡ng 2', 'ThÃ¡ng 3', 'ThÃ¡ng 4', 'ThÃ¡ng 5', 'ThÃ¡ng 6',
    'ThÃ¡ng 7', 'ThÃ¡ng 8', 'ThÃ¡ng 9', 'ThÃ¡ng 10', 'ThÃ¡ng 11', 'ThÃ¡ng 12'];

  // Generate attendance grid
  const gridEmployee = gridData.find(e => e.code === employee.code);
  const attendance = gridEmployee?.attendance || {};
  const daysInMonth = new Date(viewYear, viewMonth + 1, 0).getDate();
  const days = [];
  for (let i = 1; i <= daysInMonth; i++) {
    const date = new Date(viewYear, viewMonth, i);
    const dayIndex = date.getDay();
    days.push({
      date: i,
      dayOfWeek: DAYS_OF_WEEK_EN[dayIndex],
      isWeekend: dayIndex === 0 || dayIndex === 6
    });
  }

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        {/* Header */}
        <div className="flex justify-between items-center mb-6">
          <h2 className="text-2xl font-bold text-gray-800 flex items-center">
            <User size={24} className="mr-2 text-blue-600" />
            ThÃ´ng Tin Chi Tiáº¿t NhÃ¢n ViÃªn
          </h2>
          <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
            <X size={24} />
          </button>
        </div>

        {/* Employee Basic Info */}
        <div className="bg-gray-50 rounded-lg p-4 mb-6">
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="text-xs text-gray-500 uppercase">MÃ£ NhÃ¢n ViÃªn</label>
              <div className="text-lg font-bold text-gray-800">{employee.code}</div>
            </div>
            <div>
              <label className="text-xs text-gray-500 uppercase">Há» TÃªn</label>
              <div className="text-lg font-semibold text-gray-800">{employee.name}</div>
            </div>
            <div>
              <label className="text-xs text-gray-500 uppercase">PhÃ²ng Ban</label>
              <div className="text-sm text-gray-700">{employee.department}</div>
            </div>
            <div>
              <label className="text-xs text-gray-500 uppercase">Quyá»n Háº¡n</label>
              <div>
                <span className={`px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${employee.role === 'admin' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}`}>
                  {employee.role === 'admin' ? 'Quáº£n Trá»‹' : 'NhÃ¢n ViÃªn'}
                </span>
              </div>
            </div>
          </div>
        </div>

        {/* Attendance Statistics */}
        <div className="mb-6">
          <div className="flex justify-between items-center mb-4">
            <h3 className="text-lg font-bold text-gray-800 flex items-center">
              <Calendar size={20} className="mr-2 text-purple-600" />
              Thá»‘ng KÃª Cháº¥m CÃ´ng
            </h3>
            <div className="flex items-center space-x-2">
              <select
                value={viewMonth}
                onChange={(e) => setViewMonth(parseInt(e.target.value))}
                className="border rounded px-3 py-1.5 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none"
              >
                {Array.from({ length: 12 }).map((_, i) => (
                  <option key={i} value={i}>{monthNames[i]}</option>
                ))}
              </select>
              <input
                type="number"
                value={viewYear}
                onChange={(e) => setViewYear(parseInt(e.target.value) || viewYear)}
                className="border rounded px-3 py-1.5 w-24 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none"
                min="2020"
                max="2100"
              />
            </div>
          </div>

          <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
            <div className="bg-green-50 border border-green-200 rounded-lg p-4">
              <div className="text-xs text-green-600 uppercase font-semibold mb-1">Tá»•ng CÃ´ng</div>
              <div className="text-2xl font-bold text-green-700">{stats.totalWork}</div>
              <div className="text-xs text-green-600 mt-1">cÃ´ng</div>
            </div>
            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
              <div className="text-xs text-blue-600 uppercase font-semibold mb-1">NgÃ y Äi LÃ m</div>
              <div className="text-2xl font-bold text-blue-700">{stats.totalDays}</div>
              <div className="text-xs text-blue-600 mt-1">ngÃ y</div>
            </div>
            <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
              <div className="text-xs text-yellow-600 uppercase font-semibold mb-1">Ná»­a NgÃ y</div>
              <div className="text-2xl font-bold text-yellow-700">{stats.halfDays}</div>
              <div className="text-xs text-yellow-600 mt-1">ngÃ y</div>
            </div>
            <div className="bg-orange-50 border border-orange-200 rounded-lg p-4">
              <div className="text-xs text-orange-600 uppercase font-semibold mb-1">Nghá»‰ PhÃ©p</div>
              <div className="text-2xl font-bold text-orange-700">{stats.leaveDays}</div>
              <div className="text-xs text-orange-600 mt-1">ngÃ y</div>
            </div>
            <div className="bg-purple-50 border border-purple-200 rounded-lg p-4">
              <div className="text-xs text-purple-600 uppercase font-semibold mb-1">Cuá»‘i Tuáº§n</div>
              <div className="text-2xl font-bold text-purple-700">{stats.weekendDays}</div>
              <div className="text-xs text-purple-600 mt-1">ngÃ y</div>
            </div>
            <div className="bg-gray-50 border border-gray-200 rounded-lg p-4">
              <div className="text-xs text-gray-600 uppercase font-semibold mb-1">ChÆ°a Cháº¥m</div>
              <div className="text-2xl font-bold text-gray-700">{stats.emptyDays}</div>
              <div className="text-xs text-gray-600 mt-1">ngÃ y</div>
            </div>
          </div>
        </div>

        {/* Attendance Grid */}
        <div className="mb-6">
          <h3 className="text-lg font-bold text-gray-800 mb-4">Báº£ng Cháº¥m CÃ´ng Chi Tiáº¿t</h3>
          <div className="overflow-x-auto border rounded-lg">
            <table className="min-w-full text-sm">
              <thead className="bg-gray-100">
                <tr>
                  <th className="px-2 py-2 border text-center font-semibold text-gray-700">NgÃ y</th>
                  {days.map((day) => (
                    <th
                      key={day.date}
                      className={`px-2 py-2 border text-center text-xs font-semibold ${day.isWeekend ? 'bg-yellow-100' : 'bg-gray-50'
                        }`}
                    >
                      <div>{day.date}</div>
                      <div className="text-xs text-gray-500">{day.dayOfWeek}</div>
                    </th>
                  ))}
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td className="px-2 py-2 border bg-gray-50 font-semibold text-center">Cháº¥m CÃ´ng</td>
                  {days.map((day) => {
                    const val = attendance[day.date] || '';
                    return (
                      <td
                        key={day.date}
                        className={`px-2 py-2 border text-center font-bold ${getAttendanceCellColor(val, day.isWeekend)}`}
                      >
                        {val || '-'}
                      </td>
                    );
                  })}
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        {/* Payroll Summary */}
        <div className="mb-6">
          <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
            <DollarSign size={20} className="mr-2 text-amber-600" />
            TÃ­nh LÆ°Æ¡ng ThÃ¡ng {viewMonth + 1}/{viewYear}
          </h3>
          <div className="bg-amber-50 border border-amber-200 rounded-lg p-4">
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
              <div className="text-center">
                <div className="text-xs text-gray-600 uppercase font-semibold mb-1">ÄÆ¡n GiÃ¡/CÃ´ng</div>
                <div className="text-lg font-bold text-gray-800">{payroll.dailyRate.toLocaleString('vi-VN')}</div>
                <div className="text-xs text-gray-500">VNÄ</div>
              </div>
              <div className="text-center">
                <div className="text-xs text-gray-600 uppercase font-semibold mb-1">Tá»•ng CÃ´ng</div>
                <div className="text-lg font-bold text-blue-700">{stats.totalWork}</div>
                <div className="text-xs text-gray-500">cÃ´ng</div>
              </div>
              <div className="text-center">
                <div className="text-xs text-green-600 uppercase font-semibold mb-1">ThÆ°á»Ÿng</div>
                <div className="text-lg font-bold text-green-700">+{payroll.bonus.toLocaleString('vi-VN')}</div>
                <div className="text-xs text-gray-500">VNÄ</div>
              </div>
              <div className="text-center">
                <div className="text-xs text-red-600 uppercase font-semibold mb-1">Pháº¡t</div>
                <div className="text-lg font-bold text-red-700">-{payroll.penalty.toLocaleString('vi-VN')}</div>
                <div className="text-xs text-gray-500">VNÄ</div>
              </div>
            </div>

            <div className="border-t border-amber-300 pt-4">
              <div className="flex flex-col md:flex-row justify-between items-center gap-2">
                <div className="text-sm text-gray-600">
                  <span className="font-semibold">{stats.totalWork}</span> cÃ´ng Ã— <span className="font-semibold">{payroll.dailyRate.toLocaleString('vi-VN')}</span> + <span className="text-green-600 font-semibold">{payroll.bonus.toLocaleString('vi-VN')}</span> - <span className="text-red-600 font-semibold">{payroll.penalty.toLocaleString('vi-VN')}</span>
                </div>
                <div className="flex items-center gap-2">
                  <span className="text-gray-600 font-semibold">=</span>
                  <div className="bg-amber-600 text-white px-4 py-2 rounded-lg">
                    <div className="text-xs opacity-80">THá»°C LÃƒNH</div>
                    <div className="text-xl font-bold">{payroll.totalSalary.toLocaleString('vi-VN')} VNÄ</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* Action Buttons */}
        <div className="flex justify-end space-x-3 pt-4 border-t">
          {isAdmin && (
            <button
              onClick={onEdit}
              className="px-4 py-2 bg-amber-600 text-white rounded hover:bg-amber-700 flex items-center"
            >
              <Edit size={16} className="mr-2" />
              Sá»­a ThÃ´ng Tin
            </button>
          )}
          <button
            onClick={onClose}
            className="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700"
          >
            ÄÃ³ng
          </button>
        </div>
      </div>
    </div>
  );
};
</file>

<file path="src/components/hr/employee-table-row.tsx">
/**
 * Employee Table Row Component
 * Single row in employee table with view/edit/delete actions
 */

import React from 'react';
import { Key, Save, X, Eye, Edit, Trash2 } from 'lucide-react';
import type { Employee } from '../../types';

interface EmployeeTableRowProps {
  emp: Employee;
  isEditing: boolean;
  editForm: Partial<Employee>;
  isAdmin: boolean;
  onEditFormChange: (form: Partial<Employee>) => void;
  onStartEdit: () => void;
  onSaveEdit: () => void;
  onCancelEdit: () => void;
  onView: () => void;
  onDelete: () => void;
}

export const EmployeeTableRow: React.FC<EmployeeTableRowProps> = ({
  emp,
  isEditing,
  editForm,
  isAdmin,
  onEditFormChange,
  onStartEdit,
  onSaveEdit,
  onCancelEdit,
  onView,
  onDelete
}) => {
  return (
    <tr className="hover:bg-amber-50 transition-colors">
      <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
        {isEditing ? (
          <input
            className="border rounded px-2 py-1 w-24 font-medium"
            value={editForm.code || ''}
            onChange={e => onEditFormChange({ ...editForm, code: e.target.value })}
            placeholder="MÃ£ NV"
          />
        ) : emp.code}
      </td>
      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
        {isEditing ? (
          <input
            className="border rounded px-2 py-1 w-full"
            value={editForm.name || ''}
            onChange={e => onEditFormChange({ ...editForm, name: e.target.value })}
          />
        ) : (
          <div className="flex items-center">
            <div className="h-8 w-8 rounded-full bg-amber-100 flex items-center justify-center text-amber-700 mr-3 font-bold">
              {(emp.name || '?').charAt(0)}
            </div>
            {emp.name || 'N/A'}
          </div>
        )}
      </td>
      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
        {isEditing ? (
          <input
            className="border rounded px-2 py-1 w-full"
            value={editForm.department || ''}
            onChange={e => onEditFormChange({ ...editForm, department: e.target.value })}
          />
        ) : emp.department}
      </td>
      <td className="px-6 py-4 whitespace-nowrap text-sm">
        {isEditing ? (
          <select
            className="border rounded px-2 py-1"
            value={editForm.role || 'staff'}
            onChange={e => onEditFormChange({ ...editForm, role: e.target.value as 'admin' | 'staff' })}
          >
            <option value="staff">NhÃ¢n viÃªn</option>
            <option value="admin">Quáº£n trá»‹ viÃªn</option>
          </select>
        ) : (
          <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${emp.role === 'admin' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}`}>
            {emp.role === 'admin' ? 'Quáº£n Trá»‹' : 'NhÃ¢n ViÃªn'}
          </span>
        )}
      </td>
      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">
        {isEditing ? (
          <div className="flex items-center">
            <Key size={14} className="mr-1 text-gray-400" />
            <input
              className="border rounded px-2 py-1 w-24"
              type="text"
              value={editForm.password || ''}
              onChange={e => onEditFormChange({ ...editForm, password: e.target.value })}
            />
          </div>
        ) : 'â€¢â€¢â€¢â€¢â€¢â€¢'}
      </td>
      <td className="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-700">
        {isEditing ? (
          <input
            className="border rounded px-2 py-1 w-24 text-right"
            type="number"
            value={editForm.dailyRate || ''}
            onChange={e => onEditFormChange({ ...editForm, dailyRate: parseInt(e.target.value) || 0 })}
            placeholder="200000"
          />
        ) : (emp.dailyRate ? emp.dailyRate.toLocaleString('vi-VN') : '200,000')}
      </td>
      <td className="px-6 py-4 whitespace-nowrap text-sm text-right text-green-600 font-medium">
        {isEditing ? (
          <input
            className="border rounded px-2 py-1 w-20 text-right"
            type="number"
            value={editForm.bonus || ''}
            onChange={e => onEditFormChange({ ...editForm, bonus: parseInt(e.target.value) || 0 })}
            placeholder="0"
          />
        ) : (emp.bonus ? `+${emp.bonus.toLocaleString('vi-VN')}` : '-')}
      </td>
      <td className="px-6 py-4 whitespace-nowrap text-sm text-right text-red-600 font-medium">
        {isEditing ? (
          <input
            className="border rounded px-2 py-1 w-20 text-right"
            type="number"
            value={editForm.penalty || ''}
            onChange={e => onEditFormChange({ ...editForm, penalty: parseInt(e.target.value) || 0 })}
            placeholder="0"
          />
        ) : (emp.penalty ? `-${emp.penalty.toLocaleString('vi-VN')}` : '-')}
      </td>
      <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
        {isEditing ? (
          <div className="flex justify-end space-x-2">
            <button onClick={onSaveEdit} className="text-green-600 hover:text-green-900" title="LÆ°u">
              <Save size={18} />
            </button>
            <button onClick={onCancelEdit} className="text-gray-500 hover:text-gray-700" title="Há»§y">
              <X size={18} />
            </button>
          </div>
        ) : (
          <div className="flex justify-end space-x-2">
            <button
              onClick={onView}
              className="text-blue-600 hover:text-blue-900 p-1 rounded hover:bg-blue-50"
              title="Xem chi tiáº¿t"
            >
              <Eye size={18} />
            </button>
            {isAdmin && (
              <>
                <button
                  onClick={onStartEdit}
                  className="text-amber-600 hover:text-amber-900 p-1 rounded hover:bg-amber-50"
                  title="Sá»­a"
                >
                  <Edit size={18} />
                </button>
                <button
                  onClick={onDelete}
                  className="text-red-600 hover:text-red-900 p-1 rounded hover:bg-red-50"
                  title="XÃ³a"
                >
                  <Trash2 size={18} />
                </button>
              </>
            )}
          </div>
        )}
      </td>
    </tr>
  );
};
</file>

<file path="src/components/hr/hr-helpers.ts">
/**
 * HR Helper Functions
 * Utilities for employee statistics and calculations
 */

import type { Employee } from '../../types';

export interface EmployeeStats {
  totalDays: number;
  totalWork: number;
  halfDays: number;
  leaveDays: number;
  weekendDays: number;
  emptyDays: number;
}

/**
 * Calculate attendance statistics for an employee
 */
export const calculateEmployeeStats = (
  emp: Employee,
  gridData: Employee[],
  month: number,
  year: number
): EmployeeStats => {
  // Find employee in gridData by code
  const gridEmployee = gridData.find(e => e.code === emp.code);
  if (!gridEmployee || !gridEmployee.attendance) {
    return {
      totalDays: 0,
      totalWork: 0,
      halfDays: 0,
      leaveDays: 0,
      weekendDays: 0,
      emptyDays: 0
    };
  }

  const attendance = gridEmployee.attendance;
  const daysInMonth = new Date(year, month + 1, 0).getDate();

  let totalWork = 0;
  let halfDays = 0;
  let leaveDays = 0;
  let weekendDays = 0;
  let emptyDays = 0;
  let totalDays = 0;

  for (let day = 1; day <= daysInMonth; day++) {
    const date = new Date(year, month, day);
    const isWeekend = date.getDay() === 0 || date.getDay() === 6;
    const value = attendance[day] || '';

    if (value === 'CN' || value === 'Red') {
      weekendDays++;
    } else if (value === 'P') {
      leaveDays++;
    } else if (value === '0.5') {
      halfDays++;
      totalWork += 0.5;
    } else if (value === '1') {
      totalWork += 1;
      totalDays++;
    } else if (value === '') {
      if (isWeekend) {
        weekendDays++;
      } else {
        emptyDays++;
      }
    } else {
      // Try to parse as number
      const num = parseFloat(value);
      if (!isNaN(num)) {
        totalWork += num;
        if (num === 1) totalDays++;
        else if (num === 0.5) halfDays++;
      }
    }
  }

  return {
    totalDays,
    totalWork: Math.round(totalWork * 100) / 100,
    halfDays,
    leaveDays,
    weekendDays,
    emptyDays
  };
};

/**
 * Calculate payroll for an employee
 */
export const calculatePayroll = (
  emp: Employee,
  stats: EmployeeStats
) => {
  const dailyRate = emp.dailyRate || 200000;
  const bonus = emp.bonus || 0;
  const penalty = emp.penalty || 0;
  const baseSalary = stats.totalWork * dailyRate;
  const totalSalary = baseSalary + bonus - penalty;

  return {
    dailyRate,
    bonus,
    penalty,
    baseSalary,
    totalSalary
  };
};

/**
 * Get cell color for attendance value
 */
export const getAttendanceCellColor = (val: string, isWeekend: boolean): string => {
  if (val === 'CN' || val === 'Red') return 'bg-red-600 text-white font-bold';
  if (val === '0.5') return 'bg-blue-100 text-blue-800';
  if (val === '1') return isWeekend ? 'bg-yellow-200' : 'bg-green-100';
  if (val === 'P') return 'bg-orange-200';
  if (!val && isWeekend) return 'bg-yellow-50';
  return 'bg-white';
};
</file>

<file path="src/components/hr/hr-management.tsx">
/**
 * HR Management Component (Modular Version)
 * Main component for human resources management
 */

import React, { useState, useMemo } from 'react';
import { Shield, ShieldAlert } from 'lucide-react';
import type { Employee } from '../../types';
import { HRToolbar } from './hr-toolbar';
import { AddEmployeeRow } from './add-employee-row';
import { EmployeeTableRow } from './employee-table-row';
import { EmployeeDetailModal } from './employee-detail-modal';

interface HRManagementProps {
  employees: Employee[];
  gridData: Employee[];
  year: number;
  month: number;
  currentUser: Employee | null;
  onUpdateEmployee: (updatedEmp: Employee) => void;
  onDeleteEmployee: (empId: string) => void;
  onAddEmployee: (newEmp: Employee) => void;
}

const defaultNewEmployee: Partial<Employee> = {
  code: '',
  name: '',
  department: 'VÄƒn PhÃ²ng',
  password: '123',
  role: 'staff',
  dailyRate: 200000,
  bonus: 0,
  penalty: 0
};

export const HRManagement: React.FC<HRManagementProps> = ({
  employees,
  gridData,
  year,
  month,
  currentUser,
  onUpdateEmployee,
  onDeleteEmployee,
  onAddEmployee
}) => {
  const [searchTerm, setSearchTerm] = useState('');
  const [editingId, setEditingId] = useState<string | null>(null);
  const [editForm, setEditForm] = useState<Partial<Employee>>({});
  const [viewingEmployee, setViewingEmployee] = useState<Employee | null>(null);
  const [isAdding, setIsAdding] = useState(false);
  const [newEmployeeForm, setNewEmployeeForm] = useState<Partial<Employee>>(defaultNewEmployee);
  const [importError, setImportError] = useState<string | null>(null);

  const isAdmin = currentUser?.role === 'admin';

  // Filter employees based on permissions
  const filteredEmployees = useMemo(() => {
    const term = searchTerm.toLowerCase();
    let filtered = employees.filter(emp =>
      (emp.name || '').toLowerCase().includes(term) ||
      (emp.code || '').toLowerCase().includes(term)
    );

    // If user is staff, only show themselves
    if (currentUser?.role === 'staff') {
      filtered = filtered.filter(emp => emp.id === currentUser.id);
    }

    return filtered;
  }, [employees, searchTerm, currentUser]);

  // Edit handlers
  const startEdit = (emp: Employee) => {
    setEditingId(emp.id);
    setEditForm({ ...emp });
    setViewingEmployee(null);
  };

  const cancelEdit = () => {
    setEditingId(null);
    setEditForm({});
  };

  const saveEdit = () => {
    if (editingId && editForm) {
      const original = employees.find(e => e.id === editingId);
      if (original) {
        onUpdateEmployee({ ...original, ...editForm } as Employee);
      }
      setEditingId(null);
      setEditForm({});
    }
  };

  const handleDelete = (emp: Employee) => {
    if (confirm(`Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a nhÃ¢n viÃªn "${emp.name}" (${emp.code})?\n\nLÆ°u Ã½: HÃ nh Ä‘á»™ng nÃ y khÃ´ng thá»ƒ hoÃ n tÃ¡c.`)) {
      onDeleteEmployee(emp.id);
      if (editingId === emp.id) cancelEdit();
      if (viewingEmployee?.id === emp.id) setViewingEmployee(null);
    }
  };

  const handleView = (emp: Employee) => {
    setViewingEmployee(emp);
    setEditingId(null);
  };

  // Add handlers
  const handleAddNew = () => {
    setIsAdding(true);
    setNewEmployeeForm(defaultNewEmployee);
    setEditingId(null);
    setViewingEmployee(null);
  };

  const cancelAdd = () => {
    setIsAdding(false);
    setNewEmployeeForm(defaultNewEmployee);
  };

  const saveNewEmployee = () => {
    if (!newEmployeeForm.code || !newEmployeeForm.name) {
      alert('Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ MÃ£ NV vÃ  Há» TÃªn');
      return;
    }

    if (employees.some(e => e.code === newEmployeeForm.code)) {
      alert(`MÃ£ nhÃ¢n viÃªn "${newEmployeeForm.code}" Ä‘Ã£ tá»“n táº¡i. Vui lÃ²ng sá»­ dá»¥ng mÃ£ khÃ¡c.`);
      return;
    }

    const newEmployee: Employee = {
      id: Math.random().toString(36).substr(2, 9),
      code: newEmployeeForm.code || '',
      name: newEmployeeForm.name || '',
      department: newEmployeeForm.department || 'VÄƒn PhÃ²ng',
      shift: '08:00 - 17:00',
      attendance: {},
      password: newEmployeeForm.password || '123',
      role: (newEmployeeForm.role || 'staff') as 'admin' | 'staff',
      dailyRate: newEmployeeForm.dailyRate || 200000,
      bonus: newEmployeeForm.bonus || 0,
      penalty: newEmployeeForm.penalty || 0
    };

    onAddEmployee(newEmployee);
    cancelAdd();
  };

  // Import handlers
  const handleImportSuccess = (importedEmployees: Employee[]) => {
    importedEmployees.forEach(emp => onAddEmployee(emp));
    alert(`ÄÃ£ nháº­p thÃ nh cÃ´ng ${importedEmployees.length} nhÃ¢n viÃªn!`);
  };

  return (
    <>
      <div className="bg-white rounded-lg shadow-lg overflow-hidden h-full flex flex-col">
        {/* Header */}
        <div className="p-6 border-b bg-gray-50 flex justify-between items-center">
          <div>
            <h2 className="text-xl font-bold text-gray-800 flex items-center">
              <Shield className="mr-2 text-amber-600" /> Quáº£n LÃ½ NhÃ¢n Sá»± & TÃ i Khoáº£n
            </h2>
            <p className="text-sm text-gray-500 mt-1">Quáº£n lÃ½ thÃ´ng tin Ä‘Äƒng nháº­p vÃ  phÃ¢n quyá»n nhÃ¢n viÃªn</p>
          </div>

          <HRToolbar
            searchTerm={searchTerm}
            onSearchChange={setSearchTerm}
            isAdmin={isAdmin}
            employees={employees}
            onAddNew={handleAddNew}
            onImportSuccess={handleImportSuccess}
            onImportError={setImportError}
          />
        </div>

        {/* Import Error */}
        {importError && (
          <div className="mx-6 mt-2 p-3 bg-red-50 border border-red-200 rounded text-sm text-red-600">
            <strong>Lá»—i nháº­p file:</strong>
            <pre className="mt-1 text-xs whitespace-pre-wrap">{importError}</pre>
          </div>
        )}

        {/* Table */}
        <div className="flex-1 overflow-auto p-6">
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">MÃ£ NV</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Há» TÃªn</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">PhÃ²ng Ban</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quyá»n Háº¡n</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Máº­t Kháº©u</th>
                <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ÄÆ¡n GiÃ¡</th>
                <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ThÆ°á»Ÿng</th>
                <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Pháº¡t</th>
                <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Thao TÃ¡c</th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {isAdding && (
                <AddEmployeeRow
                  form={newEmployeeForm}
                  onFormChange={setNewEmployeeForm}
                  onSave={saveNewEmployee}
                  onCancel={cancelAdd}
                />
              )}
              {filteredEmployees.map((emp) => (
                <EmployeeTableRow
                  key={emp.id}
                  emp={emp}
                  isEditing={editingId === emp.id}
                  editForm={editForm}
                  isAdmin={isAdmin}
                  onEditFormChange={setEditForm}
                  onStartEdit={() => startEdit(emp)}
                  onSaveEdit={saveEdit}
                  onCancelEdit={cancelEdit}
                  onView={() => handleView(emp)}
                  onDelete={() => handleDelete(emp)}
                />
              ))}
            </tbody>
          </table>
          {filteredEmployees.length === 0 && (
            <div className="text-center py-10 text-gray-500">
              KhÃ´ng tÃ¬m tháº¥y nhÃ¢n viÃªn nÃ o.
            </div>
          )}
        </div>

        {/* Footer */}
        <div className="bg-amber-50 p-4 text-xs text-amber-800 border-t border-amber-100 flex items-start">
          <ShieldAlert size={16} className="mr-2 mt-0.5" />
          <div>
            <strong>LÆ°u Ã½ báº£o máº­t:</strong> Chá»‰ nhá»¯ng tÃ i khoáº£n cÃ³ quyá»n Quáº£n Trá»‹ (Admin) má»›i cÃ³ thá»ƒ truy cáº­p vÃ o trang nÃ y.
            Máº­t kháº©u nhÃ¢n viÃªn nÃªn Ä‘Æ°á»£c Ä‘áº·t phá»©c táº¡p Ä‘á»ƒ Ä‘áº£m báº£o an toÃ n.
          </div>
        </div>
      </div>

      {/* View Employee Modal */}
      {viewingEmployee && (
        <EmployeeDetailModal
          employee={viewingEmployee}
          gridData={gridData}
          year={year}
          month={month}
          isAdmin={isAdmin}
          onClose={() => setViewingEmployee(null)}
          onEdit={() => {
            setViewingEmployee(null);
            startEdit(viewingEmployee);
          }}
        />
      )}
    </>
  );
};
</file>

<file path="src/components/hr/hr-toolbar.tsx">
/**
 * HR Toolbar Component
 * Search and action buttons for HR management
 */

import React, { useRef } from 'react';
import { Search, Download, Upload, Plus, FileSpreadsheet } from 'lucide-react';
import type { Employee } from '../../types';
import { exportEmployeesToExcel, importEmployeesFromExcel, downloadEmployeeTemplate } from '../../utils/excel-export';

interface HRToolbarProps {
  searchTerm: string;
  onSearchChange: (term: string) => void;
  isAdmin: boolean;
  employees: Employee[];
  onAddNew: () => void;
  onImportSuccess: (employees: Employee[]) => void;
  onImportError: (error: string) => void;
}

export const HRToolbar: React.FC<HRToolbarProps> = ({
  searchTerm,
  onSearchChange,
  isAdmin,
  employees,
  onAddNew,
  onImportSuccess,
  onImportError
}) => {
  const fileInputRef = useRef<HTMLInputElement>(null);

  const handleExportExcel = () => {
    exportEmployeesToExcel(employees);
  };

  const handleImportClick = () => {
    fileInputRef.current?.click();
  };

  const handleFileImport = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    try {
      const { employees: importedEmployees, errors } = await importEmployeesFromExcel(file, employees);

      if (errors.length > 0) {
        onImportError(errors.join('\n'));
      }

      if (importedEmployees.length > 0) {
        onImportSuccess(importedEmployees);
      }
    } catch (err: any) {
      onImportError(err.message);
    }

    // Reset file input
    if (fileInputRef.current) {
      fileInputRef.current.value = '';
    }
  };

  return (
    <div className="flex items-center space-x-3">
      <div className="relative">
        <input
          type="text"
          placeholder="TÃ¬m kiáº¿m nhÃ¢n viÃªn..."
          className="pl-10 pr-4 py-2 border rounded-full focus:ring-2 focus:ring-amber-500 focus:outline-none w-64"
          value={searchTerm}
          onChange={(e) => onSearchChange(e.target.value)}
        />
        <Search className="absolute left-3 top-2.5 text-gray-400" size={18} />
      </div>

      {isAdmin && (
        <>
          <button
            onClick={handleExportExcel}
            className="flex items-center space-x-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow transition"
            title="Xuáº¥t danh sÃ¡ch nhÃ¢n sá»±"
          >
            <Download size={18} />
            <span>Xuáº¥t Excel</span>
          </button>
          <button
            onClick={downloadEmployeeTemplate}
            className="flex items-center space-x-2 bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg shadow transition"
            title="Táº£i máº«u Excel Ä‘á»ƒ nháº­p nhÃ¢n sá»±"
          >
            <FileSpreadsheet size={18} />
            <span>Táº£i Máº«u</span>
          </button>
          <button
            onClick={handleImportClick}
            className="flex items-center space-x-2 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg shadow transition"
            title="Nháº­p nhÃ¢n sá»± tá»« Excel"
          >
            <Upload size={18} />
            <span>Nháº­p Excel</span>
          </button>
          <button
            onClick={onAddNew}
            className="flex items-center space-x-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg shadow transition"
          >
            <Plus size={18} />
            <span>ThÃªm NhÃ¢n Sá»±</span>
          </button>
        </>
      )}

      <input
        ref={fileInputRef}
        type="file"
        accept=".xlsx,.xls"
        onChange={handleFileImport}
        className="hidden"
      />
    </div>
  );
};
</file>

<file path="src/components/hr/index.ts">
/**
 * HR module exports
 * Human Resources management components
 */

export { HRManagement } from './hr-management';
export { EmployeeDetailModal } from './employee-detail-modal';
export { HRToolbar } from './hr-toolbar';
export { AddEmployeeRow } from './add-employee-row';
export { EmployeeTableRow } from './employee-table-row';

// Utils
export { calculateEmployeeStats, type EmployeeStats } from './hr-helpers';
</file>

<file path="src/components/index.ts">
/**
 * Components barrel export
 * Re-exports all components for easy imports
 */

// Auth
export { Login } from './auth'

// Shared
export { SyncStatus, SyncButton, BackupButton, Settings, ImageCapture } from './shared'

// Feature components (keep original locations for large files)
export { TimesheetGrid } from './TimesheetGrid'
export { HRManagement } from './HRManagement'
export { TargetManagement } from './TargetManagement'
</file>

<file path="src/components/shared/backup-button.tsx">
/**
 * Backup button component
 * Exports all data to downloadable JSON file
 */

import React, { useState } from 'react'
import { Download, Loader2 } from 'lucide-react'
import { createAndDownloadBackup } from '../../services/backup-service'

export function BackupButton() {
  const [isExporting, setIsExporting] = useState(false)
  const [error, setError] = useState<string | null>(null)

  const handleBackup = async () => {
    setIsExporting(true)
    setError(null)

    try {
      await createAndDownloadBackup()
    } catch (err) {
      console.error('Backup failed:', err)
      setError('KhÃ´ng thá»ƒ táº¡o backup. Vui lÃ²ng thá»­ láº¡i.')
    } finally {
      setIsExporting(false)
    }
  }

  return (
    <div className="relative">
      <button
        onClick={handleBackup}
        disabled={isExporting}
        className="
          flex items-center gap-1.5 px-3 py-2
          text-sm font-medium
          bg-orange-500 text-white rounded-lg
          hover:bg-orange-600
          disabled:opacity-50 disabled:cursor-not-allowed
          transition-colors
        "
        title="Táº£i xuá»‘ng backup dá»¯ liá»‡u (JSON)"
      >
        {isExporting ? (
          <Loader2 className="w-4 h-4 animate-spin" />
        ) : (
          <Download className="w-4 h-4" />
        )}
        <span>{isExporting ? 'Äang xuáº¥t...' : 'Backup'}</span>
      </button>

      {error && (
        <div className="absolute top-full left-0 mt-1 p-2 bg-red-50 border border-red-200 rounded text-xs text-red-600 whitespace-nowrap z-10">
          {error}
        </div>
      )}
    </div>
  )
}

export default BackupButton
</file>

<file path="src/components/shared/image-capture.tsx">
/**
 * Image capture component with OCR
 * Captures photos and extracts attendance data using AI
 */

import React, { useState, useRef } from 'react';
import { Camera, Upload, X, Loader2, CheckCircle } from 'lucide-react';
import { Employee } from '../../types';

// API Key hardcoded
const API_KEY = 'AIzaSyBQhDWtE1dZDBzMILrY3hVUSnfCjhmLTwA';

interface ImageCaptureProps {
  isOpen: boolean;
  onClose: () => void;
  onDataExtracted: (data: Employee[]) => void;
  existingEmployees: Employee[];
}

export const ImageCapture: React.FC<ImageCaptureProps> = ({
  isOpen,
  onClose,
  onDataExtracted,
  existingEmployees
}) => {
  const [imageSrc, setImageSrc] = useState<string | null>(null);
  const [isProcessing, setIsProcessing] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [successMessage, setSuccessMessage] = useState<string | null>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);
  const videoRef = useRef<HTMLVideoElement>(null);
  const streamRef = useRef<MediaStream | null>(null);
  const [isCapturing, setIsCapturing] = useState(false);

  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        setImageSrc(e.target?.result as string);
        setError(null);
        setSuccessMessage(null);
      };
      reader.readAsDataURL(file);
    }
  };

  const startCamera = async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: 'environment',
          width: { ideal: 1920 },
          height: { ideal: 1080 }
        }
      });
      streamRef.current = stream;
      if (videoRef.current) {
        videoRef.current.srcObject = stream;
        setIsCapturing(true);
      }
    } catch (err) {
      setError('KhÃ´ng thá»ƒ truy cáº­p camera. Vui lÃ²ng cho phÃ©p quyá»n truy cáº­p camera.');
    }
  };

  const stopCamera = () => {
    if (streamRef.current) {
      streamRef.current.getTracks().forEach(track => track.stop());
      streamRef.current = null;
    }
    setIsCapturing(false);
  };

  const capturePhoto = () => {
    if (videoRef.current) {
      const canvas = document.createElement('canvas');
      canvas.width = videoRef.current.videoWidth;
      canvas.height = videoRef.current.videoHeight;
      const ctx = canvas.getContext('2d');
      if (ctx) {
        ctx.drawImage(videoRef.current, 0, 0);
        const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
        setImageSrc(dataUrl);
        stopCamera();
        setError(null);
        setSuccessMessage(null);
      }
    }
  };

  const callGeminiVision = async (base64Image: string, mimeType: string): Promise<string> => {
    const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent";
    const url = `${API_URL}?key=${API_KEY}`;

    const prompt = `Báº¡n hÃ£y Ä‘á»c kÄ© vÃ  lÃ m theo 100% yÃªu cáº§u sau:

Báº¡n lÃ  má»™t chuyÃªn gia OCR vÃ  phÃ¢n tÃ­ch dá»¯ liá»‡u báº£ng cháº¥m cÃ´ng.
HÃ£y phÃ¢n tÃ­ch hÃ¬nh áº£nh báº£ng cháº¥m cÃ´ng nÃ y vÃ  trÃ­ch xuáº¥t dá»¯ liá»‡u.

HÃ£y Ä‘á»c ká»¹ tá»«ng dÃ²ng trong báº£ng vÃ  trÃ­ch xuáº¥t thÃ´ng tin nhÃ¢n viÃªn.

Tráº£ vá» JSON vá»›i cáº¥u trÃºc sau (máº£ng cÃ¡c nhÃ¢n viÃªn):
[
  {
    "code": "mÃ£ nhÃ¢n viÃªn (náº¿u cÃ³, khÃ´ng thÃ¬ Ä‘á»ƒ trá»‘ng)",
    "name": "tÃªn nhÃ¢n viÃªn",
    "department": "phÃ²ng ban (náº¿u cÃ³, khÃ´ng thÃ¬ Ä‘á»ƒ 'ChÆ°a xÃ¡c Ä‘á»‹nh')",
    "attendance": {
      "1": "giÃ¡ trá»‹ ngÃ y 1",
      "2": "giÃ¡ trá»‹ ngÃ y 2",
      ... (cÃ¡c ngÃ y khÃ¡c theo thá»© tá»±)
    }
  }
]

Quy táº¯c Ä‘á»c giÃ¡ trá»‹ cháº¥m cÃ´ng:
- âœ“ hoáº·c X hoáº·c cÃ³ kÃ½ hiá»‡u = "1" (Ä‘i lÃ m)
- Trá»‘ng hoáº·c - = "" (khÃ´ng cÃ³ dá»¯ liá»‡u)
- 0.5 = "0.5" (ná»­a ngÃ y)
- P = "P" (phÃ©p)
- CN hoáº·c cuá»‘i tuáº§n = "CN"
- Sá»‘ nÃ o thÃ¬ giá»¯ nguyÃªn sá»‘ Ä‘Ã³

CHá»ˆ TRáº¢ Vá»€ JSON THUáº¦N TÃšY, KHÃ”NG CÃ“ MARKDOWN HAY TEXT KHÃC.`;

    const requestBody = {
      contents: [
        {
          parts: [
            { text: prompt },
            {
              inlineData: {
                mimeType: mimeType,
                data: base64Image
              }
            }
          ]
        }
      ]
    };

    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(requestBody)
    });

    if (!response.ok) {
      let errorData;
      try {
        errorData = await response.json();
      } catch {
        throw new Error(`Lá»—i HTTP ${response.status}: ${response.statusText}`);
      }

      const errorCode = errorData?.error?.code || response.status;
      const errorMessage = errorData?.error?.message || 'Lá»—i khi xá»­ lÃ½ áº£nh';

      if (errorCode === 400 || errorMessage.toLowerCase().includes('api key not valid')) {
        throw new Error("âš ï¸ API KEY KHÃ”NG Há»¢P Lá»†! Vui lÃ²ng liÃªn há»‡ admin.");
      }

      if (errorCode === 429 || errorMessage.toLowerCase().includes('quota')) {
        throw new Error("âš ï¸ ÄÃƒ VÆ¯á»¢T QUÃ GIá»šI Háº N Sá»¬ Dá»¤NG API!\n\nVui lÃ²ng Ä‘á»£i má»™t lÃºc rá»“i thá»­ láº¡i.");
      }

      throw new Error(`Lá»—i ${errorCode}: ${errorMessage}`);
    }

    const data = await response.json();
    return data.candidates?.[0]?.content?.parts?.[0]?.text || '';
  };

  const processImage = async () => {
    if (!imageSrc) return;

    setIsProcessing(true);
    setError(null);
    setSuccessMessage(null);

    try {
      const base64 = imageSrc.includes(',') ? imageSrc.split(',')[1] : imageSrc;
      const mimeType = imageSrc.match(/data:([^;]+);/)?.[1] || 'image/jpeg';

      const responseText = await callGeminiVision(base64, mimeType);

      let jsonText = responseText.trim();
      if (jsonText.startsWith('```')) {
        jsonText = jsonText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
      }

      const extractedData: any[] = JSON.parse(jsonText);

      const processedData: Employee[] = extractedData.map((emp, index) => {
        const existing = existingEmployees.find(e => e.code === emp.code || e.name === emp.name);

        return {
          id: existing?.id || `extracted-${Date.now()}-${index}`,
          code: emp.code || `NV${String(index + 1).padStart(3, '0')}`,
          name: emp.name || `NhÃ¢n viÃªn ${index + 1}`,
          department: emp.department || 'ChÆ°a xÃ¡c Ä‘á»‹nh',
          shift: existing?.shift || '08:00 - 17:00',
          attendance: emp.attendance || {},
          password: existing?.password || '123',
          role: existing?.role || 'staff' as const
        };
      });

      if (processedData.length === 0) {
        throw new Error('KhÃ´ng tÃ¬m tháº¥y dá»¯ liá»‡u nhÃ¢n viÃªn trong áº£nh.');
      }

      onDataExtracted(processedData);
      setSuccessMessage(`âœ… ÄÃ£ trÃ­ch xuáº¥t thÃ nh cÃ´ng ${processedData.length} nhÃ¢n viÃªn!`);

      setTimeout(() => {
        handleClose();
      }, 2000);

    } catch (err: any) {
      let errorMessage = err.message || 'KhÃ´ng thá»ƒ xá»­ lÃ½ áº£nh.';
      if (errorMessage.includes('JSON')) {
        errorMessage = 'KhÃ´ng thá»ƒ Ä‘á»c dá»¯ liá»‡u tá»« áº£nh. Vui lÃ²ng chá»¥p láº¡i áº£nh rÃµ hÆ¡n.';
      }
      setError(errorMessage);
    } finally {
      setIsProcessing(false);
    }
  };

  const handleClose = () => {
    stopCamera();
    setImageSrc(null);
    setError(null);
    setSuccessMessage(null);
    setIsProcessing(false);
    setIsCapturing(false);
    if (fileInputRef.current) {
      fileInputRef.current.value = '';
    }
    onClose();
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div className="flex justify-between items-center mb-4">
          <h2 className="text-xl font-bold text-gray-800 flex items-center">
            <Camera size={20} className="mr-2" /> Chá»¥p áº¢nh & TrÃ­ch Xuáº¥t
          </h2>
          <button onClick={handleClose} className="text-gray-400 hover:text-gray-600">
            <X size={20} />
          </button>
        </div>

        {successMessage && (
          <div className="mb-4 p-3 bg-green-50 border border-green-200 text-green-700 rounded flex items-center">
            <CheckCircle size={20} className="mr-2" />
            <span>{successMessage}</span>
          </div>
        )}

        {error && (
          <div className="mb-4 p-3 bg-red-50 border border-red-200 text-red-600 rounded">
            <div className="font-semibold mb-1">âš ï¸ Lá»—i</div>
            <div className="text-sm whitespace-pre-line">{error}</div>
          </div>
        )}

        <div className="space-y-4">
          {!imageSrc && !isCapturing && (
            <div className="flex gap-4">
              <button
                onClick={() => fileInputRef.current?.click()}
                className="flex-1 flex items-center justify-center gap-2 p-4 border-2 border-dashed border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition"
              >
                <Upload size={24} className="text-blue-600" />
                <span>Táº£i áº£nh lÃªn</span>
              </button>
              <button
                onClick={startCamera}
                className="flex-1 flex items-center justify-center gap-2 p-4 border-2 border-dashed border-gray-300 rounded-lg hover:border-green-500 hover:bg-green-50 transition"
              >
                <Camera size={24} className="text-green-600" />
                <span>Chá»¥p áº£nh</span>
              </button>
            </div>
          )}

          {isCapturing && (
            <div className="relative">
              <video ref={videoRef} autoPlay playsInline className="w-full rounded-lg" />
              <div className="mt-4 flex gap-2 justify-center">
                <button
                  onClick={capturePhoto}
                  className="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 flex items-center gap-2"
                >
                  <Camera size={16} /> Chá»¥p
                </button>
                <button onClick={stopCamera} className="px-6 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">
                  Há»§y
                </button>
              </div>
            </div>
          )}

          {imageSrc && (
            <div>
              <img src={imageSrc} alt="Preview" className="w-full rounded-lg border" />
              <div className="mt-4 flex gap-2">
                <button
                  onClick={processImage}
                  disabled={isProcessing}
                  className="flex-1 flex items-center justify-center gap-2 px-4 py-3 bg-green-600 text-white rounded hover:bg-green-700 disabled:opacity-50"
                >
                  {isProcessing ? (
                    <>
                      <Loader2 size={16} className="animate-spin" />
                      <span>Äang xá»­ lÃ½...</span>
                    </>
                  ) : (
                    <>
                      <Upload size={16} />
                      <span>TrÃ­ch Xuáº¥t</span>
                    </>
                  )}
                </button>
                <button
                  onClick={() => {
                    setImageSrc(null);
                    setError(null);
                    setSuccessMessage(null);
                  }}
                  disabled={isProcessing}
                  className="px-4 py-3 bg-gray-600 text-white rounded hover:bg-gray-700 disabled:opacity-50"
                >
                  Chá»n láº¡i
                </button>
              </div>
            </div>
          )}

          <input
            ref={fileInputRef}
            type="file"
            accept="image/*"
            capture="environment"
            onChange={handleFileSelect}
            className="hidden"
          />

          <div className="text-xs text-gray-500 bg-gray-50 p-3 rounded">
            <div className="font-semibold mb-1">ğŸ’¡ HÆ°á»›ng dáº«n:</div>
            <ul className="list-disc list-inside space-y-1">
              <li>Chá»¥p áº£nh báº£ng cháº¥m cÃ´ng rÃµ rÃ ng, Ä‘á»§ sÃ¡ng</li>
              <li>Äáº£m báº£o cÃ¡c cá»™t ngÃ y vÃ  tÃªn nhÃ¢n viÃªn hiá»ƒn thá»‹ Ä‘áº§y Ä‘á»§</li>
              <li>AI sáº½ tá»± Ä‘á»™ng Ä‘á»c vÃ  trÃ­ch xuáº¥t dá»¯ liá»‡u tá»« áº£nh</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  );
};

export default ImageCapture;
</file>

<file path="src/components/shared/settings.tsx">
/**
 * Settings modal component
 * Manages API keys and app configuration
 */

import React, { useState, useEffect } from 'react';
import { Settings as SettingsIcon, Key, Save, X } from 'lucide-react';

interface SettingsProps {
  isOpen: boolean;
  onClose: () => void;
}

export const Settings: React.FC<SettingsProps> = ({ isOpen, onClose }) => {
  const [apiKey, setApiKey] = useState('');
  const [isSaving, setIsSaving] = useState(false);

  useEffect(() => {
    const savedKey = localStorage.getItem('gemini_api_key') || '';
    setApiKey(savedKey);
  }, [isOpen]);

  const handleSave = () => {
    setIsSaving(true);
    localStorage.setItem('gemini_api_key', apiKey);
    (window as any).__GEMINI_API_KEY__ = apiKey;
    setTimeout(() => {
      setIsSaving(false);
      alert('API Key Ä‘Ã£ Ä‘Æ°á»£c lÆ°u thÃ nh cÃ´ng!');
      onClose();
    }, 300);
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
        <div className="flex justify-between items-center mb-4">
          <h2 className="text-xl font-bold text-gray-800 flex items-center">
            <SettingsIcon size={20} className="mr-2" /> CÃ i Äáº·t
          </h2>
          <button
            onClick={onClose}
            className="text-gray-400 hover:text-gray-600"
          >
            <X size={20} />
          </button>
        </div>

        <div className="mb-4">
          <label className="block text-sm font-medium text-gray-700 mb-2">
            <Key size={16} className="inline mr-1" /> Gemini API Key
          </label>
          <input
            type="password"
            value={apiKey}
            onChange={(e) => setApiKey(e.target.value)}
            placeholder="Nháº­p Gemini API Key cá»§a báº¡n"
            className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
          />
          <p className="text-xs text-gray-500 mt-1">
            API Key Ä‘Æ°á»£c lÆ°u trá»¯ cá»¥c bá»™ trÃªn trÃ¬nh duyá»‡t cá»§a báº¡n
          </p>
          <div className="mt-2">
            <a
              href="https://aistudio.google.com/app/apikey"
              target="_blank"
              rel="noopener noreferrer"
              className="text-xs text-blue-600 hover:text-blue-800 underline"
            >
              ğŸ”‘ Láº¥y API Key má»›i táº¡i Ä‘Ã¢y
            </a>
          </div>
          <div className="mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded text-xs">
            <div className="font-semibold text-yellow-800 mb-1">âš ï¸ LÆ°u Ã½ vá» Quota:</div>
            <div className="text-yellow-700">
              Náº¿u gáº·p lá»—i "quota exceeded", báº¡n cÃ³ thá»ƒ:
              <ul className="list-disc list-inside mt-1 space-y-1">
                <li>Kiá»ƒm tra quota táº¡i: <a href="https://ai.dev/usage?tab=rate-limit" target="_blank" rel="noopener noreferrer" className="underline">ai.dev/usage</a></li>
                <li>Äá»£i má»™t lÃºc rá»“i thá»­ láº¡i (quota thÆ°á»ng reset theo giá»/ngÃ y)</li>
                <li>NÃ¢ng cáº¥p gÃ³i API náº¿u cáº§n sá»­ dá»¥ng nhiá»u hÆ¡n</li>
              </ul>
            </div>
          </div>
        </div>

        <div className="flex justify-end space-x-2">
          <button
            onClick={onClose}
            className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded"
          >
            Há»§y
          </button>
          <button
            onClick={handleSave}
            disabled={isSaving}
            className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 flex items-center disabled:opacity-50"
          >
            <Save size={16} className="mr-2" /> {isSaving ? 'Äang lÆ°u...' : 'LÆ°u'}
          </button>
        </div>
      </div>
    </div>
  );
};

export default Settings;
</file>

<file path="src/components/shared/sync-button.tsx">
/**
 * Sync button components
 * Shows connection status, last sync time, and sync results
 */

import React from 'react'
import {
  RefreshCw,
  Check,
  AlertCircle,
  Cloud,
  CloudOff,
  Loader2
} from 'lucide-react'
import { useSheetsSync } from '../../hooks/use-sheets-sync'

interface SyncStatusProps {
  onSyncComplete?: () => void
}

export function SyncStatus({ onSyncComplete }: SyncStatusProps) {
  const {
    status,
    isSyncing,
    lastSync,
    lastResult,
    error,
    isConnected,
    sync,
    resetStatus
  } = useSheetsSync()

  const handleSync = async () => {
    try {
      await sync()
      onSyncComplete?.()
    } catch (e) {
      // Error handled in hook
    }
  }

  const formatTime = (date: Date | null) => {
    if (!date) return 'ChÆ°a Ä‘á»“ng bá»™'
    return date.toLocaleTimeString('vi-VN', {
      hour: '2-digit',
      minute: '2-digit'
    })
  }

  const StatusIcon = () => {
    if (isSyncing) {
      return <Loader2 className="w-4 h-4 animate-spin text-blue-500" />
    }
    if (status === 'success') {
      return <Check className="w-4 h-4 text-green-500" />
    }
    if (status === 'error') {
      return <AlertCircle className="w-4 h-4 text-red-500" />
    }
    if (!isConnected) {
      return <CloudOff className="w-4 h-4 text-gray-400" />
    }
    return <Cloud className="w-4 h-4 text-blue-400" />
  }

  const getStatusText = () => {
    if (isSyncing) return 'Äang Ä‘á»“ng bá»™...'
    if (status === 'success' && lastResult) {
      const { imported, updated } = lastResult
      if (imported === 0 && updated === 0) {
        return 'KhÃ´ng cÃ³ thay Ä‘á»•i'
      }
      return `+${imported} má»›i, ${updated} cáº­p nháº­t`
    }
    if (status === 'error') return 'Lá»—i Ä‘á»“ng bá»™'
    if (!isConnected) return 'KhÃ´ng káº¿t ná»‘i'
    return `Láº§n cuá»‘i: ${formatTime(lastSync)}`
  }

  return (
    <div className="flex items-center gap-2 text-sm bg-white border rounded-lg px-3 py-2 shadow-sm">
      <StatusIcon />
      <span className="text-gray-600 min-w-[120px]">
        {getStatusText()}
      </span>
      <button
        onClick={handleSync}
        disabled={isSyncing || !isConnected}
        className="
          flex items-center gap-1 px-3 py-1.5
          text-xs font-medium
          bg-blue-500 text-white rounded
          hover:bg-blue-600
          disabled:opacity-50 disabled:cursor-not-allowed
          transition-colors
        "
        title="Äá»“ng bá»™ tá»« Google Sheets"
      >
        <RefreshCw className={`w-3.5 h-3.5 ${isSyncing ? 'animate-spin' : ''}`} />
        <span>Sync</span>
      </button>
      {error && status === 'error' && (
        <div
          className="absolute top-full left-0 mt-1 p-2 bg-red-50 border border-red-200 rounded text-xs text-red-600 max-w-xs z-10"
          onClick={() => resetStatus()}
        >
          {error}
        </div>
      )}
    </div>
  )
}

/**
 * Compact sync button for toolbar
 */
export function SyncButton({ onSyncComplete }: SyncStatusProps) {
  const { isSyncing, isConnected, sync } = useSheetsSync()

  const handleSync = async () => {
    try {
      await sync()
      onSyncComplete?.()
    } catch (e) {
      // Error handled in hook
    }
  }

  return (
    <button
      onClick={handleSync}
      disabled={isSyncing || !isConnected}
      className="
        flex items-center gap-1.5 px-3 py-2
        text-sm font-medium
        bg-green-500 text-white rounded-lg
        hover:bg-green-600
        disabled:opacity-50 disabled:cursor-not-allowed
        transition-colors
      "
      title="Äá»“ng bá»™ dá»¯ liá»‡u tá»« Google Sheets"
    >
      <RefreshCw className={`w-4 h-4 ${isSyncing ? 'animate-spin' : ''}`} />
      <span>{isSyncing ? 'Äang sync...' : 'Sync tá»« Sheets'}</span>
    </button>
  )
}

export default SyncStatus
</file>

<file path="src/components/targets/index.ts">
/**
 * Targets components barrel export
 * Re-export from parent directory for backward compatibility
 */

export { TargetManagement } from '../TargetManagement'
</file>

<file path="src/components/timesheet/add-employee-modal.tsx">
/**
 * Add Employee Modal Component
 * Modal form for adding new employee with validation
 */

import React, { useState } from 'react';
import { Plus, X, Save, AlertCircle } from 'lucide-react';
import type { Employee, Target } from '../../types';

export interface AddEmployeeFormData {
  code: string;
  name: string;
  department: string;
}

export interface AddEmployeeModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSubmit: (employee: Employee) => void;
  targets: Target[];
  existingCodes: string[]; // Codes already in grid
  allEmployeeCodes: string[]; // Codes in master list
}

export const AddEmployeeModal: React.FC<AddEmployeeModalProps> = ({
  isOpen,
  onClose,
  onSubmit,
  targets,
  existingCodes,
  allEmployeeCodes,
}) => {
  const [form, setForm] = useState<AddEmployeeFormData>({
    code: '',
    name: '',
    department: ''
  });
  const [errors, setErrors] = useState<string[]>([]);

  // Reset form when modal opens
  React.useEffect(() => {
    if (isOpen) {
      setForm({ code: '', name: '', department: '' });
      setErrors([]);
    }
  }, [isOpen]);

  // Validate and submit form
  const handleSubmit = () => {
    const validationErrors: string[] = [];
    const trimmedCode = form.code.trim();
    const trimmedName = form.name.trim();
    const trimmedDept = form.department.trim();

    // Required field validation
    if (!trimmedCode) {
      validationErrors.push('MÃ£ NV khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng');
    }
    if (!trimmedName) {
      validationErrors.push('Há» tÃªn khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng');
    }

    // Code format validation (alphanumeric, no spaces)
    if (trimmedCode && !/^[a-zA-Z0-9]+$/.test(trimmedCode)) {
      validationErrors.push('MÃ£ NV chá»‰ Ä‘Æ°á»£c chá»©a chá»¯ vÃ  sá»‘ (khÃ´ng cÃ³ dáº¥u cÃ¡ch)');
    }

    // Duplicate code check in grid
    if (trimmedCode && existingCodes.some(c => c.toLowerCase() === trimmedCode.toLowerCase())) {
      validationErrors.push(`MÃ£ NV "${trimmedCode}" Ä‘Ã£ tá»“n táº¡i trong báº£ng cháº¥m cÃ´ng`);
    }

    // Duplicate code check in allEmployees (master list)
    if (trimmedCode && allEmployeeCodes.some(c => c.toLowerCase() === trimmedCode.toLowerCase())) {
      validationErrors.push(`MÃ£ NV "${trimmedCode}" Ä‘Ã£ tá»“n táº¡i trong há»‡ thá»‘ng`);
    }

    // Name length validation
    if (trimmedName && trimmedName.length < 2) {
      validationErrors.push('Há» tÃªn pháº£i cÃ³ Ã­t nháº¥t 2 kÃ½ tá»±');
    }

    if (validationErrors.length > 0) {
      setErrors(validationErrors);
      return;
    }

    // Create new employee
    const newEmployee: Employee = {
      id: Math.random().toString(36).substr(2, 9),
      code: trimmedCode.toUpperCase(),
      name: trimmedName,
      department: trimmedDept || 'ChÆ°a xÃ¡c Ä‘á»‹nh',
      shift: '08:00 - 17:00',
      attendance: {},
      password: '123',
      role: 'staff'
    };

    onSubmit(newEmployee);
    onClose();
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
        {/* Header */}
        <div className="flex items-center justify-between p-4 border-b">
          <h3 className="text-lg font-bold text-gray-800 flex items-center">
            <Plus size={20} className="mr-2 text-blue-600" />
            ThÃªm NhÃ¢n ViÃªn Má»›i
          </h3>
          <button
            onClick={onClose}
            className="text-gray-400 hover:text-gray-600"
          >
            <X size={20} />
          </button>
        </div>

        {/* Form body */}
        <div className="p-4 space-y-4">
          {/* Error messages */}
          {errors.length > 0 && (
            <div className="bg-red-50 border border-red-200 rounded-lg p-3">
              <div className="flex items-start">
                <AlertCircle size={18} className="text-red-500 mr-2 mt-0.5 flex-shrink-0" />
                <div className="text-sm text-red-700">
                  {errors.map((err, idx) => (
                    <div key={idx}>â€¢ {err}</div>
                  ))}
                </div>
              </div>
            </div>
          )}

          {/* Code field */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              MÃ£ NV <span className="text-red-500">*</span>
            </label>
            <input
              type="text"
              value={form.code}
              onChange={(e) => setForm({ ...form, code: e.target.value.toUpperCase() })}
              className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
              placeholder="VD: NV001"
              autoFocus
            />
          </div>

          {/* Name field */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Há» vÃ  TÃªn <span className="text-red-500">*</span>
            </label>
            <input
              type="text"
              value={form.name}
              onChange={(e) => setForm({ ...form, name: e.target.value })}
              className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
              placeholder="VD: Nguyá»…n VÄƒn A"
            />
          </div>

          {/* Department/Target field */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Má»¥c TiÃªu / PhÃ²ng Ban
            </label>
            <select
              value={form.department}
              onChange={(e) => setForm({ ...form, department: e.target.value })}
              className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
            >
              <option value="">-- Chá»n má»¥c tiÃªu --</option>
              {targets.map(t => (
                <option key={t.id} value={t.name}>{t.name}</option>
              ))}
              <option value="VÄƒn PhÃ²ng">VÄƒn PhÃ²ng</option>
              <option value="KhÃ¡c">KhÃ¡c</option>
            </select>
          </div>

          {/* Info text */}
          <div className="text-xs text-gray-500 bg-gray-50 p-2 rounded">
            <strong>LÆ°u Ã½:</strong> NhÃ¢n viÃªn má»›i sáº½ Ä‘Æ°á»£c tá»± Ä‘á»™ng Ä‘á»“ng bá»™ vá»›i trang NhÃ¢n Sá»± vÃ  lÆ°u vÃ o há»‡ thá»‘ng.
          </div>
        </div>

        {/* Footer */}
        <div className="flex justify-end space-x-2 p-4 border-t bg-gray-50">
          <button
            onClick={onClose}
            className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition"
          >
            Há»§y
          </button>
          <button
            onClick={handleSubmit}
            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center"
          >
            <Save size={16} className="mr-2" />
            ThÃªm NhÃ¢n ViÃªn
          </button>
        </div>
      </div>
    </div>
  );
};
</file>

<file path="src/components/timesheet/index.ts">
/**
 * Timesheet module exports
 * Main timesheet grid and related components
 */

export { TimesheetGrid } from './timesheet-grid';
export { AddEmployeeModal } from './add-employee-modal';
export { TimesheetToolbar } from './timesheet-toolbar';

// Types
export type { AddEmployeeFormData, AddEmployeeModalProps } from './add-employee-modal';
export type { TimesheetToolbarProps } from './timesheet-toolbar';
</file>

<file path="src/components/timesheet/timesheet-grid.tsx">
/**
 * TimesheetGrid Component (Modular Version)
 * Main timesheet grid with cell selection, autocomplete, and CRUD operations
 */

import React, { useMemo, useState, useCallback, useRef } from 'react';
import { Trash2, CheckSquare, Square } from 'lucide-react';
import type { Employee, Target } from '../../types';
import { useCellSelection } from '../../hooks/use-cell-selection';
import { useAutocomplete } from '../../hooks/use-autocomplete';
import { AddEmployeeModal } from './add-employee-modal';
import { TimesheetToolbar } from './timesheet-toolbar';
import {
  generateDaysInfo,
  calculateTotal,
  getCellColor,
  sortByTargetOrder,
  getStickyPositions,
  COL_WIDTHS,
  createRowsFromTarget
} from '../../utils/timesheet-helpers';

interface TimesheetGridProps {
  year: number;
  month: number; // 0-indexed (0 = Jan, 11 = Dec)
  data: Employee[];
  targets: Target[];
  allEmployees: Employee[];
  onDataChange: (newData: Employee[]) => void;
}

export const TimesheetGrid: React.FC<TimesheetGridProps> = ({
  year,
  month,
  data,
  targets,
  allEmployees,
  onDataChange
}) => {
  const [hoveredRow, setHoveredRow] = useState<string | null>(null);
  const [selectedRowIds, setSelectedRowIds] = useState<Set<string>>(new Set());
  const [showAddModal, setShowAddModal] = useState(false);
  const tableRef = useRef<HTMLTableElement>(null);

  // Generate days for the month
  const days = useMemo(() => generateDaysInfo(year, month), [year, month]);

  // Sorted data by target order
  const sortedData = useMemo(
    () => sortByTargetOrder(data, targets, allEmployees),
    [data, targets, allEmployees]
  );

  // Sticky positions
  const stickyPos = useMemo(() => getStickyPositions(), []);

  // Cell selection hook
  const cellSelection = useCellSelection({
    data: sortedData,
    days,
    onDataChange: (newSortedData) => {
      // Map sorted data back to original order for state update
      const idMap = new Map(newSortedData.map(e => [e.id, e]));
      const newData = data.map(e => idMap.get(e.id) || e);
      onDataChange(newData);
    }
  });

  // Autocomplete hook
  const autocomplete = useAutocomplete({
    allEmployees,
    data,
    onDataChange
  });

  // Handle cell value change
  const handleCellChange = useCallback((empId: string, day: number, value: string) => {
    const newData = data.map((emp) => {
      if (emp.id === empId) {
        return {
          ...emp,
          attendance: {
            ...emp.attendance,
            [day]: value,
          },
        };
      }
      return emp;
    });
    onDataChange(newData);
  }, [data, onDataChange]);

  // Handle employee info change
  const handleInfoChange = useCallback((empId: string, field: keyof Employee, value: string) => {
    const newData = data.map((emp) => {
      if (emp.id === empId) {
        return { ...emp, [field]: value };
      }
      return emp;
    });
    onDataChange(newData);
  }, [data, onDataChange]);

  // Clear single cell
  const clearCell = useCallback((empId: string, day: number) => {
    handleCellChange(empId, day, '');
  }, [handleCellChange]);

  // Row selection handlers
  const toggleSelectAll = useCallback((e: React.MouseEvent) => {
    e.stopPropagation();
    if (selectedRowIds.size === data.length && data.length > 0) {
      setSelectedRowIds(new Set());
    } else {
      setSelectedRowIds(new Set(data.map(d => d.id)));
    }
  }, [data.length, selectedRowIds.size]);

  const toggleRowSelection = useCallback((id: string, e: React.MouseEvent) => {
    e.stopPropagation();
    const newSet = new Set(selectedRowIds);
    if (newSet.has(id)) {
      newSet.delete(id);
    } else {
      newSet.add(id);
    }
    setSelectedRowIds(newSet);
  }, [selectedRowIds]);

  const deleteSelectedRows = useCallback(() => {
    if (selectedRowIds.size === 0) return;
    const remainingEmployees = data.filter(emp => !selectedRowIds.has(emp.id));
    onDataChange(remainingEmployees);
    setSelectedRowIds(new Set());
  }, [data, onDataChange, selectedRowIds]);

  // Remove single row
  const removeRow = useCallback((id: string) => {
    onDataChange(data.filter(e => e.id !== id));
  }, [data, onDataChange]);

  // Add employee from modal
  const handleAddEmployee = useCallback((newEmployee: Employee) => {
    onDataChange([...data, newEmployee]);
  }, [data, onDataChange]);

  // Add rows from target
  const handleAddTargetRows = useCallback((target: Target) => {
    const existingCodes = data.map(e => e.code);
    const newRows = createRowsFromTarget(target, allEmployees, existingCodes);

    if (newRows.length > 0) {
      onDataChange([...data, ...newRows]);
    }
  }, [data, allEmployees, onDataChange]);

  // Total attendance
  const totalAttendance = useMemo(
    () => data.reduce((acc, emp) => acc + calculateTotal(emp.attendance), 0),
    [data]
  );

  return (
    <div className="flex flex-col h-full bg-gray-100 border rounded-lg shadow-xl overflow-hidden select-none">
      {/* Toolbar */}
      <TimesheetToolbar
        totalAttendance={totalAttendance}
        selectedCount={selectedRowIds.size}
        hasSelection={cellSelection.selection !== null}
        targets={targets}
        allEmployees={allEmployees}
        gridData={data}
        onDeleteSelected={deleteSelectedRows}
        onCopySelection={cellSelection.copySelection}
        onAddNewRow={() => setShowAddModal(true)}
        onAddTargetRows={handleAddTargetRows}
      />

      {/* Table Container */}
      <div className="flex-1 overflow-auto relative bg-white" ref={tableRef}>
        <table className="border-collapse w-full min-w-max text-sm">
          <thead className="sticky top-0 z-20">
            {/* Header Row 1: Dates */}
            <tr className="bg-[#0070c0] text-white">
              <th
                className="sticky z-30 border border-gray-400 bg-[#0070c0] p-1 text-center cursor-pointer select-none"
                style={{ left: stickyPos.CHECK, width: COL_WIDTHS.CHECK }}
                onClick={toggleSelectAll}
              >
                <div className="w-full h-full flex items-center justify-center">
                  {data.length > 0 && selectedRowIds.size === data.length ? <CheckSquare size={16} /> : <Square size={16} />}
                </div>
              </th>
              <th className="sticky z-30 border border-gray-400 bg-[#0070c0] p-1" style={{ left: stickyPos.STT, width: COL_WIDTHS.STT }}>STT</th>
              <th className="sticky z-30 border border-gray-400 bg-[#0070c0] p-1" style={{ left: stickyPos.CODE, width: COL_WIDTHS.CODE }}>MÃ£</th>
              <th className="sticky z-30 border border-gray-400 bg-[#0070c0] p-1" style={{ left: stickyPos.NAME, width: COL_WIDTHS.NAME }}>Há» VÃ  TÃªn</th>
              <th className="sticky z-30 border border-gray-400 bg-[#0070c0] p-1" style={{ left: stickyPos.TARGET, width: COL_WIDTHS.TARGET }}>Má»¥c TiÃªu</th>
              {days.map((day) => (
                <th
                  key={`date-${day.date}`}
                  className="w-10 border border-gray-400 p-1 text-center font-normal bg-[#0070c0]"
                >
                  {day.date.toString().padStart(2, '0')}
                </th>
              ))}
              <th className="w-16 border border-gray-400 bg-[#0070c0] p-1">Tá»•ng</th>
              <th className="w-10 border border-gray-400 bg-[#0070c0] p-1">XÃ³a</th>
            </tr>
            {/* Header Row 2: Days of Week */}
            <tr className="bg-[#ffc000] text-black">
              <th className="sticky z-30 border border-gray-400 bg-[#0070c0] h-6" style={{ left: stickyPos.CHECK }}></th>
              <th className="sticky z-30 border border-gray-400 bg-[#0070c0] h-6" style={{ left: stickyPos.STT }}></th>
              <th className="sticky z-30 border border-gray-400 bg-[#0070c0] h-6" style={{ left: stickyPos.CODE }}></th>
              <th className="sticky z-30 border border-gray-400 bg-[#0070c0] h-6" style={{ left: stickyPos.NAME }}></th>
              <th className="sticky z-30 border border-gray-400 bg-[#0070c0] h-6" style={{ left: stickyPos.TARGET }}></th>
              {days.map((day) => (
                <th
                  key={`day-${day.date}`}
                  className={`border border-gray-400 p-0 text-center text-xs font-semibold h-6 ${day.isWeekend ? 'bg-yellow-400' : 'bg-[#0070c0] text-white'
                    }`}
                >
                  {day.dayOfWeek}
                </th>
              ))}
              <th className="border border-gray-400 bg-[#0070c0] h-6"></th>
              <th className="border border-gray-400 bg-[#0070c0] h-6"></th>
            </tr>
          </thead>
          <tbody>
            {sortedData.map((emp, rIdx) => {
              const codeFieldKey = `${emp.id}-code`;
              const nameFieldKey = `${emp.id}-name`;
              const isCodeActive = autocomplete.isFieldActive(emp.id, 'code');
              const isNameActive = autocomplete.isFieldActive(emp.id, 'name');

              return (
                <tr
                  key={emp.id}
                  className={`group ${hoveredRow === emp.id ? 'bg-blue-50' : 'bg-white'}`}
                  onMouseEnter={() => setHoveredRow(emp.id)}
                  onMouseLeave={() => setHoveredRow(null)}
                >
                  {/* Checkbox */}
                  <td
                    className="sticky z-10 border border-gray-300 bg-white p-0 text-center cursor-pointer select-none"
                    style={{ left: stickyPos.CHECK }}
                    onClick={(e) => toggleRowSelection(emp.id, e)}
                  >
                    <div className="w-full h-full flex items-center justify-center hover:bg-blue-100">
                      {selectedRowIds.has(emp.id) ?
                        <CheckSquare size={16} className="text-blue-600" /> :
                        <Square size={16} className="text-gray-300 group-hover:text-gray-400" />
                      }
                    </div>
                  </td>
                  {/* STT */}
                  <td className="sticky z-10 border border-gray-300 bg-white p-1 text-center font-medium text-gray-500" style={{ left: stickyPos.STT }}>
                    {rIdx + 1}
                  </td>
                  {/* Code with autocomplete */}
                  <td className="sticky z-10 border border-gray-300 bg-white p-0 relative" style={{ left: stickyPos.CODE }}>
                    <div className="relative autocomplete-container">
                      <input
                        type="text"
                        value={emp.code}
                        onChange={(e) => autocomplete.handleAutocompleteInput(emp.id, 'code', e.target.value, handleInfoChange)}
                        onFocus={() => autocomplete.handleFieldFocus(emp.id, 'code', emp.code)}
                        onBlur={() => autocomplete.handleFieldBlur(emp.id, 'code')}
                        onCompositionStart={autocomplete.handleCompositionStart}
                        onCompositionEnd={autocomplete.handleCompositionEnd}
                        className="w-full h-full px-1 text-center focus:outline-none focus:bg-blue-50 bg-transparent font-semibold text-gray-700"
                      />
                      {isCodeActive && autocomplete.autocompleteState.suggestions.length > 0 && (
                        <div className="absolute top-full left-0 right-0 z-50 bg-white border border-gray-300 rounded shadow-lg mt-1 max-h-40 overflow-y-auto autocomplete-container">
                          {autocomplete.autocompleteState.suggestions.map((suggestion) => (
                            <div
                              key={suggestion.id}
                              onMouseDown={(e) => e.preventDefault()}
                              onClick={() => autocomplete.selectSuggestion(emp.id, 'code', suggestion)}
                              className="px-2 py-1 hover:bg-blue-50 cursor-pointer text-sm"
                            >
                              <div className="font-semibold">{suggestion.code}</div>
                              <div className="text-xs text-gray-500">{suggestion.name}</div>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  </td>
                  {/* Name - using defaultValue to prevent cursor jump */}
                  <td className="sticky z-10 border border-gray-300 bg-white p-0 relative" style={{ left: stickyPos.NAME }}>
                    <input
                      type="text"
                      key={`name-${emp.id}`}
                      defaultValue={emp.name || ''}
                      onBlur={(e) => {
                        if (e.target.value !== emp.name) {
                          handleInfoChange(emp.id, 'name', e.target.value);
                        }
                      }}
                      className="w-full h-full px-2 py-1 font-semibold text-gray-800 focus:outline-none focus:bg-blue-50 bg-transparent truncate"
                    />
                  </td>
                  {/* Department/Target */}
                  <td className="sticky z-10 border border-gray-300 p-0 bg-yellow-200" style={{ left: stickyPos.TARGET }}>
                    <input
                      type="text"
                      value={emp.department}
                      onChange={(e) => handleInfoChange(emp.id, 'department', e.target.value)}
                      className="w-full h-full bg-transparent px-1 font-medium focus:outline-none truncate"
                    />
                  </td>

                  {/* Day Cells */}
                  {days.map((day, cIdx) => {
                    const val = emp.attendance[day.date] || '';
                    const isSelected = cellSelection.isCellSelected(rIdx, cIdx);

                    return (
                      <td
                        key={`${emp.id}-${day.date}`}
                        onMouseDown={(e) => cellSelection.handleMouseDown(rIdx, cIdx, e)}
                        onMouseEnter={() => cellSelection.handleMouseEnter(rIdx, cIdx)}
                        onClick={() => cellSelection.handleCellClick(rIdx, cIdx)}
                        className={`border border-gray-300 p-0 text-center h-8 min-w-[32px] cursor-cell relative group/cell
                          ${getCellColor(val, day.isWeekend)}
                          ${isSelected ? 'ring-2 ring-blue-500 ring-inset z-10' : ''}
                        `}
                      >
                        <input
                          type="text"
                          value={val}
                          onChange={(e) => handleCellChange(emp.id, day.date, e.target.value)}
                          className={`w-full h-full text-center bg-transparent focus:outline-none font-bold ${val === 'CN' ? 'text-white' : ''
                            } ${isSelected ? 'bg-blue-500 bg-opacity-20 text-blue-900' : ''}`}
                          onMouseDown={(e) => cellSelection.handleMouseDown(rIdx, cIdx, e as any)}
                          onMouseEnter={() => cellSelection.handleMouseEnter(rIdx, cIdx)}
                          onDragStart={(e) => e.preventDefault()}
                          onKeyDown={(e) => {
                            if ((e.key === 'Delete' || e.key === 'Backspace') && val === '') {
                              e.preventDefault();
                            }
                          }}
                        />
                        {/* Clear button on hover */}
                        {val && (
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              clearCell(emp.id, day.date);
                            }}
                            className="absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white rounded-full text-xs opacity-0 group-hover/cell:opacity-100 hover:bg-red-600 transition-opacity flex items-center justify-center z-20"
                            title="XÃ³a"
                          >
                            Ã—
                          </button>
                        )}
                      </td>
                    );
                  })}

                  {/* Total */}
                  <td className="border border-gray-300 bg-[#00b050] text-white font-bold text-center p-1">
                    {calculateTotal(emp.attendance)}
                  </td>
                  {/* Delete button */}
                  <td className="border border-gray-300 text-center p-0">
                    <button
                      onClick={() => removeRow(emp.id)}
                      className="w-full h-full flex items-center justify-center text-red-500 hover:bg-red-50"
                    >
                      <Trash2 size={14} />
                    </button>
                  </td>
                </tr>
              );
            })}
            <tr className="h-4"></tr>
          </tbody>
        </table>
      </div>

      {/* Add Employee Modal */}
      <AddEmployeeModal
        isOpen={showAddModal}
        onClose={() => setShowAddModal(false)}
        onSubmit={handleAddEmployee}
        targets={targets}
        existingCodes={data.map(e => e.code)}
        allEmployeeCodes={allEmployees.map(e => e.code)}
      />
    </div>
  );
};
</file>

<file path="src/components/timesheet/timesheet-toolbar.tsx">
/**
 * Timesheet Toolbar Component
 * Contains action buttons and selection info
 */

import React, { useRef, useEffect, useState } from 'react';
import { Plus, Trash2, Copy, ChevronDown } from 'lucide-react';
import type { Target, Employee } from '../../types';

export interface TimesheetToolbarProps {
  totalAttendance: number;
  selectedCount: number;
  hasSelection: boolean;
  targets: Target[];
  allEmployees: Employee[];
  gridData: Employee[];
  onDeleteSelected: () => void;
  onCopySelection: () => void;
  onAddNewRow: () => void;
  onAddTargetRows: (target: Target) => void;
}

export const TimesheetToolbar: React.FC<TimesheetToolbarProps> = ({
  totalAttendance,
  selectedCount,
  hasSelection,
  targets,
  allEmployees,
  gridData,
  onDeleteSelected,
  onCopySelection,
  onAddNewRow,
  onAddTargetRows,
}) => {
  const [showDropdown, setShowDropdown] = useState(false);
  const dropdownRef = useRef<HTMLDivElement>(null);

  // Close dropdown when clicking outside
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (dropdownRef.current && !dropdownRef.current.contains(event.target as Node)) {
        setShowDropdown(false);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  // Handle adding target rows with duplicate check
  const handleAddTargetRows = (target: Target) => {
    let duplicateCount = 0;
    let addableCount = 0;

    target.roster.forEach(rosterItem => {
      const empDetails = allEmployees.find(e => e.id === rosterItem.employeeId);
      if (empDetails) {
        const isAlreadyInGrid = gridData.some(d => d.code === empDetails.code);
        if (isAlreadyInGrid) {
          duplicateCount++;
        } else {
          addableCount++;
        }
      }
    });

    if (addableCount === 0) {
      if (duplicateCount > 0) {
        alert(`KhÃ´ng thá»ƒ thÃªm: Táº¥t cáº£ ${duplicateCount} nhÃ¢n sá»± trong má»¥c tiÃªu "${target.name}" Ä‘Ã£ cÃ³ máº·t trong báº£ng cháº¥m cÃ´ng.`);
      } else {
        alert(`Má»¥c tiÃªu "${target.name}" chÆ°a cÃ³ nhÃ¢n sá»± nÃ o Ä‘Æ°á»£c gÃ¡n trong pháº§n Quáº£n LÃ½ Má»¥c TiÃªu.`);
      }
      setShowDropdown(false);
      return;
    }

    onAddTargetRows(target);
    setShowDropdown(false);
  };

  return (
    <div className="flex justify-between items-center p-2 bg-white border-b">
      <div className="flex items-center space-x-2">
        <span className="font-bold text-gray-700">
          Tá»•ng Sá»‘: {totalAttendance} cÃ´ng
        </span>

        {/* Delete selected rows button */}
        {selectedCount > 0 && (
          <button
            type="button"
            onClick={onDeleteSelected}
            className="flex items-center px-3 py-1 text-sm bg-red-100 text-red-700 rounded hover:bg-red-200 transition ml-4 border border-red-200"
          >
            <Trash2 size={14} className="mr-1" /> XÃ³a {selectedCount} dÃ²ng Ä‘Ã£ chá»n
          </button>
        )}

        {/* Cell selection actions */}
        {hasSelection && (
          <div className="flex items-center space-x-1 ml-4 pl-4 border-l">
            <button
              onClick={onCopySelection}
              className="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded flex items-center"
              title="Ctrl+C"
            >
              <Copy size={12} className="mr-1" /> Copy
            </button>
          </div>
        )}
      </div>

      {/* Add employee dropdown */}
      <div className="flex space-x-2">
        <div className="relative" ref={dropdownRef}>
          <button
            onClick={() => setShowDropdown(!showDropdown)}
            className="flex items-center px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 transition"
          >
            <Plus size={16} className="mr-1" /> ThÃªm NV <ChevronDown size={14} className="ml-1" />
          </button>

          {showDropdown && (
            <div className="absolute right-0 mt-2 w-64 bg-white rounded-md shadow-lg z-50 border ring-1 ring-black ring-opacity-5 py-1">
              <div className="px-3 py-2 text-xs font-semibold text-gray-500 bg-gray-50 border-b uppercase">
                ThÃªm tá»« Má»¥c TiÃªu
              </div>
              {targets.map(t => (
                <button
                  key={t.id}
                  onClick={() => handleAddTargetRows(t)}
                  className="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-700"
                >
                  {t.name} <span className="text-xs text-gray-400">({t.roster.length} NV)</span>
                </button>
              ))}
              <div className="border-t my-1"></div>
              <button
                onClick={() => {
                  onAddNewRow();
                  setShowDropdown(false);
                }}
                className="block w-full text-left px-4 py-2 text-sm text-gray-500 hover:bg-gray-50 italic"
              >
                + ThÃªm dÃ²ng trá»‘ng
              </button>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};
</file>

<file path="src/constants/date.ts">
/**
 * Date-related constants
 * Day name arrays for calendar display
 */

export const DAYS_OF_WEEK_VI = ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'];
export const DAYS_OF_WEEK_EN = ['Sun', 'Mo', 'Tue', 'We', 'Thu', 'Fri', 'Sat'];
</file>

<file path="src/constants/index.ts">
/**
 * Central constants exports
 * Re-exports all domain constants
 */

export { DAYS_OF_WEEK_VI, DAYS_OF_WEEK_EN } from './date';
</file>

<file path="src/core/app-header.tsx">
/**
 * App Header
 * Navigation bar with user info and controls
 */

import React from 'react';
import { LogOut, LayoutDashboard, Shield, MapPin, Settings as SettingsIcon } from 'lucide-react';
import { useAuth } from '../features/auth';

type ViewType = 'timesheet' | 'hr' | 'targets';

interface AppHeaderProps {
  currentView: ViewType;
  onViewChange: (view: ViewType) => void;
  onSettingsClick: () => void;
  onLogout: () => void;
  children?: React.ReactNode; // For month/year selectors
}

const logoUrl = "https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Fa95c8148.%E1%BA%A2nh.072220.jpg";

export const AppHeader: React.FC<AppHeaderProps> = ({
  currentView,
  onViewChange,
  onSettingsClick,
  onLogout,
  children
}) => {
  const { currentUser } = useAuth();

  return (
    <header className="bg-blue-700 text-white shadow-md p-4 sticky top-0 z-50">
      <div className="max-w-[1920px] mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
        {/* Logo & User Info */}
        <div className="flex items-center space-x-3">
          <div className="bg-white p-1 rounded-lg overflow-hidden h-12 w-12 flex items-center justify-center shadow-lg">
            <img src={logoUrl} alt="Logo" className="w-full h-full object-cover" />
          </div>
          <div>
            <h1 className="text-xl font-bold uppercase tracking-wide">Báº¡ch Há»• Security</h1>
            <p className="text-blue-200 text-sm">
              Xin chÃ o, {currentUser?.name} ({currentUser?.role === 'admin' ? 'Quáº£n Trá»‹' : 'NhÃ¢n ViÃªn'})
            </p>
          </div>
        </div>

        {/* Navigation */}
        <div className="flex items-center space-x-2 bg-blue-800 p-1 rounded-lg shadow-inner">
          <button
            onClick={() => onViewChange('timesheet')}
            className={`flex items-center px-4 py-2 rounded transition font-medium ${
              currentView === 'timesheet' ? 'bg-blue-600 shadow text-white' : 'hover:bg-blue-700 text-blue-200'
            }`}
          >
            <LayoutDashboard size={18} className="mr-2" /> Cháº¥m CÃ´ng
          </button>
          {currentUser?.role === 'admin' && (
            <>
              <button
                onClick={() => onViewChange('targets')}
                className={`flex items-center px-4 py-2 rounded transition font-medium ${
                  currentView === 'targets' ? 'bg-blue-600 shadow text-white' : 'hover:bg-blue-700 text-blue-200'
                }`}
              >
                <MapPin size={18} className="mr-2" /> Má»¥c TiÃªu
              </button>
              <button
                onClick={() => onViewChange('hr')}
                className={`flex items-center px-4 py-2 rounded transition font-medium ${
                  currentView === 'hr' ? 'bg-blue-600 shadow text-white' : 'hover:bg-blue-700 text-blue-200'
                }`}
              >
                <Shield size={18} className="mr-2" /> NhÃ¢n Sá»±
              </button>
            </>
          )}
        </div>

        {/* Controls */}
        <div className="flex items-center space-x-2">
          {children}
          <button
            onClick={onSettingsClick}
            className="flex items-center space-x-2 bg-gray-600 hover:bg-gray-700 px-3 py-2 rounded shadow transition text-sm font-medium"
            title="CÃ i Ä‘áº·t"
          >
            <SettingsIcon size={16} />
          </button>
          <button
            onClick={onLogout}
            className="flex items-center space-x-2 bg-red-600 hover:bg-red-700 px-3 py-2 rounded shadow transition text-sm font-medium border border-red-500"
            title="ÄÄƒng xuáº¥t"
          >
            <LogOut size={16} />
          </button>
        </div>
      </div>
    </header>
  );
};
</file>

<file path="src/core/app-providers.tsx">
/**
 * App Providers
 * Composes all context providers in correct order
 */

import React from 'react';
import { AuthProvider } from '../features/auth';
import { EmployeesProvider } from '../features/hr';
import { TargetsProvider } from '../features/targets';
import { TimesheetProvider } from '../features/timesheet';

interface AppProvidersProps {
  children: React.ReactNode;
}

export const AppProviders: React.FC<AppProvidersProps> = ({ children }) => (
  <AuthProvider>
    <EmployeesProvider>
      <TargetsProvider>
        <TimesheetProvider>
          {children}
        </TimesheetProvider>
      </TargetsProvider>
    </EmployeesProvider>
  </AuthProvider>
);
</file>

<file path="src/core/index.ts">
/**
 * App module exports
 */

export { AppProviders } from './app-providers';
export { AppLayout } from './app-layout';
export { AppHeader } from './app-header';
</file>

<file path="src/features/auth/auth-context.tsx">
/**
 * Auth Context
 * Manages authentication state (login/logout, current user)
 */

import React, { createContext, useContext, useState, useCallback } from 'react';
import type { Employee } from '../../types';

interface AuthContextType {
  currentUser: Employee | null;
  isLoggedIn: boolean;
  login: (user: Employee) => void;
  logout: () => void;
}

const AuthContext = createContext<AuthContextType | null>(null);

export const useAuth = () => {
  const context = useContext(AuthContext);
  if (!context) throw new Error('useAuth must be used within AuthProvider');
  return context;
};

export const AuthProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [currentUser, setCurrentUser] = useState<Employee | null>(null);

  const login = useCallback((user: Employee) => {
    setCurrentUser(user);
  }, []);

  const logout = useCallback(() => {
    setCurrentUser(null);
  }, []);

  return (
    <AuthContext.Provider value={{
      currentUser,
      isLoggedIn: !!currentUser,
      login,
      logout
    }}>
      {children}
    </AuthContext.Provider>
  );
};
</file>

<file path="src/features/auth/index.ts">
/**
 * Auth feature exports
 */

export { AuthProvider, useAuth } from './auth-context';
</file>

<file path="src/features/hr/employees-context.tsx">
/**
 * Employees Context
 * Manages employee data and CRUD operations
 */

import React, { createContext, useContext, useState, useEffect, useCallback } from 'react';
import {
  getAllEmployees,
  createEmployee as createEmp,
  updateEmployee as updateEmp,
  deleteEmployee as deleteEmp
} from '../../services/realtime-database-service';
import type { Employee } from '../../types';

interface EmployeesContextType {
  employees: Employee[];
  isLoading: boolean;
  error: string | null;
  addEmployee: (data: Partial<Employee>) => Promise<Employee>;
  updateEmployee: (id: string, data: Partial<Employee>) => Promise<void>;
  removeEmployee: (id: string) => Promise<void>;
  refreshEmployees: () => Promise<void>;
  setEmployees: React.Dispatch<React.SetStateAction<Employee[]>>;
}

const EmployeesContext = createContext<EmployeesContextType | null>(null);

export const useEmployees = () => {
  const context = useContext(EmployeesContext);
  if (!context) throw new Error('useEmployees must be used within EmployeesProvider');
  return context;
};

export const EmployeesProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [employees, setEmployees] = useState<Employee[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  const refreshEmployees = useCallback(async () => {
    try {
      setIsLoading(true);
      const data = await getAllEmployees();
      setEmployees(data);
      setError(null);
    } catch (err) {
      console.error('[EmployeesContext] Failed to load:', err);
      setError('KhÃ´ng thá»ƒ táº£i danh sÃ¡ch nhÃ¢n viÃªn');
    } finally {
      setIsLoading(false);
    }
  }, []);

  useEffect(() => {
    refreshEmployees();
  }, [refreshEmployees]);

  const addEmployee = useCallback(async (data: Partial<Employee>): Promise<Employee> => {
    const newEmp = await createEmp(data);
    setEmployees(prev => [...prev, newEmp]);
    return newEmp;
  }, []);

  const updateEmployee = useCallback(async (id: string, data: Partial<Employee>) => {
    await updateEmp(id, data);
    setEmployees(prev => prev.map(e => e.id === id ? { ...e, ...data } : e));
  }, []);

  const removeEmployee = useCallback(async (id: string) => {
    await deleteEmp(id);
    setEmployees(prev => prev.filter(e => e.id !== id));
  }, []);

  return (
    <EmployeesContext.Provider value={{
      employees,
      isLoading,
      error,
      addEmployee,
      updateEmployee,
      removeEmployee,
      refreshEmployees,
      setEmployees
    }}>
      {children}
    </EmployeesContext.Provider>
  );
};
</file>

<file path="src/features/hr/index.ts">
/**
 * HR feature exports
 */

export { EmployeesProvider, useEmployees } from './employees-context';
</file>

<file path="src/features/targets/components/index.ts">
/**
 * Target components exports
 */

export { TargetManagement } from './target-management';
export { TargetForm } from './target-form';
export { TargetListItem } from './target-list-item';
export { TargetToolbar } from './target-toolbar';
export { ShiftManager } from './shift-manager';
export { RosterEditor } from './roster-editor';
</file>

<file path="src/features/targets/components/roster-editor.tsx">
/**
 * Roster Editor Component
 * Edit employees and shifts in a target
 */

import React from 'react';
import { Plus, X } from 'lucide-react';
import { Employee, RosterItem } from '../../../types';
import { useShiftOptions } from '../hooks/use-shift-options';

interface RosterEditorProps {
  roster: RosterItem[];
  employees: Employee[];
  onChange: (roster: RosterItem[]) => void;
}

export const RosterEditor: React.FC<RosterEditorProps> = ({
  roster,
  employees,
  onChange
}) => {
  const { shiftOptions } = useShiftOptions();

  const addItem = () => {
    onChange([...roster, { employeeId: '', shift: '' }]);
  };

  const removeItem = (index: number) => {
    onChange(roster.filter((_, i) => i !== index));
  };

  const updateItem = (index: number, field: keyof RosterItem, value: string) => {
    const updated = [...roster];
    updated[index] = { ...updated[index], [field]: value };
    onChange(updated);
  };

  return (
    <div className="flex-1 overflow-y-auto p-6 bg-gray-50">
      <div className="flex justify-between items-end mb-2">
        <label className="block text-sm font-bold text-gray-700">Danh SÃ¡ch NhÃ¢n Sá»± & Ca Trá»±c</label>
        <button
          onClick={addItem}
          className="text-xs bg-green-100 text-green-700 px-2 py-1 rounded hover:bg-green-200 flex items-center"
        >
          <Plus size={12} className="mr-1" /> ThÃªm NhÃ¢n Sá»±
        </button>
      </div>

      <div className="space-y-2">
        {roster.map((item, index) => (
          <div key={index} className="flex gap-2 items-center bg-white p-2 rounded border shadow-sm">
            <div className="flex-1">
              <select
                value={item.employeeId}
                onChange={(e) => updateItem(index, 'employeeId', e.target.value)}
                className="w-full p-2 border rounded text-sm"
              >
                <option value="">-- Chá»n NhÃ¢n Sá»± --</option>
                {employees.map(emp => (
                  <option key={emp.id} value={emp.id}>{emp.name} ({emp.code})</option>
                ))}
              </select>
            </div>
            <div className="w-48">
              <input
                type="text"
                list={`shift-options-${index}`}
                value={item.shift}
                onChange={(e) => updateItem(index, 'shift', e.target.value)}
                placeholder="VD: 08h00 - 17h00"
                className="w-full p-2 border rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none"
              />
              <datalist id={`shift-options-${index}`}>
                {shiftOptions.map((shift) => (
                  <option key={shift} value={shift} />
                ))}
              </datalist>
            </div>
            <button onClick={() => removeItem(index)} className="text-gray-400 hover:text-red-500">
              <X size={18} />
            </button>
          </div>
        ))}
        {roster.length === 0 && (
          <div className="text-sm text-gray-400 italic text-center py-4 border-2 border-dashed rounded">
            ChÆ°a cÃ³ nhÃ¢n sá»± nÃ o trong má»¥c tiÃªu nÃ y.
          </div>
        )}
      </div>
    </div>
  );
};
</file>

<file path="src/features/targets/components/shift-manager.tsx">
/**
 * Shift Manager Component
 * Manages custom shift times
 */

import React, { useState } from 'react';
import { Clock, Plus, Save, X, Edit2 } from 'lucide-react';
import { useShiftOptions } from '../hooks/use-shift-options';

interface ShiftManagerProps {
  isOpen: boolean;
  onToggle: () => void;
}

export const ShiftManager: React.FC<ShiftManagerProps> = ({ isOpen, onToggle }) => {
  const { shiftOptions, customShifts, isLoading, addCustomShift, removeCustomShift, updateCustomShift } = useShiftOptions();

  const [newShiftStart, setNewShiftStart] = useState('08:00');
  const [newShiftEnd, setNewShiftEnd] = useState('17:00');
  const [editingIndex, setEditingIndex] = useState<number | null>(null);
  const [editStart, setEditStart] = useState('');
  const [editEnd, setEditEnd] = useState('');

  const handleAddShift = async () => {
    await addCustomShift(newShiftStart, newShiftEnd);
    setNewShiftStart('08:00');
    setNewShiftEnd('17:00');
  };

  const startEdit = (shift: string, index: number) => {
    const [start, end] = shift.split(' - ');
    setEditStart(start);
    setEditEnd(end);
    setEditingIndex(index);
  };

  const saveEdit = async (originalShift: string) => {
    try {
      await updateCustomShift(originalShift, `${editStart} - ${editEnd}`);
      setEditingIndex(null);
    } catch (err: any) {
      alert(err.message);
    }
  };

  return (
    <>
      <button
        onClick={onToggle}
        className="w-full mt-2 flex items-center justify-center gap-1 px-2 py-1.5 text-xs bg-orange-100 text-orange-700 rounded hover:bg-orange-200"
        title="Quáº£n lÃ½ khung giá» ca trá»±c"
      >
        <Clock size={12} /> Quáº£n LÃ½ Ca Trá»±c
      </button>

      {isOpen && (
        <div className="mt-2 p-3 bg-white border rounded-lg shadow-sm">
          <h4 className="text-sm font-semibold text-gray-700 mb-2 flex items-center">
            <Clock size={14} className="mr-1" /> Khung Giá» Ca Trá»±c
          </h4>

          {/* Add new shift */}
          <div className="flex gap-1 mb-2">
            <input
              type="time"
              value={newShiftStart}
              onChange={(e) => setNewShiftStart(e.target.value)}
              className="flex-1 px-2 py-1 text-xs border rounded"
            />
            <span className="text-gray-400 self-center">-</span>
            <input
              type="time"
              value={newShiftEnd}
              onChange={(e) => setNewShiftEnd(e.target.value)}
              className="flex-1 px-2 py-1 text-xs border rounded"
            />
            <button
              onClick={handleAddShift}
              className="px-2 py-1 bg-green-500 text-white rounded text-xs hover:bg-green-600"
              title="ThÃªm ca má»›i"
            >
              <Plus size={12} />
            </button>
          </div>

          {/* List of shifts */}
          <div className="max-h-48 overflow-y-auto space-y-1">
            {isLoading ? (
              <div className="text-xs text-gray-400 text-center py-2">Äang táº£i...</div>
            ) : (
              shiftOptions.map((shift, idx) => {
                const isCustom = customShifts.includes(shift);
                const isEditing = editingIndex === idx;

                return (
                  <div key={idx} className="flex items-center gap-1 text-xs bg-gray-50 px-2 py-1 rounded">
                    {isEditing ? (
                      <>
                        <input
                          type="time"
                          value={editStart}
                          onChange={(e) => setEditStart(e.target.value)}
                          className="flex-1 px-1 py-0.5 border rounded text-xs"
                        />
                        <span className="text-gray-400">-</span>
                        <input
                          type="time"
                          value={editEnd}
                          onChange={(e) => setEditEnd(e.target.value)}
                          className="flex-1 px-1 py-0.5 border rounded text-xs"
                        />
                        <button onClick={() => saveEdit(shift)} className="text-green-500 hover:text-green-700 p-0.5" title="LÆ°u">
                          <Save size={12} />
                        </button>
                        <button onClick={() => setEditingIndex(null)} className="text-gray-400 hover:text-gray-600 p-0.5" title="Há»§y">
                          <X size={12} />
                        </button>
                      </>
                    ) : (
                      <>
                        <span className={`flex-1 ${isCustom ? 'text-orange-600 font-medium' : 'text-gray-600'}`}>
                          {shift} {isCustom && '(tÃ¹y chá»‰nh)'}
                        </span>
                        <button onClick={() => startEdit(shift, idx)} className="text-blue-400 hover:text-blue-600 p-0.5" title="Sá»­a">
                          <Edit2 size={12} />
                        </button>
                        {isCustom && (
                          <button onClick={() => removeCustomShift(shift)} className="text-red-400 hover:text-red-600 p-0.5" title="XÃ³a">
                            <X size={12} />
                          </button>
                        )}
                      </>
                    )}
                  </div>
                );
              })
            )}
          </div>
        </div>
      )}
    </>
  );
};
</file>

<file path="src/features/targets/components/target-form.tsx">
/**
 * Target Form Component
 * Add/Edit target with roster
 */

import React, { useState, useEffect } from 'react';
import { Save, Trash2 } from 'lucide-react';
import { Target, Employee, RosterItem } from '../../../types';
import { RosterEditor } from './roster-editor';

interface TargetFormProps {
  target: Target | null;
  isCreating: boolean;
  employees: Employee[];
  onSave: (data: { name: string; roster: RosterItem[] }) => void;
  onDelete: () => void;
  onCancel: () => void;
}

export const TargetForm: React.FC<TargetFormProps> = ({
  target,
  isCreating,
  employees,
  onSave,
  onDelete,
  onCancel
}) => {
  const [name, setName] = useState('');
  const [roster, setRoster] = useState<RosterItem[]>([]);

  useEffect(() => {
    if (target) {
      setName(target.name);
      setRoster([...target.roster]);
    } else if (isCreating) {
      setName('Má»¥c TiÃªu Má»›i');
      setRoster([]);
    }
  }, [target, isCreating]);

  const handleSubmit = () => {
    if (!name.trim()) return;
    onSave({ name, roster });
  };

  return (
    <div className="flex flex-col h-full">
      <div className="p-6 border-b bg-white" style={{ borderBottomWidth: '1px', borderBottomColor: 'rgba(0, 112, 192, 1)' }}>
        <div className="flex justify-between items-center mb-4">
          <h2 className="text-xl font-bold text-gray-800">
            {isCreating ? 'ThÃªm Má»¥c TiÃªu Má»›i' : 'Chá»‰nh Sá»­a Má»¥c TiÃªu'}
          </h2>
          <button
            onClick={onDelete}
            disabled={isCreating}
            className="text-red-500 hover:bg-red-50 p-2 rounded disabled:opacity-0"
          >
            <Trash2 size={18} />
          </button>
        </div>

        <div className="mb-4">
          <label className="block text-sm font-medium text-gray-700 mb-1">TÃªn Má»¥c TiÃªu / Äá»‹a Äiá»ƒm</label>
          <input
            type="text"
            value={name}
            onChange={(e) => setName(e.target.value)}
            className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
            placeholder="VÃ­ dá»¥: Má»¥c tiÃªu Kho A"
          />
        </div>
      </div>

      <RosterEditor roster={roster} employees={employees} onChange={setRoster} />

      <div className="p-4 border-t bg-white flex justify-end space-x-2">
        <button onClick={onCancel} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">
          Há»§y
        </button>
        <button onClick={handleSubmit} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 flex items-center">
          <Save size={16} className="mr-2" /> LÆ°u Thay Äá»•i
        </button>
      </div>
    </div>
  );
};
</file>

<file path="src/features/targets/components/target-list-item.tsx">
/**
 * Target List Item Component
 * Single target row in the sidebar
 */

import React from 'react';
import { Users, Trash2 } from 'lucide-react';
import { Target } from '../../../types';

interface TargetListItemProps {
  target: Target;
  isSelected: boolean;
  onSelect: () => void;
  onDelete: () => void;
}

export const TargetListItem: React.FC<TargetListItemProps> = ({
  target,
  isSelected,
  onSelect,
  onDelete
}) => (
  <div
    className={`p-4 border-b hover:bg-blue-50 transition-colors flex items-center justify-between group ${
      isSelected ? 'bg-blue-100 border-l-4 border-l-blue-600' : ''
    }`}
  >
    <div onClick={onSelect} className="flex-1 cursor-pointer">
      <div className="font-semibold text-gray-800">{target.name}</div>
      <div className="text-xs text-gray-500 mt-1 flex items-center">
        <Users size={12} className="mr-1" /> {target.roster.length} nhÃ¢n sá»±
      </div>
    </div>
    <button
      onClick={(e) => {
        e.stopPropagation();
        onDelete();
      }}
      className="opacity-0 group-hover:opacity-100 transition-opacity text-red-500 hover:bg-red-50 p-1.5 rounded ml-2"
      title="XÃ³a má»¥c tiÃªu"
    >
      <Trash2 size={16} />
    </button>
  </div>
);
</file>

<file path="src/features/targets/components/target-management.tsx">
/**
 * Target Management Component
 * Main view for managing targets
 */

import React, { useState } from 'react';
import { MapPin, Plus } from 'lucide-react';
import { Target, Employee } from '../../../types';
import { TargetToolbar } from './target-toolbar';
import { ShiftManager } from './shift-manager';
import { TargetListItem } from './target-list-item';
import { TargetForm } from './target-form';

interface TargetManagementProps {
  targets: Target[];
  employees: Employee[];
  onUpdateTargets: (newTargets: Target[]) => void;
}

export const TargetManagement: React.FC<TargetManagementProps> = ({
  targets,
  employees,
  onUpdateTargets
}) => {
  const [editingTarget, setEditingTarget] = useState<Target | null>(null);
  const [isCreating, setIsCreating] = useState(false);
  const [importError, setImportError] = useState<string | null>(null);
  const [showShiftManager, setShowShiftManager] = useState(false);

  const handleCreate = () => {
    setIsCreating(true);
    setEditingTarget(null);
  };

  const handleEdit = (target: Target) => {
    setIsCreating(false);
    setEditingTarget(target);
  };

  const handleSave = (data: { name: string; roster: any[] }) => {
    const newTarget: Target = {
      id: editingTarget ? editingTarget.id : Math.random().toString(36).substr(2, 9),
      name: data.name,
      roster: data.roster
    };

    let updated: Target[];
    if (editingTarget) {
      updated = targets.map(t => t.id === editingTarget.id ? newTarget : t);
    } else {
      updated = [...targets, newTarget];
    }

    onUpdateTargets(updated);
    handleCancel();
  };

  const handleCancel = () => {
    setEditingTarget(null);
    setIsCreating(false);
  };

  const handleDelete = (id?: string) => {
    const targetId = id || editingTarget?.id;
    if (!targetId) return;

    if (confirm('Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a má»¥c tiÃªu nÃ y khÃ´ng?')) {
      onUpdateTargets(targets.filter(t => t.id !== targetId));
      if (editingTarget?.id === targetId) handleCancel();
    }
  };

  const handleImport = (imported: Target[], errors: string[]) => {
    if (errors.length > 0) {
      setImportError(errors.slice(0, 5).join('\n') + (errors.length > 5 ? `\n...vÃ  ${errors.length - 5} lá»—i khÃ¡c` : ''));
    } else {
      setImportError(null);
    }

    if (imported.length > 0) {
      const merged = [...targets];
      imported.forEach(t => {
        const idx = merged.findIndex(m => m.name === t.name);
        if (idx >= 0) merged[idx] = t;
        else merged.push(t);
      });
      onUpdateTargets(merged);
      alert(`ÄÃ£ nháº­p thÃ nh cÃ´ng ${imported.length} má»¥c tiÃªu!`);
    } else if (errors.length === 0) {
      setImportError('KhÃ´ng tÃ¬m tháº¥y má»¥c tiÃªu nÃ o trong file.');
    }
  };

  return (
    <div className="bg-white rounded-lg shadow-lg overflow-hidden h-full flex">
      {/* Left Sidebar */}
      <div className="w-1/3 border-r flex flex-col bg-gray-50">
        <div className="p-4 border-b bg-white">
          <div className="flex justify-between items-center mb-3">
            <h3 className="font-bold text-gray-700 flex items-center">
              <MapPin size={18} className="mr-2 text-blue-600" /> Danh SÃ¡ch Má»¥c TiÃªu
            </h3>
            <button
              onClick={handleCreate}
              className="p-1.5 bg-blue-100 text-blue-700 rounded hover:bg-blue-200"
            >
              <Plus size={16} />
            </button>
          </div>

          <TargetToolbar
            targets={targets}
            employees={employees}
            onImport={handleImport}
            onAdd={handleCreate}
          />

          <ShiftManager isOpen={showShiftManager} onToggle={() => setShowShiftManager(!showShiftManager)} />

          {importError && (
            <div className="mt-2 p-2 bg-red-50 border border-red-200 rounded text-xs text-red-600 whitespace-pre-line">
              {importError}
            </div>
          )}
        </div>

        <div className="flex-1 overflow-y-auto">
          {targets.map(target => (
            <TargetListItem
              key={target.id}
              target={target}
              isSelected={editingTarget?.id === target.id}
              onSelect={() => handleEdit(target)}
              onDelete={() => handleDelete(target.id)}
            />
          ))}
          {targets.length === 0 && (
            <div className="p-4 text-center text-gray-400 text-sm">ChÆ°a cÃ³ má»¥c tiÃªu nÃ o.</div>
          )}
        </div>
      </div>

      {/* Right Content */}
      <div className="w-2/3 flex flex-col">
        {(editingTarget || isCreating) ? (
          <TargetForm
            target={editingTarget}
            isCreating={isCreating}
            employees={employees}
            onSave={handleSave}
            onDelete={() => handleDelete()}
            onCancel={handleCancel}
          />
        ) : (
          <div className="flex-1 flex flex-col items-center justify-center text-gray-400">
            <MapPin size={48} className="mb-4 text-gray-300" />
            <p>Chá»n má»™t má»¥c tiÃªu Ä‘á»ƒ chá»‰nh sá»­a hoáº·c táº¡o má»›i.</p>
          </div>
        )}
      </div>
    </div>
  );
};
</file>

<file path="src/features/targets/components/target-toolbar.tsx">
/**
 * Target Toolbar Component
 * Import/Export buttons and actions
 */

import React, { useRef } from 'react';
import { Download, Upload, FileSpreadsheet, Plus } from 'lucide-react';
import { Target, Employee } from '../../../types';
import { exportTargetsToExcel, exportTargetsToJSON, importTargetsFromJSON, importTargetsFromExcel, downloadTargetTemplate } from '../../../utils/excel-export';

interface TargetToolbarProps {
  targets: Target[];
  employees: Employee[];
  onImport: (targets: Target[], errors: string[]) => void;
  onAdd: () => void;
}

export const TargetToolbar: React.FC<TargetToolbarProps> = ({
  targets,
  employees,
  onImport,
  onAdd
}) => {
  const fileInputRef = useRef<HTMLInputElement>(null);

  const handleFileImport = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    try {
      const isExcel = file.name.toLowerCase().endsWith('.xlsx') || file.name.toLowerCase().endsWith('.xls');
      let result: { targets: Target[]; errors: string[] };

      if (isExcel) {
        result = await importTargetsFromExcel(file, employees);
      } else {
        result = await importTargetsFromJSON(file);
      }

      onImport(result.targets, result.errors);
    } catch (err: any) {
      onImport([], [err.message]);
    }

    if (fileInputRef.current) fileInputRef.current.value = '';
  };

  return (
    <div className="flex gap-1">
      <button
        onClick={() => exportTargetsToExcel(targets, employees)}
        className="flex-1 flex items-center justify-center gap-1 px-2 py-1.5 text-xs bg-green-100 text-green-700 rounded hover:bg-green-200"
        title="Xuáº¥t Excel"
      >
        <Download size={12} /> Excel
      </button>
      <button
        onClick={() => exportTargetsToJSON(targets)}
        className="flex-1 flex items-center justify-center gap-1 px-2 py-1.5 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200"
        title="Xuáº¥t JSON (backup)"
      >
        <Download size={12} /> JSON
      </button>
      <button
        onClick={downloadTargetTemplate}
        className="flex-1 flex items-center justify-center gap-1 px-2 py-1.5 text-xs bg-gray-100 text-gray-700 rounded hover:bg-gray-200"
        title="Táº£i máº«u Excel"
      >
        <FileSpreadsheet size={12} /> Máº«u
      </button>
      <button
        onClick={() => fileInputRef.current?.click()}
        className="flex-1 flex items-center justify-center gap-1 px-2 py-1.5 text-xs bg-purple-100 text-purple-700 rounded hover:bg-purple-200"
        title="Nháº­p tá»« Excel hoáº·c JSON"
      >
        <Upload size={12} /> Nháº­p
      </button>
      <input
        ref={fileInputRef}
        type="file"
        accept=".json,.xlsx,.xls"
        onChange={handleFileImport}
        className="hidden"
      />
    </div>
  );
};
</file>

<file path="src/features/targets/hooks/use-shift-options.ts">
/**
 * Hook for managing shift options
 * Loads/saves custom shifts from Firebase
 */

import { useState, useEffect, useCallback } from 'react';
import { DEFAULT_SHIFTS, getCustomShifts, saveCustomShifts as saveShiftsToFirebase } from '../../../services/firebase';

export const useShiftOptions = () => {
  const [customShifts, setCustomShifts] = useState<string[]>([]);
  const [isLoading, setIsLoading] = useState(true);

  // Combined shift options (default + custom)
  const shiftOptions = [...DEFAULT_SHIFTS, ...customShifts];

  useEffect(() => {
    const loadShifts = async () => {
      try {
        const shifts = await getCustomShifts();
        setCustomShifts(shifts);
      } catch (error) {
        console.error('[useShiftOptions] Failed to load:', error);
      } finally {
        setIsLoading(false);
      }
    };
    loadShifts();
  }, []);

  const addCustomShift = useCallback(async (start: string, end: string) => {
    const newShift = `${start} - ${end}`;
    if (!shiftOptions.includes(newShift)) {
      const updated = [...customShifts, newShift];
      setCustomShifts(updated);
      await saveShiftsToFirebase(updated);
    }
  }, [customShifts, shiftOptions]);

  const removeCustomShift = useCallback(async (shift: string) => {
    const updated = customShifts.filter(s => s !== shift);
    setCustomShifts(updated);
    await saveShiftsToFirebase(updated);
  }, [customShifts]);

  const updateCustomShift = useCallback(async (oldShift: string, newShift: string) => {
    if (shiftOptions.includes(newShift) && newShift !== oldShift) {
      throw new Error('Ca nÃ y Ä‘Ã£ tá»“n táº¡i!');
    }

    const isCustom = customShifts.includes(oldShift);
    let updated: string[];

    if (isCustom) {
      updated = customShifts.map(s => s === oldShift ? newShift : s);
    } else {
      // "Edit" default shift = add new custom shift
      updated = [...customShifts, newShift];
    }

    setCustomShifts(updated);
    await saveShiftsToFirebase(updated);
  }, [customShifts, shiftOptions]);

  return {
    shiftOptions,
    customShifts,
    isLoading,
    addCustomShift,
    removeCustomShift,
    updateCustomShift
  };
};
</file>

<file path="src/features/targets/targets-context.tsx">
/**
 * Targets Context
 * Manages targets data and CRUD operations
 */

import React, { createContext, useContext, useState, useEffect, useCallback } from 'react';
import {
  getAllTargets,
  createTarget as createTgt,
  updateTarget as updateTgt,
  deleteTarget as deleteTgt
} from '../../services/realtime-database-service';
import type { Target } from '../../types';

interface TargetsContextType {
  targets: Target[];
  isLoading: boolean;
  error: string | null;
  addTarget: (data: Partial<Target>) => Promise<Target>;
  updateTarget: (id: string, data: Partial<Target>) => Promise<void>;
  removeTarget: (id: string) => Promise<void>;
  refreshTargets: () => Promise<void>;
  setTargets: React.Dispatch<React.SetStateAction<Target[]>>;
}

const TargetsContext = createContext<TargetsContextType | null>(null);

export const useTargets = () => {
  const context = useContext(TargetsContext);
  if (!context) throw new Error('useTargets must be used within TargetsProvider');
  return context;
};

export const TargetsProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [targets, setTargets] = useState<Target[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  const refreshTargets = useCallback(async () => {
    try {
      setIsLoading(true);
      const data = await getAllTargets();
      setTargets(data);
      setError(null);
    } catch (err) {
      console.error('[TargetsContext] Failed to load:', err);
      setError('KhÃ´ng thá»ƒ táº£i danh sÃ¡ch má»¥c tiÃªu');
    } finally {
      setIsLoading(false);
    }
  }, []);

  useEffect(() => {
    refreshTargets();
  }, [refreshTargets]);

  const addTarget = useCallback(async (data: Partial<Target>): Promise<Target> => {
    const newTarget = await createTgt(data);
    setTargets(prev => [...prev, newTarget]);
    return newTarget;
  }, []);

  const updateTarget = useCallback(async (id: string, data: Partial<Target>) => {
    await updateTgt(id, data);
    setTargets(prev => prev.map(t => t.id === id ? { ...t, ...data } : t));
  }, []);

  const removeTarget = useCallback(async (id: string) => {
    await deleteTgt(id);
    setTargets(prev => prev.filter(t => t.id !== id));
  }, []);

  return (
    <TargetsContext.Provider value={{
      targets,
      isLoading,
      error,
      addTarget,
      updateTarget,
      removeTarget,
      refreshTargets,
      setTargets
    }}>
      {children}
    </TargetsContext.Provider>
  );
};
</file>

<file path="src/features/timesheet/index.ts">
/**
 * Timesheet feature exports
 */

export { TimesheetProvider, useTimesheet } from './timesheet-context';
</file>

<file path="src/features/timesheet/timesheet-context.tsx">
/**
 * Timesheet Context
 * Manages timesheet grid data, year/month selection
 */

import React, { createContext, useContext, useState, useEffect, useCallback } from 'react';
import { getTimesheet, saveAllTimesheets } from '../../services/realtime-database-service';
import { useEmployees } from '../hr';
import type { Employee } from '../../types';

interface TimesheetContextType {
  gridData: Employee[];
  year: number;
  month: number;
  isLoading: boolean;
  setYear: (year: number) => void;
  setMonth: (month: number) => void;
  setGridData: React.Dispatch<React.SetStateAction<Employee[]>>;
  updateAttendance: (employeeId: string, day: number, value: string) => void;
  saveTimesheet: () => Promise<void>;
  refreshTimesheet: () => Promise<void>;
}

const TimesheetContext = createContext<TimesheetContextType | null>(null);

export const useTimesheet = () => {
  const context = useContext(TimesheetContext);
  if (!context) throw new Error('useTimesheet must be used within TimesheetProvider');
  return context;
};

export const TimesheetProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const { employees, isLoading: employeesLoading } = useEmployees();
  const [gridData, setGridData] = useState<Employee[]>([]);
  const [year, setYear] = useState(new Date().getFullYear());
  const [month, setMonth] = useState(new Date().getMonth());
  const [isLoading, setIsLoading] = useState(false);

  const loadTimesheet = useCallback(async () => {
    if (employees.length === 0) return;

    setIsLoading(true);
    try {
      const timesheetData = await getTimesheet(year, month + 1);
      const merged = employees.map(emp => {
        const ts = timesheetData.find((t: any) => t.employeeId === emp.id || t.id === emp.id);
        return { ...emp, attendance: ts?.attendance || {} };
      });
      setGridData(merged);
    } catch (err) {
      console.error('[TimesheetContext] Failed to load:', err);
    } finally {
      setIsLoading(false);
    }
  }, [year, month, employees]);

  // Load timesheet when employees loaded or month/year changes
  useEffect(() => {
    if (!employeesLoading && employees.length > 0) {
      loadTimesheet();
    }
  }, [loadTimesheet, employeesLoading, employees.length]);

  const updateAttendance = useCallback((employeeId: string, day: number, value: string) => {
    setGridData(prev => prev.map(emp =>
      emp.id === employeeId
        ? { ...emp, attendance: { ...emp.attendance, [day]: value } }
        : emp
    ));
  }, []);

  const saveTimesheet = useCallback(async () => {
    await saveAllTimesheets(year, month + 1, gridData);
  }, [year, month, gridData]);

  const refreshTimesheet = useCallback(async () => {
    await loadTimesheet();
  }, [loadTimesheet]);

  return (
    <TimesheetContext.Provider value={{
      gridData,
      year,
      month,
      isLoading: isLoading || employeesLoading,
      setYear,
      setMonth,
      setGridData,
      updateAttendance,
      saveTimesheet,
      refreshTimesheet
    }}>
      {children}
    </TimesheetContext.Provider>
  );
};
</file>

<file path="src/hooks/index.ts">
/**
 * Hooks barrel export
 */

// Auth
export { useAuth } from './use-auth'
export type { UseAuth } from './use-auth'

// Employees
export { useEmployees } from './use-employees'
export type { UseEmployees } from './use-employees'

// Targets
export { useTargets } from './use-targets'
export type { UseTargets } from './use-targets'

// Sheets Sync
export { useSheetsSync } from './use-sheets-sync'
export type { UseSheetsSync, SyncStatus } from './use-sheets-sync'

// Timesheet Hooks
export { useCellSelection } from './use-cell-selection'
export type { Selection } from './use-cell-selection'
export { useAutocomplete } from './use-autocomplete'
</file>

<file path="src/hooks/use-auth.ts">
/**
 * Authentication hook
 * Manages user login state and authentication
 */

import { useState, useCallback } from 'react'
import type { Employee } from '../types'

interface AuthState {
  isLoggedIn: boolean
  currentUser: Employee | null
}

export function useAuth(allEmployees: Employee[]) {
  const [state, setState] = useState<AuthState>({
    isLoggedIn: false,
    currentUser: null
  })

  const login = useCallback(async (code: string, password: string): Promise<void> => {
    const user = allEmployees.find(e => e.code === code && e.password === password)

    if (user) {
      setState({
        isLoggedIn: true,
        currentUser: user
      })
    } else {
      throw new Error("MÃ£ nhÃ¢n viÃªn hoáº·c máº­t kháº©u khÃ´ng Ä‘Ãºng.")
    }
  }, [allEmployees])

  const logout = useCallback(() => {
    setState({
      isLoggedIn: false,
      currentUser: null
    })
  }, [])

  return {
    ...state,
    login,
    logout
  }
}

export type UseAuth = ReturnType<typeof useAuth>
</file>

<file path="src/hooks/use-autocomplete.ts">
/**
 * Hook for autocomplete functionality in employee fields
 * Provides suggestions for code and name fields
 */

import { useState, useCallback, useEffect } from 'react';
import type { Employee } from '../types';

interface AutocompleteState {
  activeField: string | null; // empId-field format
  suggestions: Employee[];
  searchTerm: string;
}

interface UseAutocompleteProps {
  allEmployees: Employee[];
  data: Employee[];
  onDataChange: (newData: Employee[]) => void;
}

export function useAutocomplete({ allEmployees, data, onDataChange }: UseAutocompleteProps) {
  const [autocompleteState, setAutocompleteState] = useState<AutocompleteState>({
    activeField: null,
    suggestions: [],
    searchTerm: ''
  });

  // Track IME composition state (for Vietnamese/CJK input)
  const [isComposing, setIsComposing] = useState(false);

  const handleCompositionStart = useCallback(() => {
    setIsComposing(true);
  }, []);

  const handleCompositionEnd = useCallback(() => {
    setIsComposing(false);
  }, []);

  // Get suggestions based on search term and field type
  const getSuggestions = useCallback((searchTerm: string, field: 'code' | 'name'): Employee[] => {
    if (!searchTerm || searchTerm.length < 1) return [];

    const term = searchTerm.toLowerCase().trim();
    return allEmployees.filter(emp => {
      if (field === 'code') {
        return emp.code?.toLowerCase().includes(term);
      } else {
        return emp.name?.toLowerCase().includes(term);
      }
    }).slice(0, 5); // Limit to 5 suggestions
  }, [allEmployees]);

  // Handle input change with autocomplete
  const handleAutocompleteInput = useCallback((
    empId: string,
    field: 'code' | 'name',
    value: string,
    handleInfoChange: (empId: string, field: keyof Employee, value: string) => void
  ) => {
    // Always update the value
    handleInfoChange(empId, field, value);

    // Skip autocomplete suggestions during IME composition (Vietnamese/CJK input)
    if (isComposing) {
      return;
    }

    const suggestions = getSuggestions(value, field);
    setAutocompleteState({
      activeField: `${empId}-${field}`,
      suggestions,
      searchTerm: value
    });
  }, [getSuggestions, isComposing]);

  // Select a suggestion and fill employee details
  const selectSuggestion = useCallback((empId: string, field: 'code' | 'name', emp: Employee) => {
    const updates: Partial<Employee> = {
      code: emp.code,
      name: emp.name,
      department: emp.department
    };

    const newData = data.map(e => {
      if (e.id === empId) {
        return { ...e, ...updates };
      }
      return e;
    });
    onDataChange(newData);

    setAutocompleteState({
      activeField: null,
      suggestions: [],
      searchTerm: ''
    });
  }, [data, onDataChange]);

  // Handle field focus
  const handleFieldFocus = useCallback((empId: string, field: 'code' | 'name', currentValue: string) => {
    const suggestions = getSuggestions(currentValue, field);
    setAutocompleteState({
      activeField: `${empId}-${field}`,
      suggestions,
      searchTerm: currentValue
    });
  }, [getSuggestions]);

  // Handle field blur (with delay for click handling)
  const handleFieldBlur = useCallback((empId: string, field: 'code' | 'name') => {
    const fieldKey = `${empId}-${field}`;
    setTimeout(() => {
      setAutocompleteState(prev =>
        prev.activeField === fieldKey ? { ...prev, activeField: null } : prev
      );
    }, 200);
  }, []);

  // Close autocomplete when clicking outside
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as HTMLElement;
      if (!target.closest('.autocomplete-container')) {
        setAutocompleteState(prev => ({ ...prev, activeField: null }));
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  // Check if a specific field is active
  const isFieldActive = useCallback((empId: string, field: 'code' | 'name') => {
    return autocompleteState.activeField === `${empId}-${field}`;
  }, [autocompleteState.activeField]);

  return {
    autocompleteState,
    getSuggestions,
    handleAutocompleteInput,
    selectSuggestion,
    handleFieldFocus,
    handleFieldBlur,
    isFieldActive,
    // IME composition handlers for Vietnamese/CJK input
    handleCompositionStart,
    handleCompositionEnd,
  };
}
</file>

<file path="src/hooks/use-cell-selection.ts">
/**
 * Hook for managing cell selection in timesheet grid
 * Handles drag selection, keyboard shortcuts, copy/paste
 */

import { useState, useCallback, useEffect } from 'react';
import type { Employee, DayInfo } from '../types';

export interface Selection {
  startRow: number;
  startCol: number;
  endRow: number;
  endCol: number;
}

interface UseCellSelectionProps {
  data: Employee[];
  days: DayInfo[];
  onDataChange: (newData: Employee[]) => void;
}

export function useCellSelection({ data, days, onDataChange }: UseCellSelectionProps) {
  const [isSelecting, setIsSelecting] = useState(false);
  const [selection, setSelection] = useState<Selection | null>(null);

  // Mouse event handlers for drag selection
  const handleMouseDown = useCallback((rowIndex: number, colIndex: number, e: React.MouseEvent) => {
    if (e.button !== 0) return; // Only left click
    setIsSelecting(true);
    setSelection({
      startRow: rowIndex,
      startCol: colIndex,
      endRow: rowIndex,
      endCol: colIndex,
    });
  }, []);

  const handleCellClick = useCallback((rowIndex: number, colIndex: number) => {
    setSelection({
      startRow: rowIndex,
      startCol: colIndex,
      endRow: rowIndex,
      endCol: colIndex,
    });
  }, []);

  const handleMouseEnter = useCallback((rowIndex: number, colIndex: number) => {
    if (isSelecting && selection) {
      setSelection(prev => prev ? {
        ...prev,
        endRow: rowIndex,
        endCol: colIndex,
      } : null);
    }
  }, [isSelecting, selection]);

  const handleMouseUp = useCallback(() => {
    setIsSelecting(false);
  }, []);

  // Global mouseup listener
  useEffect(() => {
    window.addEventListener('mouseup', handleMouseUp);
    return () => window.removeEventListener('mouseup', handleMouseUp);
  }, [handleMouseUp]);

  // Check if cell is selected
  const isCellSelected = useCallback((rowIndex: number, colIndex: number) => {
    if (!selection) return false;
    const minRow = Math.min(selection.startRow, selection.endRow);
    const maxRow = Math.max(selection.startRow, selection.endRow);
    const minCol = Math.min(selection.startCol, selection.endCol);
    const maxCol = Math.max(selection.startCol, selection.endCol);
    return rowIndex >= minRow && rowIndex <= maxRow && colIndex >= minCol && colIndex <= maxCol;
  }, [selection]);

  // Copy selected cells to clipboard
  const copySelection = useCallback(() => {
    if (!selection) return;
    const minRow = Math.min(selection.startRow, selection.endRow);
    const maxRow = Math.max(selection.startRow, selection.endRow);
    const minCol = Math.min(selection.startCol, selection.endCol);
    const maxCol = Math.max(selection.startCol, selection.endCol);

    let clipboardText = "";
    for (let r = minRow; r <= maxRow; r++) {
      const rowData = [];
      for (let c = minCol; c <= maxCol; c++) {
        const day = days[c].date;
        rowData.push(data[r].attendance[day] || "");
      }
      clipboardText += rowData.join("\t") + (r < maxRow ? "\n" : "");
    }
    navigator.clipboard.writeText(clipboardText);
  }, [selection, data, days]);

  // Paste from clipboard
  const pasteSelection = useCallback(async () => {
    try {
      const text = await navigator.clipboard.readText();
      if (!text) return;

      const rows = text.split(/\r\n|\n|\r/);
      if (rows.length > 0 && rows[rows.length - 1] === "") rows.pop();

      const startRow = selection ? Math.min(selection.startRow, selection.endRow) : 0;
      const startCol = selection ? Math.min(selection.startCol, selection.endCol) : 0;

      const isSingleValue = rows.length === 1 && rows[0].split("\t").length === 1;
      const isMultiSelection = selection && (selection.startRow !== selection.endRow || selection.startCol !== selection.endCol);

      let newData = [...data];

      if (isSingleValue && isMultiSelection) {
        const val = rows[0].trim();
        const minRow = Math.min(selection!.startRow, selection!.endRow);
        const maxRow = Math.max(selection!.startRow, selection!.endRow);
        const minCol = Math.min(selection!.startCol, selection!.endCol);
        const maxCol = Math.max(selection!.startCol, selection!.endCol);

        for (let r = minRow; r <= maxRow; r++) {
          if (r >= newData.length) break;
          const emp = { ...newData[r], attendance: { ...newData[r].attendance } };
          for (let c = minCol; c <= maxCol; c++) {
            const day = days[c].date;
            emp.attendance[day] = val;
          }
          newData[r] = emp;
        }
      } else {
        rows.forEach((rowStr, rIdx) => {
          const cells = rowStr.split("\t");
          const targetRowIdx = startRow + rIdx;

          if (targetRowIdx < newData.length) {
            const emp = { ...newData[targetRowIdx], attendance: { ...newData[targetRowIdx].attendance } };
            cells.forEach((val, cIdx) => {
              const targetColIdx = startCol + cIdx;
              if (targetColIdx < days.length) {
                const day = days[targetColIdx].date;
                emp.attendance[day] = val.trim();
              }
            });
            newData[targetRowIdx] = emp;
          }
        });
      }

      onDataChange(newData);
    } catch (err) {
      console.error("Failed to read clipboard contents: ", err);
    }
  }, [selection, data, days, onDataChange]);

  // Fill selection with first cell value
  const fillSelection = useCallback(() => {
    if (!selection) return;
    const minRow = Math.min(selection.startRow, selection.endRow);
    const minCol = Math.min(selection.startCol, selection.endCol);
    const sourceVal = data[minRow].attendance[days[minCol].date] || "";
    const maxRow = Math.max(selection.startRow, selection.endRow);
    const maxCol = Math.max(selection.startCol, selection.endCol);

    const newData = data.map((emp, rIdx) => {
      if (rIdx >= minRow && rIdx <= maxRow) {
        const newAttendance = { ...emp.attendance };
        for (let c = minCol; c <= maxCol; c++) {
          const day = days[c].date;
          newAttendance[day] = sourceVal;
        }
        return { ...emp, attendance: newAttendance };
      }
      return emp;
    });

    onDataChange(newData);
  }, [selection, data, days, onDataChange]);

  // Clear selected cells
  const clearSelection = useCallback(() => {
    if (!selection) return;
    const minRow = Math.min(selection.startRow, selection.endRow);
    const maxRow = Math.max(selection.startRow, selection.endRow);
    const minCol = Math.min(selection.startCol, selection.endCol);
    const maxCol = Math.max(selection.startCol, selection.endCol);

    const newData = data.map((emp, rIdx) => {
      if (rIdx >= minRow && rIdx <= maxRow) {
        const newAtt = { ...emp.attendance };
        for (let c = minCol; c <= maxCol; c++) {
          const day = days[c].date;
          newAtt[day] = "";
        }
        return { ...emp, attendance: newAtt };
      }
      return emp;
    });
    onDataChange(newData);
  }, [selection, data, days, onDataChange]);

  // Keyboard shortcuts
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'c') {
        if (selection) {
          e.preventDefault();
          copySelection();
        }
      }
      if ((e.ctrlKey || e.metaKey) && e.key === 'v') {
        if (selection) {
          pasteSelection();
        }
      }
      if (e.key === 'Delete' || e.key === 'Backspace') {
        if (selection) {
          clearSelection();
        }
      }
    };
    document.addEventListener('keydown', handleKeyDown);
    return () => document.removeEventListener('keydown', handleKeyDown);
  }, [selection, copySelection, pasteSelection, clearSelection]);

  return {
    selection,
    isSelecting,
    handleMouseDown,
    handleMouseEnter,
    handleCellClick,
    isCellSelected,
    copySelection,
    pasteSelection,
    fillSelection,
    clearSelection,
  };
}
</file>

<file path="src/hooks/use-employees.ts">
/**
 * Employees hook
 * Manages employee CRUD operations and grid data
 */

import { useState, useCallback } from 'react'
import type { Employee } from '../types'

interface EmployeesState {
  allEmployees: Employee[]
  gridData: Employee[]
}

export function useEmployees(initialEmployees: Employee[], initialGridData: Employee[]) {
  const [state, setState] = useState<EmployeesState>({
    allEmployees: initialEmployees,
    gridData: initialGridData
  })

  const updateEmployee = useCallback((updatedEmp: Employee) => {
    setState(prev => ({
      allEmployees: prev.allEmployees.map(e => e.id === updatedEmp.id ? updatedEmp : e),
      gridData: prev.gridData.map(e => e.id === updatedEmp.id ? updatedEmp : e)
    }))
  }, [])

  const deleteEmployee = useCallback((empId: string) => {
    setState(prev => ({
      allEmployees: prev.allEmployees.filter(e => e.id !== empId),
      gridData: prev.gridData.filter(e => e.id !== empId)
    }))
  }, [])

  const addEmployee = useCallback((newEmp: Employee) => {
    setState(prev => ({
      allEmployees: [...prev.allEmployees, newEmp],
      gridData: [...prev.gridData, { ...newEmp, attendance: {} }]
    }))
  }, [])

  const setAllEmployees = useCallback((employees: Employee[]) => {
    setState(prev => ({
      ...prev,
      allEmployees: employees,
      gridData: employees
    }))
  }, [])

  const setGridData = useCallback((data: Employee[]) => {
    setState(prev => ({
      ...prev,
      gridData: data
    }))
  }, [])

  const mergeExtractedData = useCallback((extractedEmployees: Employee[]) => {
    setState(prev => {
      const updatedGridData = [...prev.gridData]
      const updatedAllEmployees = [...prev.allEmployees]

      extractedEmployees.forEach(extracted => {
        const existingInGrid = updatedGridData.findIndex(e => e.code === extracted.code)
        if (existingInGrid >= 0) {
          updatedGridData[existingInGrid] = {
            ...updatedGridData[existingInGrid],
            attendance: { ...updatedGridData[existingInGrid].attendance, ...extracted.attendance }
          }
        } else {
          updatedGridData.push(extracted)
        }

        const existingInMaster = updatedAllEmployees.findIndex(e => e.code === extracted.code)
        if (existingInMaster >= 0) {
          updatedAllEmployees[existingInMaster] = {
            ...updatedAllEmployees[existingInMaster],
            ...extracted
          }
        } else {
          updatedAllEmployees.push(extracted)
        }
      })

      return {
        allEmployees: updatedAllEmployees,
        gridData: updatedGridData
      }
    })
  }, [])

  return {
    ...state,
    updateEmployee,
    deleteEmployee,
    addEmployee,
    setAllEmployees,
    setGridData,
    mergeExtractedData
  }
}

export type UseEmployees = ReturnType<typeof useEmployees>
</file>

<file path="src/hooks/use-sheets-sync.ts">
/**
 * React hook for Google Sheets â†” Firebase sync
 * Provides sync state and manual sync trigger
 */

import { useState, useCallback, useEffect } from 'react'
import { syncFromSheets, getLastSyncTime, getSyncLogs, type SyncResult } from '../services/sync-service'
import { testSheetsConnection } from '../services/sheets-service'

export type SyncStatus = 'idle' | 'syncing' | 'success' | 'error' | 'disconnected'

interface SyncState {
  status: SyncStatus
  isSyncing: boolean
  lastSync: Date | null
  lastResult: SyncResult | null
  error: string | null
  isConnected: boolean
}

export function useSheetsSync() {
  const [state, setState] = useState<SyncState>({
    status: 'idle',
    isSyncing: false,
    lastSync: null,
    lastResult: null,
    error: null,
    isConnected: false
  })

  useEffect(() => {
    checkConnection()
    loadLastSyncTime()
  }, [])

  const checkConnection = useCallback(async () => {
    try {
      const result = await testSheetsConnection()
      setState(s => ({
        ...s,
        isConnected: result.success,
        status: result.success ? 'idle' : 'disconnected',
        error: result.success ? null : result.message
      }))
      return result.success
    } catch (error) {
      setState(s => ({
        ...s,
        isConnected: false,
        status: 'disconnected',
        error: 'Cannot connect to Google Sheets'
      }))
      return false
    }
  }, [])

  const loadLastSyncTime = useCallback(async () => {
    try {
      const lastSync = await getLastSyncTime()
      setState(s => ({ ...s, lastSync }))
    } catch (error) {
      console.error('Failed to load last sync time:', error)
    }
  }, [])

  const sync = useCallback(async (): Promise<SyncResult> => {
    setState(s => ({
      ...s,
      status: 'syncing',
      isSyncing: true,
      error: null
    }))

    try {
      const result = await syncFromSheets()

      setState(s => ({
        ...s,
        status: result.success ? 'success' : 'error',
        isSyncing: false,
        lastSync: result.timestamp,
        lastResult: result,
        error: result.errors.length > 0 ? result.errors[0] : null
      }))

      return result
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : 'Sync failed'

      setState(s => ({
        ...s,
        status: 'error',
        isSyncing: false,
        error: errorMessage
      }))

      throw error
    }
  }, [])

  const resetStatus = useCallback(() => {
    setState(s => ({
      ...s,
      status: s.isConnected ? 'idle' : 'disconnected',
      error: null
    }))
  }, [])

  const getSyncHistory = useCallback(async (limit: number = 5) => {
    return getSyncLogs(limit)
  }, [])

  return {
    ...state,
    sync,
    checkConnection,
    resetStatus,
    getSyncHistory,
    refreshLastSync: loadLastSyncTime
  }
}

export type UseSheetsSync = ReturnType<typeof useSheetsSync>
</file>

<file path="src/hooks/use-targets.ts">
/**
 * Targets hook
 * Manages target (work location) operations
 */

import { useState, useCallback } from 'react'
import type { Target } from '../types'

export function useTargets(initialTargets: Target[]) {
  const [targets, setTargets] = useState<Target[]>(initialTargets)

  const updateTargets = useCallback((newTargets: Target[]) => {
    setTargets(newTargets)
  }, [])

  const addTarget = useCallback((target: Target) => {
    setTargets(prev => [...prev, target])
  }, [])

  const removeTarget = useCallback((targetId: string) => {
    setTargets(prev => prev.filter(t => t.id !== targetId))
  }, [])

  const updateTarget = useCallback((updatedTarget: Target) => {
    setTargets(prev => prev.map(t => t.id === updatedTarget.id ? updatedTarget : t))
  }, [])

  return {
    targets,
    setTargets,
    updateTargets,
    addTarget,
    removeTarget,
    updateTarget
  }
}

export type UseTargets = ReturnType<typeof useTargets>
</file>

<file path="src/index.tsx">
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App';

const rootElement = document.getElementById('root');
if (!rootElement) {
  throw new Error("Could not find root element to mount to");
}

const root = ReactDOM.createRoot(rootElement);
root.render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);
</file>

<file path="src/lib/firebase.ts">
/**
 * Firebase Realtime Database initialization
 * Uses environment variables for configuration
 * Gracefully degrades if config is missing (app works with local data only)
 */
import { initializeApp, FirebaseApp } from 'firebase/app'
import { getDatabase, Database } from 'firebase/database'

// Hardcoded config with fallbacks for production deployment
const firebaseConfig = {
  apiKey: import.meta.env.VITE_FIREBASE_API_KEY || 'AIzaSyDxfBzknZibS5e96YZZhxL7Rm2R00FQO7k',
  authDomain: import.meta.env.VITE_FIREBASE_AUTH_DOMAIN || 'bachho-timesheet-2025.firebaseapp.com',
  databaseURL: import.meta.env.VITE_FIREBASE_DATABASE_URL || 'https://bachho-timesheet-2025-default-rtdb.asia-southeast1.firebasedatabase.app',
  projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID || 'bachho-timesheet-2025',
  storageBucket: import.meta.env.VITE_FIREBASE_STORAGE_BUCKET || 'bachho-timesheet-2025.firebasestorage.app',
  messagingSenderId: import.meta.env.VITE_FIREBASE_MESSAGING_SENDER_ID || '254498018198',
  appId: import.meta.env.VITE_FIREBASE_APP_ID || '1:254498018198:web:dfbdc63a710b8b37f2c3b7',
}

// Check if essential config is present
const isConfigValid = !!(
  firebaseConfig.apiKey &&
  firebaseConfig.databaseURL &&
  firebaseConfig.projectId
)

// Initialize Firebase (only if config is valid)
let app: FirebaseApp | null = null
let db: Database | null = null
let firebaseError: string | null = null

if (isConfigValid) {
  try {
    app = initializeApp(firebaseConfig)
    db = getDatabase(app)
  } catch (error) {
    console.error('Firebase initialization error:', error)
    firebaseError = error instanceof Error ? error.message : 'Unknown error'
  }
} else {
  console.warn(
    'âš ï¸ Firebase not configured. App will work with local data only.\n' +
    'To enable Firebase, add these to your .env file:\n' +
    '  VITE_FIREBASE_API_KEY=...\n' +
    '  VITE_FIREBASE_DATABASE_URL=...\n' +
    '  VITE_FIREBASE_PROJECT_ID=...'
  )
}

// Helper to check if Firebase is available
export const isFirebaseAvailable = (): boolean => db !== null

// Get Firebase error message if any
export const getFirebaseError = (): string | null => firebaseError

export { app, db }
</file>

<file path="src/services/backup-service.ts">
/**
 * Backup Service
 * Creates downloadable JSON backups from Firebase Realtime Database
 */

import { getAllEmployees, getAllTargets } from './firebase'
import { isFirebaseAvailable } from '../lib/firebase'

interface BackupData {
  exportedAt: string
  version: string
  data: {
    employees: any[]
    targets: any[]
  }
}

/**
 * Create a full backup as JSON Blob
 */
export async function exportAsJson(): Promise<Blob> {
  const [employees, targets] = await Promise.all([
    getAllEmployees(),
    getAllTargets()
  ])

  const backup: BackupData = {
    exportedAt: new Date().toISOString(),
    version: '1.0',
    data: {
      employees,
      targets
    }
  }

  return new Blob(
    [JSON.stringify(backup, null, 2)],
    { type: 'application/json' }
  )
}

/**
 * Trigger browser download of backup file
 */
export function downloadBackup(blob: Blob, filename?: string): void {
  const url = URL.createObjectURL(blob)
  const a = document.createElement('a')
  a.href = url
  a.download = filename || `bachho-backup-${new Date().toISOString().split('T')[0]}.json`
  document.body.appendChild(a)
  a.click()
  document.body.removeChild(a)
  URL.revokeObjectURL(url)
}

/**
 * One-click backup: export and download
 */
export async function createAndDownloadBackup(): Promise<void> {
  const blob = await exportAsJson()
  downloadBackup(blob)
}
</file>

<file path="src/services/firebase/employee-service.ts">
/**
 * Firebase Employee Service
 * CRUD operations for employees in Firebase Realtime Database
 */
import { ref, get, set, update, remove, push } from 'firebase/database'
import { db, isFirebaseAvailable } from '../../lib/firebase'
import type { Employee } from '../../types'

// Helper to get database reference
const getDb = () => {
  if (!isFirebaseAvailable() || !db) {
    throw new Error('Firebase not configured. Please set up .env file.')
  }
  return db
}

export async function getAllEmployees(): Promise<Employee[]> {
  if (!isFirebaseAvailable()) return []

  const database = getDb()
  const snapshot = await get(ref(database, 'employees'))
  if (!snapshot.exists()) return []

  const data = snapshot.val()
  return Object.keys(data).map(key => ({
    id: key,
    attendance: {}, // Ensure attendance is always initialized
    ...data[key]
  }))
}

export async function getEmployeeById(id: string): Promise<Employee | null> {
  if (!isFirebaseAvailable()) return null

  const database = getDb()
  const snapshot = await get(ref(database, `employees/${id}`))
  if (!snapshot.exists()) return null
  return { id, attendance: {}, ...snapshot.val() }
}

export async function createEmployee(employee: Omit<Employee, 'id'>): Promise<string> {
  const database = getDb()
  const newRef = push(ref(database, 'employees'))
  const id = newRef.key!
  await set(newRef, { ...employee, id })
  return id
}

export async function updateEmployee(id: string, updates: Partial<Employee>): Promise<void> {
  const database = getDb()
  await update(ref(database, `employees/${id}`), updates)
}

export async function deleteEmployee(id: string): Promise<void> {
  const database = getDb()
  await remove(ref(database, `employees/${id}`))
}
</file>

<file path="src/services/firebase/index.ts">
/**
 * Firebase services barrel export
 * Re-exports all Firebase-related services
 */

// Employee operations
export {
  getAllEmployees,
  getEmployeeById,
  createEmployee,
  updateEmployee,
  deleteEmployee
} from './employee-service'

// Target operations
export {
  getAllTargets,
  getTargetById,
  createTarget,
  updateTarget,
  deleteTarget
} from './target-service'

// Timesheet operations
export {
  getTimesheet,
  saveTimesheet,
  saveAllTimesheets,
  importInitialData
} from './timesheet-service'

// Shift operations
export {
  DEFAULT_SHIFTS,
  getCustomShifts,
  saveCustomShifts,
  addCustomShift,
  removeCustomShift,
  getAllShifts
} from './shift-service'
</file>

<file path="src/services/firebase/shift-service.ts">
/**
 * Shift Service
 * CRUD operations for custom shifts in Firebase Realtime Database
 */

import { ref, get, set } from 'firebase/database';
import { db } from '../../lib/firebase';

const SHIFTS_PATH = 'settings/shifts';

// Default shift options (24h format)
export const DEFAULT_SHIFTS = [
  '06:00 - 14:00',
  '08:00 - 17:00',
  '14:00 - 22:00',
  '18:00 - 06:00',
  '22:00 - 06:00',
  '00:00 - 08:00',
  '12:00 - 20:00',
  '20:00 - 04:00'
];

/**
 * Get all custom shifts from Firebase
 */
export const getCustomShifts = async (): Promise<string[]> => {
  if (!db) {
    console.warn('[ShiftService] Firebase not available');
    return [];
  }

  try {
    const shiftsRef = ref(db, SHIFTS_PATH);
    const snapshot = await get(shiftsRef);

    if (snapshot.exists()) {
      const data = snapshot.val();
      // Data is stored as { 0: "shift1", 1: "shift2", ... } or array
      if (Array.isArray(data)) {
        return data.filter(s => s); // filter out null/undefined
      }
      return Object.values(data).filter(s => s) as string[];
    }
    return [];
  } catch (error) {
    console.error('[ShiftService] Failed to get custom shifts:', error);
    return [];
  }
};

/**
 * Save custom shifts to Firebase
 */
export const saveCustomShifts = async (shifts: string[]): Promise<void> => {
  if (!db) {
    console.warn('[ShiftService] Firebase not available');
    return;
  }

  try {
    const shiftsRef = ref(db, SHIFTS_PATH);
    await set(shiftsRef, shifts);
    console.log('[ShiftService] Custom shifts saved:', shifts.length, 'shifts');
  } catch (error) {
    console.error('[ShiftService] Failed to save custom shifts:', error);
    throw error;
  }
};

/**
 * Add a new custom shift
 */
export const addCustomShift = async (shift: string): Promise<string[]> => {
  const currentShifts = await getCustomShifts();

  // Check if shift already exists
  if (currentShifts.includes(shift) || DEFAULT_SHIFTS.includes(shift)) {
    return currentShifts;
  }

  const updatedShifts = [...currentShifts, shift];
  await saveCustomShifts(updatedShifts);
  return updatedShifts;
};

/**
 * Remove a custom shift
 */
export const removeCustomShift = async (shift: string): Promise<string[]> => {
  const currentShifts = await getCustomShifts();
  const updatedShifts = currentShifts.filter(s => s !== shift);
  await saveCustomShifts(updatedShifts);
  return updatedShifts;
};

/**
 * Get all shifts (default + custom)
 */
export const getAllShifts = async (): Promise<string[]> => {
  const customShifts = await getCustomShifts();
  return [...DEFAULT_SHIFTS, ...customShifts];
};
</file>

<file path="src/services/firebase/target-service.ts">
/**
 * Firebase Target Service
 * CRUD operations for targets in Firebase Realtime Database
 */
import { ref, get, set, update, remove, push } from 'firebase/database'
import { db, isFirebaseAvailable } from '../../lib/firebase'
import type { Target } from '../../types'

// Helper to get database reference
const getDb = () => {
  if (!isFirebaseAvailable() || !db) {
    throw new Error('Firebase not configured. Please set up .env file.')
  }
  return db
}

export async function getAllTargets(): Promise<Target[]> {
  if (!isFirebaseAvailable()) return []

  const database = getDb()
  const snapshot = await get(ref(database, 'targets'))
  if (!snapshot.exists()) return []

  const data = snapshot.val()
  return Object.keys(data).map(key => ({
    id: key,
    ...data[key],
    roster: data[key].roster ? Object.values(data[key].roster) : []
  }))
}

export async function getTargetById(id: string): Promise<Target | null> {
  if (!isFirebaseAvailable()) return null

  const database = getDb()
  const snapshot = await get(ref(database, `targets/${id}`))
  if (!snapshot.exists()) return null
  const data = snapshot.val()
  return {
    id,
    ...data,
    roster: data.roster ? Object.values(data.roster) : []
  }
}

export async function createTarget(target: Omit<Target, 'id'>): Promise<string> {
  const database = getDb()
  const newRef = push(ref(database, 'targets'))
  const id = newRef.key!
  await set(newRef, { ...target, id })
  return id
}

export async function updateTarget(id: string, updates: Partial<Target>): Promise<void> {
  const database = getDb()
  await update(ref(database, `targets/${id}`), updates)
}

export async function deleteTarget(id: string): Promise<void> {
  const database = getDb()
  await remove(ref(database, `targets/${id}`))
}
</file>

<file path="src/services/firebase/timesheet-service.ts">
/**
 * Firebase Timesheet Service
 * CRUD operations for timesheets in Firebase Realtime Database
 */
import { ref, get, set, update } from 'firebase/database'
import { db, isFirebaseAvailable } from '../../lib/firebase'
import type { Employee, Target } from '../../types'

// Helper to get database reference
const getDb = () => {
  if (!isFirebaseAvailable() || !db) {
    throw new Error('Firebase not configured. Please set up .env file.')
  }
  return db
}

export async function getTimesheet(year: number, month: number): Promise<Employee[]> {
  if (!isFirebaseAvailable()) return []

  const database = getDb()
  const snapshot = await get(ref(database, `timesheets/${year}/${month}`))
  if (!snapshot.exists()) return []

  const data = snapshot.val()
  return Object.keys(data).map(key => ({
    id: key,
    ...data[key]
  }))
}

export async function saveTimesheet(
  year: number,
  month: number,
  employeeId: string,
  data: Partial<Employee>
): Promise<void> {
  const database = getDb()
  await set(ref(database, `timesheets/${year}/${month}/${employeeId}`), data)
}

export async function saveAllTimesheets(
  year: number,
  month: number,
  employees: Employee[]
): Promise<void> {
  const database = getDb()
  const updates: Record<string, any> = {}
  employees.forEach(emp => {
    updates[`timesheets/${year}/${month}/${emp.id}`] = emp
  })
  await update(ref(database), updates)
}

/**
 * Batch import initial data to Firebase
 */
export async function importInitialData(data: {
  employees?: Record<string, Employee>
  targets?: Record<string, Target>
  timesheets?: Record<string, Record<string, Record<string, Employee>>>
}): Promise<void> {
  const database = getDb()
  const updates: Record<string, any> = {}

  if (data.employees) {
    updates['employees'] = data.employees
  }
  if (data.targets) {
    updates['targets'] = data.targets
  }
  if (data.timesheets) {
    updates['timesheets'] = data.timesheets
  }

  await update(ref(database), updates)
}
</file>

<file path="src/services/gemini-service.ts">
/**
 * Gemini AI Service
 * Handles AI-powered timesheet analysis and data generation
 */
import { GoogleGenAI } from "@google/genai";
import { Employee } from '../types';

// API Key from environment variable
const API_KEY = import.meta.env.VITE_GEMINI_API_KEY;

if (!API_KEY) {
    console.warn('VITE_GEMINI_API_KEY not set in environment');
}

// Create AI client
const getAiClient = () => {
    if (!API_KEY) {
        throw new Error('Gemini API key not configured. Please set VITE_GEMINI_API_KEY in .env');
    }
    return new GoogleGenAI({ apiKey: API_KEY });
};

// Parse error response for better error messages
const handleApiError = (error: any): never => {
    console.error("Gemini Error:", error);

    const errorMessage = error?.message || error?.toString() || '';
    const errorCode = error?.status || error?.code || error?.statusCode;
    const errorData = error?.response?.data || error?.data || {};

    // Check for invalid API key error (400)
    const isInvalidKeyError =
        errorCode === 400 ||
        errorData?.error?.code === 400 ||
        errorMessage.toLowerCase().includes('api key not valid') ||
        errorMessage.toLowerCase().includes('invalid api key') ||
        errorMessage.toLowerCase().includes('authentication');

    if (isInvalidKeyError) {
        throw new Error("âš ï¸ API KEY KHÃ”NG Há»¢P Lá»†! Vui lÃ²ng liÃªn há»‡ admin.");
    }

    // Check for quota exceeded (429)
    const isQuotaError =
        errorCode === 429 ||
        errorData?.error?.code === 429 ||
        errorMessage.toLowerCase().includes('quota') ||
        errorMessage.toLowerCase().includes('exceeded') ||
        errorMessage.toLowerCase().includes('resource_exhausted') ||
        errorData?.error?.status === 'RESOURCE_EXHAUSTED';

    if (isQuotaError) {
        throw new Error(
            "âš ï¸ ÄÃƒ VÆ¯á»¢T QUÃ GIá»šI Háº N Sá»¬ Dá»¤NG API!\n\n" +
            "Vui lÃ²ng Ä‘á»£i má»™t lÃºc rá»“i thá»­ láº¡i."
        );
    }

    throw new Error(errorMessage || "Lá»—i khi xá»­ lÃ½ yÃªu cáº§u. Vui lÃ²ng thá»­ láº¡i.");
};

// Analyze timesheet with Gemini AI
export const analyzeTimesheet = async (employees: Employee[], month: number, year: number) => {
    const ai = getAiClient();

    const dataSummary = employees.map(e => ({
        name: e.name,
        dept: e.department,
        attendance: e.attendance
    }));

    const prompt = `
        Báº¡n lÃ  má»™t trá»£ lÃ½ HR chuyÃªn nghiá»‡p. HÃ£y phÃ¢n tÃ­ch dá»¯ liá»‡u báº£ng cháº¥m cÃ´ng thÃ¡ng ${month + 1}/${year} sau Ä‘Ã¢y.
        Dá»¯ liá»‡u (JSON): ${JSON.stringify(dataSummary)}

        Nhiá»‡m vá»¥:
        1. TÃ¬m ra ai Ä‘i lÃ m Ä‘áº§y Ä‘á»§ nháº¥t (chÄƒm chá»‰).
        2. TÃ¬m ra ai nghá»‰ nhiá»u nháº¥t hoáº·c cÃ³ pattern láº¡.
        3. ÄÆ°a ra má»™t nháº­n xÃ©t ngáº¯n gá»n vá» tÃ¬nh hÃ¬nh nhÃ¢n sá»± thÃ¡ng nÃ y báº±ng tiáº¿ng Viá»‡t.
        4. Tráº£ vá» Ä‘á»‹nh dáº¡ng JSON thuáº§n tÃºy (khÃ´ng markdown) vá»›i cáº¥u trÃºc:
        {
            "topPerformer": string,
            "absenteeismAlert": string,
            "summary": string
        }
    `;

    try {
        const response = await ai.models.generateContent({
            model: 'gemini-2.5-flash',
            contents: prompt,
            config: {
                responseMimeType: "application/json"
            }
        });
        return JSON.parse(response.text || "{}");
    } catch (error: any) {
        return handleApiError(error);
    }
};

// Generate fake employee data with Gemini AI
export const autoFillData = async (count: number, month: number, year: number): Promise<Employee[]> => {
    const ai = getAiClient();
    const prompt = `
        Táº¡o dá»¯ liá»‡u giáº£ láº­p cho ${count} nhÃ¢n viÃªn Viá»‡t Nam cho báº£ng cháº¥m cÃ´ng thÃ¡ng ${month + 1}/${year}.
        Cáº¥u trÃºc JSON mong muá»‘n cho má»—i nhÃ¢n viÃªn:
        {
            "id": "random_string",
            "code": "3 digit number",
            "name": "Full Vietnamese Name",
            "department": "VÄƒn PhÃ²ng" hoáº·c "Káº¿ ToÃ¡n",
            "shift": "08h00 - 17h00",
            "attendance": { "1": "1", "2": "1", ... "day": "value" }
        }

        Quy táº¯c cháº¥m cÃ´ng:
        - Thá»© 7, Chá»§ nháº­t Ä‘iá»n "CN" hoáº·c Ä‘á»ƒ trá»‘ng náº¿u nghá»‰.
        - NgÃ y thÆ°á»ng Ä‘iá»n "1" (full cÃ´ng) hoáº·c "0.5" (ná»­a cÃ´ng) hoáº·c "P" (phÃ©p).
        - HÃ£y lÃ m cho dá»¯ liá»‡u trÃ´ng tá»± nhiÃªn (háº§u háº¿t lÃ  1).

        Tráº£ vá» máº£ng JSON.
    `;

    try {
        const response = await ai.models.generateContent({
            model: 'gemini-2.5-flash',
            contents: prompt,
            config: {
                responseMimeType: "application/json"
            }
        });
        return JSON.parse(response.text || "[]");
    } catch (error: any) {
        return handleApiError(error);
    }
};

// Test API connection
export const testApiConnection = async (): Promise<{ success: boolean; message: string }> => {
    try {
        const ai = getAiClient();
        const response = await ai.models.generateContent({
            model: 'gemini-2.5-flash',
            contents: 'Tráº£ lá»i "OK" náº¿u báº¡n nháº­n Ä‘Æ°á»£c tin nháº¯n nÃ y.',
        });

        if (response.text) {
            return { success: true, message: 'Káº¿t ná»‘i API thÃ nh cÃ´ng!' };
        }
        return { success: false, message: 'API khÃ´ng tráº£ vá» pháº£n há»“i.' };
    } catch (error: any) {
        return {
            success: false,
            message: error.message || 'KhÃ´ng thá»ƒ káº¿t ná»‘i API.'
        };
    }
};
</file>

<file path="src/services/index.ts">
/**
 * Services barrel export
 * Re-exports all service functions
 */

// Firebase services
export * from './firebase'

// Google Sheets service
export {
  readSheetData,
  sheetRowToEmployee,
  hasApiKey,
  getSheetMetadata,
  testSheetsConnection
} from './sheets-service'
export type { SheetRow, SheetMetadata } from './sheets-service'

// Gemini AI service
export { analyzeTimesheet, autoFillData, testApiConnection } from './gemini-service'

// Sync service
export {
  syncFromSheets,
  getSyncLogs,
  getLastSyncTime,
  clearSyncLogs
} from './sync-service'
export type { SyncResult } from './sync-service'

// Backup service
export { exportAsJson, downloadBackup, createAndDownloadBackup } from './backup-service'
</file>

<file path="src/services/realtime-database-service.ts">
/**
 * @deprecated Import from './firebase' directory instead
 * This file is kept for backward compatibility
 */

// Re-export all from new modular structure
export {
  // Employees
  getAllEmployees,
  getEmployeeById,
  createEmployee,
  updateEmployee,
  deleteEmployee,
  // Targets
  getAllTargets,
  getTargetById,
  createTarget,
  updateTarget,
  deleteTarget,
  // Timesheets
  getTimesheet,
  saveTimesheet,
  saveAllTimesheets,
  importInitialData
} from './firebase'
</file>

<file path="src/services/sheets-service.ts">
/**
 * Google Sheets Service
 * Reads timesheet data from Google Sheets
 * Supports API mode (with key) and CSV export mode (public sheets)
 */

// Sheet configuration
const SHEETS_ID = import.meta.env.VITE_GOOGLE_SHEETS_ID || '174JidXU87O9QZnkD0qfwvYimPpj8STIqIJgzVDyPQkM'
const API_KEY = import.meta.env.VITE_GOOGLE_API_KEY
// GID is the tab ID in Google Sheets (from URL gid=xxx)
const SHEETS_GID = import.meta.env.VITE_GOOGLE_SHEETS_GID || '1964190322'

// Sheet row structure from spreadsheet
export interface SheetRow {
  rowIndex: number
  employeeCode: string
  employeeName: string
  department: string
  shift: string
  attendance: Record<number, string> // day -> value
  lastModified?: string
}

// Sheet metadata
export interface SheetMetadata {
  title: string
  headers: string[]
  rowCount: number
  lastUpdated?: string
}

/**
 * Check if API key is configured
 */
export function hasApiKey(): boolean {
  return !!(SHEETS_ID && API_KEY)
}

/**
 * Read sheet data via CSV export (no API key needed)
 */
async function readSheetDataViaCsv(): Promise<SheetRow[]> {
  if (!SHEETS_ID) {
    throw new Error('Missing VITE_GOOGLE_SHEETS_ID in .env')
  }

  const csvUrl = `https://docs.google.com/spreadsheets/d/${SHEETS_ID}/export?format=csv&gid=${SHEETS_GID}`

  try {
    const response = await fetch(csvUrl)

    if (!response.ok) {
      throw new Error(`Cannot access sheet. Status: ${response.status}. Make sure the sheet is shared via link.`)
    }

    const csvText = await response.text()
    const rows = parseCsv(csvText)

    return rows.slice(1)
      .map((row, index) => parseSheetRow(row, index + 2))
      .filter(row => row.employeeCode || row.employeeName)
  } catch (error) {
    console.error('Failed to read sheet via CSV:', error)
    throw error
  }
}

/**
 * Simple CSV parser
 */
function parseCsv(csvText: string): string[][] {
  const lines = csvText.split('\n')
  const rows: string[][] = []

  for (const line of lines) {
    if (!line.trim()) continue

    const row: string[] = []
    let current = ''
    let inQuotes = false

    for (let i = 0; i < line.length; i++) {
      const char = line[i]

      if (char === '"') {
        if (inQuotes && line[i + 1] === '"') {
          current += '"'
          i++
        } else {
          inQuotes = !inQuotes
        }
      } else if (char === ',' && !inQuotes) {
        row.push(current.trim())
        current = ''
      } else {
        current += char
      }
    }
    row.push(current.trim())
    rows.push(row)
  }

  return rows
}

/**
 * Read sheet data via Sheets API
 */
async function readSheetDataViaApi(range: string): Promise<SheetRow[]> {
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEETS_ID}/values/${encodeURIComponent(range)}?key=${API_KEY}`

  const response = await fetch(url)

  if (!response.ok) {
    const error = await response.json().catch(() => ({}))
    throw new Error(
      error.error?.message || `Sheets API error: ${response.status}`
    )
  }

  const data = await response.json()
  const rows: string[][] = data.values || []

  return rows
    .map((row, index) => parseSheetRow(row, index + 2))
    .filter(row => row.employeeCode || row.employeeName)
}

/**
 * Read all employee rows from Google Sheet
 * Auto-selects method based on available config
 */
export async function readSheetData(
  range: string = 'Sheet1!A2:AG100'
): Promise<SheetRow[]> {
  if (!SHEETS_ID) {
    throw new Error('Missing VITE_GOOGLE_SHEETS_ID in .env')
  }

  try {
    if (hasApiKey()) {
      return await readSheetDataViaApi(range)
    } else {
      console.log('No API key configured, using CSV export method')
      return await readSheetDataViaCsv()
    }
  } catch (error) {
    console.error('Failed to read sheet:', error)
    throw error
  }
}

/**
 * Parse a raw sheet row into structured data
 */
function parseSheetRow(row: string[], rowIndex: number): SheetRow {
  const [code, name, department, shift, ...rest] = row

  const attendance: Record<number, string> = {}
  for (let i = 0; i < 31 && i < rest.length; i++) {
    const value = rest[i]?.trim()
    if (value) {
      attendance[i + 1] = value
    }
  }

  const lastModified = rest.length > 31 ? rest[31] : undefined

  return {
    rowIndex,
    employeeCode: code?.trim() || '',
    employeeName: name?.trim() || '',
    department: department?.trim() || '',
    shift: shift?.trim() || '',
    attendance,
    lastModified
  }
}

/**
 * Get sheet metadata
 */
export async function getSheetMetadata(): Promise<SheetMetadata> {
  if (!SHEETS_ID || !API_KEY) {
    throw new Error('Missing Google Sheets config')
  }

  const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEETS_ID}?key=${API_KEY}`

  try {
    const response = await fetch(url)
    if (!response.ok) {
      throw new Error(`Sheets API error: ${response.status}`)
    }

    const data = await response.json()
    const sheet = data.sheets?.[0]
    const title = sheet?.properties?.title || 'Sheet1'
    const rowCount = sheet?.properties?.gridProperties?.rowCount || 0

    const headersUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEETS_ID}/values/${encodeURIComponent(`${title}!A1:AG1`)}?key=${API_KEY}`
    const headersResponse = await fetch(headersUrl)
    const headersData = await headersResponse.json()
    const headers = headersData.values?.[0] || []

    return { title, headers, rowCount }
  } catch (error) {
    console.error('Failed to get sheet metadata:', error)
    throw error
  }
}

/**
 * Convert Sheet row to Employee format
 */
export function sheetRowToEmployee(row: SheetRow): {
  code: string
  name: string
  department: string
  shift: string
  attendance: Record<number, string>
} {
  return {
    code: row.employeeCode,
    name: row.employeeName,
    department: row.department,
    shift: row.shift,
    attendance: row.attendance
  }
}

/**
 * Test connection
 */
export async function testSheetsConnection(): Promise<{
  success: boolean
  message: string
  metadata?: SheetMetadata
}> {
  if (!SHEETS_ID) {
    return {
      success: false,
      message: 'Thiáº¿u VITE_GOOGLE_SHEETS_ID trong .env'
    }
  }

  if (hasApiKey()) {
    try {
      const metadata = await getSheetMetadata()
      return {
        success: true,
        message: `Connected via API: ${metadata.title} (${metadata.rowCount} rows)`,
        metadata
      }
    } catch (error) {
      return {
        success: false,
        message: error instanceof Error ? error.message : 'Failed to connect'
      }
    }
  }

  return {
    success: true,
    message: 'Ready to sync via CSV export'
  }
}
</file>

<file path="src/services/sync-service.ts">
/**
 * Sync Service
 * Google Sheets â†” Firebase Realtime Database sync
 * Source of truth: Google Sheets
 */

import { ref, set, get } from 'firebase/database'
import { db, isFirebaseAvailable } from '../lib/firebase'
import { readSheetData, sheetRowToEmployee, type SheetRow } from './sheets-service'
import { getAllEmployees, createEmployee, updateEmployee } from './firebase'
import type { Employee } from '../types'

// Sync result
export interface SyncResult {
  success: boolean
  timestamp: Date
  imported: number
  updated: number
  skipped: number
  errors: string[]
  duration: number
}

// Sync log entry
interface SyncLog {
  id: string
  timestamp: string
  direction: 'sheets_to_firebase' | 'firebase_to_sheets'
  result: 'success' | 'partial' | 'failed'
  imported: number
  updated: number
  errors: string[]
}

/**
 * Main sync: Pull data from Google Sheets to Firebase
 */
export async function syncFromSheets(): Promise<SyncResult> {
  const startTime = Date.now()
  const result: SyncResult = {
    success: false,
    timestamp: new Date(),
    imported: 0,
    updated: 0,
    skipped: 0,
    errors: [],
    duration: 0
  }

  try {
    // 1. Read data from Google Sheets
    const sheetRows = await readSheetData()
    console.log(`[Sync] Read ${sheetRows.length} rows from Sheets`)

    // 2. Get current Firebase employees
    const firebaseEmployees = await getAllEmployees()
    const employeeByCode = new Map(
      firebaseEmployees.map(e => [e.code, e])
    )

    // 3. Process each sheet row
    for (const row of sheetRows) {
      if (!row.employeeCode) continue

      try {
        const sheetData = sheetRowToEmployee(row)
        const existing = employeeByCode.get(row.employeeCode)

        if (!existing) {
          // New employee
          await createEmployee({
            code: sheetData.code,
            name: sheetData.name,
            department: sheetData.department,
            shift: sheetData.shift,
            attendance: sheetData.attendance,
            role: 'staff'
          })
          result.imported++
        } else {
          // Existing employee - check for changes
          const hasChanges = hasDataChanged(existing, sheetData)

          if (hasChanges) {
            await updateEmployee(existing.id, {
              name: sheetData.name,
              department: sheetData.department,
              shift: sheetData.shift,
              attendance: sheetData.attendance
            })
            result.updated++
          } else {
            result.skipped++
          }
        }
      } catch (error) {
        result.errors.push(`Row ${row.rowIndex}: ${error}`)
      }
    }

    // 4. Log sync
    await logSync({
      direction: 'sheets_to_firebase',
      result: result.errors.length > 0 ? 'partial' : 'success',
      imported: result.imported,
      updated: result.updated,
      errors: result.errors
    })

    result.success = true
    result.duration = Date.now() - startTime
    console.log(`[Sync] Complete: ${result.imported} imported, ${result.updated} updated, ${result.skipped} skipped`)

    return result
  } catch (error) {
    result.errors.push(`Sync failed: ${error}`)
    result.duration = Date.now() - startTime

    await logSync({
      direction: 'sheets_to_firebase',
      result: 'failed',
      imported: 0,
      updated: 0,
      errors: result.errors
    })

    return result
  }
}

/**
 * Check if Sheet data differs from Firebase data
 */
function hasDataChanged(
  firebase: Employee,
  sheet: ReturnType<typeof sheetRowToEmployee>
): boolean {
  if (firebase.name !== sheet.name) return true
  if (firebase.department !== sheet.department) return true
  if (firebase.shift !== sheet.shift) return true

  const fbDays = Object.keys(firebase.attendance || {})
  const sheetDays = Object.keys(sheet.attendance || {})

  if (fbDays.length !== sheetDays.length) return true

  for (const day of sheetDays) {
    if (firebase.attendance?.[Number(day)] !== sheet.attendance[Number(day)]) {
      return true
    }
  }

  return false
}

/**
 * Log sync operation
 */
async function logSync(log: Omit<SyncLog, 'id' | 'timestamp'>): Promise<void> {
  if (!isFirebaseAvailable() || !db) {
    console.log('[Sync] Log skipped - Firebase not configured')
    return
  }

  try {
    const logId = Date.now().toString()
    const logRef = ref(db, `sync_logs/${logId}`)

    await set(logRef, {
      id: logId,
      timestamp: new Date().toISOString(),
      ...log
    })
  } catch (error) {
    console.error('Failed to log sync:', error)
  }
}

/**
 * Get recent sync logs
 */
export async function getSyncLogs(limit: number = 10): Promise<SyncLog[]> {
  if (!isFirebaseAvailable() || !db) return []

  try {
    const logsRef = ref(db, 'sync_logs')
    const snapshot = await get(logsRef)

    if (!snapshot.exists()) return []

    const data = snapshot.val()
    const logs: SyncLog[] = Object.keys(data)
      .map(key => data[key])
      .sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime())
      .slice(0, limit)

    return logs
  } catch (error) {
    console.error('Failed to get sync logs:', error)
    return []
  }
}

/**
 * Get last sync timestamp
 */
export async function getLastSyncTime(): Promise<Date | null> {
  const logs = await getSyncLogs(1)
  if (logs.length === 0) return null
  return new Date(logs[0].timestamp)
}

/**
 * Clear all sync logs
 */
export async function clearSyncLogs(): Promise<void> {
  if (!isFirebaseAvailable() || !db) return

  try {
    await set(ref(db, 'sync_logs'), null)
  } catch (error) {
    console.error('Failed to clear sync logs:', error)
    throw error
  }
}
</file>

<file path="src/test/mocks/handlers.ts">
import { http, HttpResponse } from 'msw'

export const handlers = [
  // Mock Gemini API
  http.post('https://generativelanguage.googleapis.com/*', () => {
    return HttpResponse.json({
      candidates: [{ content: { parts: [{ text: 'Mocked response' }] } }]
    })
  }),
]
</file>

<file path="src/test/mocks/server.ts">
import { setupServer } from 'msw/node'
import { handlers } from './handlers'

export const server = setupServer(...handlers)
</file>

<file path="src/types/employee.ts">
/**
 * Employee domain types
 * Includes basic info, authentication, and payroll fields
 */

export interface Employee {
  id: string;
  code: string; // MSNV
  name: string; // Há» vÃ  tÃªn
  department: string; // Má»¥c TiÃªu / Ten_muc_tieu
  shift: string; // Thá»i Gian / Giá»/ngÃ y - e.g., "08h00 - 17h00"
  attendance: Record<number, string>; // Day number -> attendance value

  // Authentication
  password?: string;
  role?: 'admin' | 'staff';

  // Banking
  bankAccount?: string; // So_tai_khoan

  // Payroll fields - Salary components
  dailyRate?: number; // LÆ°Æ¡ng theo ngÃ y
  standardHours?: number; // Gio_cong_chuan
  shiftSalary?: number; // Luong_ca
  responsibilitySalary?: number; // Luong_trach_nhiem
  supportSalary?: number; // Luong_ho_tro
  managementSalary?: number; // Luong_quan_ly

  // Payroll fields - Deductions & Advances
  advance1?: number; // Ung_luong_lan1
  advance2?: number; // Ung_luong_lan2
  advance3?: number; // Ung_luong_lan3
  refund?: number; // Hoan_tien
  socialInsurance?: number; // BHXH
  uniform?: number; // Dong_phuc

  // Legacy payroll fields
  bonus?: number; // ThÆ°á»Ÿng (legacy)
  penalty?: number; // Tien_phat
  note?: string; // Ghi_chu
}
</file>

<file path="src/types/index.ts">
/**
 * Central type exports
 * Re-exports all domain types for convenient imports
 */

export type { Employee } from './employee';
export type { Target, RosterItem } from './target';
export type { DayInfo, CellValue, AppState } from './timesheet';
</file>

<file path="src/types/target.ts">
/**
 * Target (Má»¥c TiÃªu) domain types
 * Represents work locations with assigned employees
 */

export interface RosterItem {
  employeeId: string;
  shift: string;
}

export interface Target {
  id: string;
  name: string;
  roster: RosterItem[];
}
</file>

<file path="src/types/timesheet.ts">
/**
 * Timesheet domain types
 * Calendar and attendance-related types
 */

import type { Employee } from './employee';

export interface DayInfo {
  date: number;
  dayOfWeek: string;
  isWeekend: boolean;
}

export type CellValue = string;

export interface AppState {
  month: number;
  year: number;
  employees: Employee[];
}
</file>

<file path="src/utils/auth.ts">
/**
 * Simple password hashing utilities
 * Note: For production, use bcrypt or argon2
 */

/**
 * Hash a password using simple base64 encoding with salt
 * This is for demo purposes - use proper hashing in production
 */
export function hashPassword(password: string): string {
  const salt = 'bachho_security_salt'
  const combined = password + salt + password.split('').reverse().join('')
  return btoa(combined)
}

/**
 * Verify a password against a hashed value
 */
export function verifyPassword(input: string, hashed: string): boolean {
  return hashPassword(input) === hashed
}
</file>

<file path="src/utils/date-helpers.ts">
/**
 * Date helper utilities
 * Functions for date manipulation and calculations
 */

import type { DayInfo } from '../types';

/**
 * Generate days info for a specific month
 * @param year - Year number
 * @param month - Month number (0-indexed)
 * @returns Array of day information objects
 */
export const generateDaysInfo = (year: number, month: number): DayInfo[] => {
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const DAYS_OF_WEEK_EN = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  const result: DayInfo[] = [];

  for (let i = 1; i <= daysInMonth; i++) {
    const date = new Date(year, month, i);
    const dayIndex = date.getDay();
    result.push({
      date: i,
      dayOfWeek: DAYS_OF_WEEK_EN[dayIndex],
      isWeekend: dayIndex === 0 || dayIndex === 6,
    });
  }
  return result;
};

/**
 * Calculate total attendance value from attendance record
 * @param attendance - Record of day number to attendance value
 * @returns Total attendance as number
 */
export const calculateAttendanceTotal = (attendance: Record<number, string>): number => {
  let total = 0;
  Object.values(attendance).forEach((val) => {
    const num = parseFloat(val);
    if (!isNaN(num)) {
      total += num;
    }
  });
  return total;
};
</file>

<file path="src/utils/excel-export.ts">
/**
 * @deprecated Import from './excel' directory instead
 * This file is kept for backward compatibility
 */

// Re-export all from new modular structure
export {
  // Timesheet
  exportToExcel,
  exportToExcelStyled,
  importTimesheetFromExcel,
  downloadTimesheetTemplate,
  // Employee
  exportEmployeesToExcel,
  importEmployeesFromExcel,
  downloadEmployeeTemplate,
  // Target
  exportTargetsToExcel,
  exportTargetsToJSON,
  importTargetsFromJSON,
  importTargetsFromExcel,
  downloadTargetTemplate,
  // Payroll
  exportPayrollToExcel
} from './excel';
</file>

<file path="src/utils/excel/common.ts">
/**
 * Common Excel utilities
 * Shared helper functions for Excel operations
 */

import type { DayInfo } from '../../types';

/**
 * Generate days info for Excel header
 */
export const generateDaysInfo = (year: number, month: number): DayInfo[] => {
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const DAYS_OF_WEEK_EN = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  const result: DayInfo[] = [];

  for (let i = 1; i <= daysInMonth; i++) {
    const date = new Date(year, month, i);
    const dayIndex = date.getDay();
    result.push({
      date: i,
      dayOfWeek: DAYS_OF_WEEK_EN[dayIndex],
      isWeekend: dayIndex === 0 || dayIndex === 6,
    });
  }
  return result;
};

/**
 * Calculate total attendance value
 */
export const calculateTotal = (attendance: Record<number, string>): number => {
  let total = 0;
  Object.values(attendance).forEach((val) => {
    const num = parseFloat(val);
    if (!isNaN(num)) {
      total += num;
    }
  });
  return total;
};
</file>

<file path="src/utils/excel/employee-excel.ts">
/**
 * Employee Excel operations
 * Export and import employee/HR data
 */

import * as XLSX from 'xlsx';
import type { Employee } from '../../types';

/**
 * Export employees list to Excel
 */
export const exportEmployeesToExcel = (
  employees: Employee[],
  filename?: string
): void => {
  const defaultFilename = `DanhSachNhanSu_${new Date().toISOString().slice(0, 10)}.xlsx`;

  const wsData: (string | number)[][] = [];

  // Title
  wsData.push(['DANH SÃCH NHÃ‚N Sá»° - Báº CH Há»” SECURITY']);
  wsData.push([`Xuáº¥t ngÃ y: ${new Date().toLocaleDateString('vi-VN')}`]);
  wsData.push([]);

  // Headers
  wsData.push(['STT', 'MÃ£ NV', 'Há» TÃªn', 'PhÃ²ng Ban', 'Quyá»n Háº¡n', 'Máº­t Kháº©u']);

  // Data rows
  employees.forEach((emp, index) => {
    wsData.push([
      index + 1,
      emp.code || '',
      emp.name || '',
      emp.department || '',
      emp.role === 'admin' ? 'Quáº£n Trá»‹' : 'NhÃ¢n ViÃªn',
      emp.password || ''
    ]);
  });

  // Summary
  wsData.push([]);
  wsData.push([`Tá»•ng sá»‘: ${employees.length} nhÃ¢n viÃªn`]);

  const ws = XLSX.utils.aoa_to_sheet(wsData);
  ws['!cols'] = [
    { wch: 5 },
    { wch: 10 },
    { wch: 25 },
    { wch: 15 },
    { wch: 12 },
    { wch: 12 }
  ];

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'NhÃ¢n Sá»±');
  XLSX.writeFile(wb, filename || defaultFilename);
};

/**
 * Download employee import template
 */
export const downloadEmployeeTemplate = (): void => {
  const wsData: (string | number)[][] = [];

  // Title
  wsData.push(['MáºªU NHáº¬P DANH SÃCH NHÃ‚N Sá»°']);
  wsData.push(['HÆ°á»›ng dáº«n: Äiá»n thÃ´ng tin tá»« dÃ²ng 5 trá»Ÿ Ä‘i, khÃ´ng xÃ³a dÃ²ng header']);
  wsData.push([]);

  // Headers
  wsData.push(['STT', 'MÃ£ NV', 'Há» TÃªn', 'PhÃ²ng Ban', 'Quyá»n Háº¡n', 'Máº­t Kháº©u', 'ÄÆ¡n GiÃ¡']);

  // Sample data rows
  wsData.push([1, '001', 'Nguyá»…n VÄƒn A', 'VÄƒn PhÃ²ng', 'NhÃ¢n ViÃªn', '123', 200000]);
  wsData.push([2, '002', 'Tráº§n Thá»‹ B', 'Ká»¹ Thuáº­t', 'Quáº£n Trá»‹', '456', 250000]);
  wsData.push([3, '', '', '', '', '', '']);

  // Instructions
  wsData.push([]);
  wsData.push(['GHI CHÃš:']);
  wsData.push(['- MÃ£ NV: Báº¯t buá»™c, khÃ´ng trÃ¹ng vá»›i nhÃ¢n viÃªn Ä‘Ã£ cÃ³']);
  wsData.push(['- Há» TÃªn: Báº¯t buá»™c']);
  wsData.push(['- PhÃ²ng Ban: TÃ¹y chá»n, máº·c Ä‘á»‹nh "VÄƒn PhÃ²ng". Náº¿u má»¥c tiÃªu chÆ°a cÃ³ sáº½ tá»± Ä‘á»™ng táº¡o má»›i']);
  wsData.push(['- Quyá»n Háº¡n: "Quáº£n Trá»‹" hoáº·c "NhÃ¢n ViÃªn" (máº·c Ä‘á»‹nh)']);
  wsData.push(['- Máº­t Kháº©u: TÃ¹y chá»n, máº·c Ä‘á»‹nh lÃ  "123"']);
  wsData.push(['- ÄÆ¡n GiÃ¡: GiÃ¡ tiá»n má»—i cÃ´ng, máº·c Ä‘á»‹nh 200,000 VNÄ']);
  wsData.push(['- ThÆ°á»Ÿng/Pháº¡t: Nháº­p riÃªng theo thÃ¡ng táº¡i trang Quáº£n lÃ½ NhÃ¢n sá»±']);

  const ws = XLSX.utils.aoa_to_sheet(wsData);
  ws['!cols'] = [
    { wch: 5 },
    { wch: 10 },
    { wch: 25 },
    { wch: 15 },
    { wch: 12 },
    { wch: 12 },
    { wch: 12 }
  ];

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Máº«u NhÃ¢n Sá»±');
  XLSX.writeFile(wb, 'Mau_NhapNhanSu.xlsx');
};

/**
 * Import employees from Excel file
 */
export const importEmployeesFromExcel = (
  file: File,
  existingEmployees: Employee[]
): Promise<{ employees: Employee[]; errors: string[] }> => {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();

    reader.onload = (e) => {
      try {
        const data = new Uint8Array(e.target?.result as ArrayBuffer);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 }) as any[][];

        const employees: Employee[] = [];
        const errors: string[] = [];

        // Find header row
        let headerRowIndex = -1;
        let codeColIndex = -1;
        let nameColIndex = -1;
        let deptColIndex = -1;
        let roleColIndex = -1;
        let passColIndex = -1;
        let dailyRateColIndex = -1;

        for (let i = 0; i < Math.min(10, jsonData.length); i++) {
          const row = jsonData[i];
          if (!row) continue;

          for (let j = 0; j < row.length; j++) {
            const cell = String(row[j] || '').toLowerCase();
            if (cell.includes('mÃ£')) codeColIndex = j;
            if (cell.includes('tÃªn') || cell.includes('há»')) nameColIndex = j;
            if (cell.includes('phÃ²ng') || cell.includes('ban')) deptColIndex = j;
            if (cell.includes('quyá»n')) roleColIndex = j;
            if (cell.includes('máº­t') || cell.includes('kháº©u')) passColIndex = j;
            if ((cell.includes('lÆ°Æ¡ng') && cell.includes('ngÃ y')) || cell.includes('Ä‘Æ¡n giÃ¡')) dailyRateColIndex = j;
          }

          if (codeColIndex >= 0 && nameColIndex >= 0) {
            headerRowIndex = i;
            break;
          }
        }

        if (headerRowIndex < 0) {
          resolve({ employees: [], errors: ['KhÃ´ng tÃ¬m tháº¥y header há»£p lá»‡. File cáº§n cÃ³ cá»™t "MÃ£ NV" vÃ  "Há» TÃªn".'] });
          return;
        }

        // Parse data rows
        for (let i = headerRowIndex + 1; i < jsonData.length; i++) {
          const row = jsonData[i];
          if (!row || row.length === 0) continue;

          const code = String(row[codeColIndex] || '').trim();
          const name = String(row[nameColIndex] || '').trim();

          if (!code && !name) continue;

          if (!code) {
            errors.push(`DÃ²ng ${i + 1}: Thiáº¿u mÃ£ nhÃ¢n viÃªn`);
            continue;
          }

          if (!name) {
            errors.push(`DÃ²ng ${i + 1}: Thiáº¿u há» tÃªn`);
            continue;
          }

          if (existingEmployees.some(e => e.code === code)) {
            errors.push(`DÃ²ng ${i + 1}: MÃ£ "${code}" Ä‘Ã£ tá»“n táº¡i`);
            continue;
          }

          const roleStr = String(row[roleColIndex] || '').toLowerCase();
          const role: 'admin' | 'staff' = roleStr.includes('quáº£n') || roleStr.includes('admin') ? 'admin' : 'staff';

          const dailyRate = dailyRateColIndex >= 0 ? parseInt(String(row[dailyRateColIndex] || '')) || 200000 : 200000;

          employees.push({
            id: Math.random().toString(36).substr(2, 9),
            code,
            name,
            department: deptColIndex >= 0 ? String(row[deptColIndex] || 'VÄƒn PhÃ²ng') : 'VÄƒn PhÃ²ng',
            shift: '08:00 - 17:00',
            attendance: {},
            password: passColIndex >= 0 ? String(row[passColIndex] || '123') : '123',
            role,
            dailyRate
          });
        }

        resolve({ employees, errors });
      } catch (err) {
        reject(new Error('KhÃ´ng thá»ƒ Ä‘á»c file Excel. Vui lÃ²ng kiá»ƒm tra Ä‘á»‹nh dáº¡ng file.'));
      }
    };

    reader.onerror = () => reject(new Error('Lá»—i Ä‘á»c file'));
    reader.readAsArrayBuffer(file);
  });
};
</file>

<file path="src/utils/excel/index.ts">
/**
 * Excel utilities barrel export
 * Re-exports all Excel-related functions
 */

// Timesheet operations
export {
  exportToExcel,
  exportToExcelStyled,
  importTimesheetFromExcel,
  downloadTimesheetTemplate
} from './timesheet-excel';

// Employee/HR operations
export {
  exportEmployeesToExcel,
  importEmployeesFromExcel,
  downloadEmployeeTemplate
} from './employee-excel';

// Target operations
export {
  exportTargetsToExcel,
  exportTargetsToJSON,
  importTargetsFromJSON,
  importTargetsFromExcel,
  downloadTargetTemplate
} from './target-excel';

// Payroll operations
export { exportPayrollToExcel } from './payroll-excel';

// Common utilities (for internal use)
export { generateDaysInfo, calculateTotal } from './common';
</file>

<file path="src/utils/excel/payroll-excel.ts">
/**
 * Payroll Excel operations
 * Export payroll/salary data
 */

import * as XLSX from 'xlsx';
import type { Employee } from '../../types';
import { calculateTotal } from './common';

/**
 * Export payroll data to Excel
 * Headers: ShiftID, Thang_luong, STT, Ho_va_ten, So_tai_khoan, Ten_muc_tieu, Gio_cong_chuan,
 *          Luong_ca, Luong_trach_nhiem, Luong_ho_tro, Luong_quan_ly, Tien_thuong, Tong_luong,
 *          Ung_luong_lan1, Ung_luong_lan2, Ung_luong_lan3, Hoan_tien, BHXH, Dong_phuc,
 *          Tien_phat, Tong_con_nhan, Ghi_chu
 */
export const exportPayrollToExcel = (
  employees: Employee[],
  year: number,
  month: number,
  defaultDailyRate: number = 200000,
  filename?: string
): void => {
  const monthName = `Thang${month + 1}`;
  const defaultFilename = `BangLuong_${monthName}_${year}.xlsx`;

  const wsData: (string | number)[][] = [];

  // Title
  wsData.push([`Báº¢NG LÆ¯Æ NG THÃNG ${month + 1}/${year} - Báº CH Há»” SECURITY`]);
  wsData.push([`NgÃ y xuáº¥t: ${new Date().toLocaleDateString('vi-VN')}`]);
  wsData.push([]);

  // Headers - New format with bonus
  wsData.push([
    'ShiftID',
    'Thang_luong',
    'STT',
    'Ho_va_ten',
    'So_tai_khoan',
    'Ten_muc_tieu',
    'Gio_cong_chuan',
    'Luong_ca',
    'Luong_trach_nhiem',
    'Luong_ho_tro',
    'Luong_quan_ly',
    'Tien_thuong',
    'Tong_luong',
    'Ung_luong_lan1',
    'Ung_luong_lan2',
    'Ung_luong_lan3',
    'Hoan_tien',
    'BHXH',
    'Dong_phuc',
    'Tien_phat',
    'Tong_con_nhan',
    'Ghi_chu'
  ]);

  // Data rows
  let totalSalary = 0;
  let totalBonus = 0;
  let totalAdvance1 = 0;
  let totalAdvance2 = 0;
  let totalAdvance3 = 0;
  let totalRefund = 0;
  let totalBHXH = 0;
  let totalUniform = 0;
  let totalPenalty = 0;
  let totalNetReceived = 0;

  employees.forEach((emp, index) => {
    const standardHours = emp.standardHours || calculateTotal(emp.attendance);
    const shiftSalary = emp.shiftSalary || (standardHours * (emp.dailyRate || defaultDailyRate));
    const responsibilitySalary = emp.responsibilitySalary || 0;
    const supportSalary = emp.supportSalary || 0;
    const managementSalary = emp.managementSalary || 0;
    const bonus = emp.bonus || 0;
    const totalGrossSalary = shiftSalary + responsibilitySalary + supportSalary + managementSalary + bonus;

    const advance1 = emp.advance1 || 0;
    const advance2 = emp.advance2 || 0;
    const advance3 = emp.advance3 || 0;
    const refund = emp.refund || 0;
    const socialInsurance = emp.socialInsurance || 0;
    const uniform = emp.uniform || 0;
    const penalty = emp.penalty || 0;

    const totalDeductions = advance1 + advance2 + advance3 + socialInsurance + uniform + penalty - refund;
    const netReceived = totalGrossSalary - totalDeductions;

    totalSalary += totalGrossSalary;
    totalBonus += bonus;
    totalAdvance1 += advance1;
    totalAdvance2 += advance2;
    totalAdvance3 += advance3;
    totalRefund += refund;
    totalBHXH += socialInsurance;
    totalUniform += uniform;
    totalPenalty += penalty;
    totalNetReceived += netReceived;

    wsData.push([
      emp.shift || '08:00 - 17:00', // ShiftID
      `${month + 1}/${year}`, // Thang_luong
      index + 1, // STT
      emp.name || '', // Ho_va_ten
      emp.bankAccount || '', // So_tai_khoan
      emp.department || '', // Ten_muc_tieu
      standardHours, // Gio_cong_chuan
      shiftSalary, // Luong_ca
      responsibilitySalary, // Luong_trach_nhiem
      supportSalary, // Luong_ho_tro
      managementSalary, // Luong_quan_ly
      bonus, // Tien_thuong
      totalGrossSalary, // Tong_luong
      advance1, // Ung_luong_lan1
      advance2, // Ung_luong_lan2
      advance3, // Ung_luong_lan3
      refund, // Hoan_tien
      socialInsurance, // BHXH
      uniform, // Dong_phuc
      penalty, // Tien_phat
      netReceived, // Tong_con_nhan
      emp.note || '' // Ghi_chu
    ]);
  });

  // Summary row
  wsData.push([]);
  wsData.push([
    '', // ShiftID
    '', // Thang_luong
    '', // STT
    'Tá»”NG Cá»˜NG', // Ho_va_ten
    '', // So_tai_khoan
    '', // Ten_muc_tieu
    employees.reduce((acc, emp) => acc + (emp.standardHours || calculateTotal(emp.attendance)), 0), // Gio_cong_chuan
    '', // Luong_ca
    '', // Luong_trach_nhiem
    '', // Luong_ho_tro
    '', // Luong_quan_ly
    totalBonus, // Tien_thuong
    totalSalary, // Tong_luong
    totalAdvance1, // Ung_luong_lan1
    totalAdvance2, // Ung_luong_lan2
    totalAdvance3, // Ung_luong_lan3
    totalRefund, // Hoan_tien
    totalBHXH, // BHXH
    totalUniform, // Dong_phuc
    totalPenalty, // Tien_phat
    totalNetReceived, // Tong_con_nhan
    '' // Ghi_chu
  ]);

  // Create worksheet
  const ws = XLSX.utils.aoa_to_sheet(wsData);

  // Set column widths
  ws['!cols'] = [
    { wch: 15 },  // ShiftID
    { wch: 12 },  // Thang_luong
    { wch: 5 },   // STT
    { wch: 22 },  // Ho_va_ten
    { wch: 18 },  // So_tai_khoan
    { wch: 15 },  // Ten_muc_tieu
    { wch: 14 },  // Gio_cong_chuan
    { wch: 14 },  // Luong_ca
    { wch: 16 },  // Luong_trach_nhiem
    { wch: 12 },  // Luong_ho_tro
    { wch: 14 },  // Luong_quan_ly
    { wch: 12 },  // Tien_thuong
    { wch: 14 },  // Tong_luong
    { wch: 14 },  // Ung_luong_lan1
    { wch: 14 },  // Ung_luong_lan2
    { wch: 14 },  // Ung_luong_lan3
    { wch: 12 },  // Hoan_tien
    { wch: 12 },  // BHXH
    { wch: 12 },  // Dong_phuc
    { wch: 12 },  // Tien_phat
    { wch: 15 },  // Tong_con_nhan
    { wch: 20 }   // Ghi_chu
  ];

  // Create workbook
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, `LÆ°Æ¡ng T${month + 1}`);
  XLSX.writeFile(wb, filename || defaultFilename);
};
</file>

<file path="src/utils/excel/target-excel.ts">
/**
 * Target Excel operations
 * Export and import target/location data
 */

import * as XLSX from 'xlsx';
import type { Employee, Target, RosterItem } from '../../types';

/**
 * Export targets to Excel
 */
export const exportTargetsToExcel = (
  targets: Target[],
  employees: Employee[],
  filename?: string
): void => {
  const defaultFilename = `DanhSachMucTieu_${new Date().toISOString().slice(0, 10)}.xlsx`;
  const wb = XLSX.utils.book_new();

  // Summary sheet
  const summaryData: (string | number)[][] = [];
  summaryData.push(['DANH SÃCH Má»¤C TIÃŠU - Báº CH Há»” SECURITY']);
  summaryData.push([`Xuáº¥t ngÃ y: ${new Date().toLocaleDateString('vi-VN')}`]);
  summaryData.push([]);
  summaryData.push(['STT', 'TÃªn Má»¥c TiÃªu', 'Sá»‘ NhÃ¢n Sá»±']);

  targets.forEach((target, index) => {
    summaryData.push([index + 1, target.name, target.roster.length]);
  });

  summaryData.push([]);
  summaryData.push([`Tá»•ng sá»‘: ${targets.length} má»¥c tiÃªu`]);

  const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
  summaryWs['!cols'] = [{ wch: 5 }, { wch: 30 }, { wch: 12 }];
  XLSX.utils.book_append_sheet(wb, summaryWs, 'Tá»•ng Quan');

  // Detail sheet for each target
  targets.forEach((target) => {
    const detailData: (string | number)[][] = [];
    detailData.push([`Má»¤C TIÃŠU: ${target.name}`]);
    detailData.push([]);
    detailData.push(['STT', 'MÃ£ NV', 'Há» TÃªn', 'Ca Trá»±c']);

    target.roster.forEach((item, index) => {
      const emp = employees.find(e => e.id === item.employeeId);
      detailData.push([
        index + 1,
        emp?.code || '',
        emp?.name || 'KhÃ´ng tÃ¬m tháº¥y',
        item.shift || ''
      ]);
    });

    const detailWs = XLSX.utils.aoa_to_sheet(detailData);
    detailWs['!cols'] = [{ wch: 5 }, { wch: 10 }, { wch: 25 }, { wch: 15 }];

    // Truncate sheet name to 31 chars (Excel limit)
    const sheetName = target.name.substring(0, 31);
    XLSX.utils.book_append_sheet(wb, detailWs, sheetName);
  });

  XLSX.writeFile(wb, filename || defaultFilename);
};

/**
 * Download target import template
 */
export const downloadTargetTemplate = (): void => {
  const wb = XLSX.utils.book_new();

  // Instructions sheet
  const instructionData: string[][] = [];
  instructionData.push(['HÆ¯á»šNG DáºªN NHáº¬P Má»¤C TIÃŠU']);
  instructionData.push([]);
  instructionData.push(['CÃ¡ch 1: Multi-sheet (má»—i sheet = 1 má»¥c tiÃªu)']);
  instructionData.push(['- TÃªn sheet = TÃªn má»¥c tiÃªu']);
  instructionData.push(['- Má»—i sheet cÃ³ cÃ¡c cá»™t: STT, MÃ£ NV, Há» TÃªn, Ca Trá»±c']);
  instructionData.push([]);
  instructionData.push(['CÃ¡ch 2: Single-sheet (1 sheet chá»©a táº¥t cáº£)']);
  instructionData.push(['- Cá»™t: Má»¥c TiÃªu, MÃ£ NV, Há» TÃªn, Ca Trá»±c']);
  instructionData.push([]);
  instructionData.push(['LÆ¯U Ã:']);
  instructionData.push(['- MÃ£ NV pháº£i tá»“n táº¡i trong danh sÃ¡ch nhÃ¢n sá»±']);
  instructionData.push(['- Ca Trá»±c Ä‘á»‹nh dáº¡ng 24h: "08:00 - 17:00"']);

  const instructionWs = XLSX.utils.aoa_to_sheet(instructionData);
  instructionWs['!cols'] = [{ wch: 60 }];
  XLSX.utils.book_append_sheet(wb, instructionWs, 'HÆ°á»›ng Dáº«n');

  // Sample target sheet 1
  const target1Data: (string | number)[][] = [];
  target1Data.push(['Má»¤C TIÃŠU: VÄƒn PhÃ²ng ChÃ­nh']);
  target1Data.push([]);
  target1Data.push(['STT', 'MÃ£ NV', 'Há» TÃªn', 'Ca Trá»±c']);
  target1Data.push([1, '001', 'Nguyá»…n VÄƒn A', '08:00 - 17:00']);
  target1Data.push([2, '002', 'Tráº§n Thá»‹ B', '06:00 - 14:00']);
  target1Data.push([3, '', '', '']);

  const target1Ws = XLSX.utils.aoa_to_sheet(target1Data);
  target1Ws['!cols'] = [{ wch: 5 }, { wch: 10 }, { wch: 25 }, { wch: 15 }];
  XLSX.utils.book_append_sheet(wb, target1Ws, 'VÄƒn PhÃ²ng ChÃ­nh');

  // Sample target sheet 2
  const target2Data: (string | number)[][] = [];
  target2Data.push(['Má»¤C TIÃŠU: Kho HÃ ng']);
  target2Data.push([]);
  target2Data.push(['STT', 'MÃ£ NV', 'Há» TÃªn', 'Ca Trá»±c']);
  target2Data.push([1, '003', 'LÃª VÄƒn C', '22:00 - 06:00']);
  target2Data.push([2, '', '', '']);

  const target2Ws = XLSX.utils.aoa_to_sheet(target2Data);
  target2Ws['!cols'] = [{ wch: 5 }, { wch: 10 }, { wch: 25 }, { wch: 15 }];
  XLSX.utils.book_append_sheet(wb, target2Ws, 'Kho HÃ ng');

  XLSX.writeFile(wb, 'Mau_NhapMucTieu.xlsx');
};

/**
 * Export targets to JSON (for backup/restore)
 */
export const exportTargetsToJSON = (targets: Target[]): void => {
  const dataStr = JSON.stringify(targets, null, 2);
  const blob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `MucTieu_${new Date().toISOString().slice(0, 10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
};

/**
 * Import targets from JSON
 */
export const importTargetsFromJSON = (
  file: File
): Promise<{ targets: Target[]; errors: string[] }> => {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();

    reader.onload = (e) => {
      try {
        const jsonData = JSON.parse(e.target?.result as string);

        if (!Array.isArray(jsonData)) {
          resolve({ targets: [], errors: ['File khÃ´ng Ä‘Ãºng Ä‘á»‹nh dáº¡ng. Cáº§n lÃ  máº£ng JSON.'] });
          return;
        }

        const targets: Target[] = [];
        const errors: string[] = [];

        jsonData.forEach((item: any, index: number) => {
          if (!item.name) {
            errors.push(`Má»¥c ${index + 1}: Thiáº¿u tÃªn má»¥c tiÃªu`);
            return;
          }

          targets.push({
            id: item.id || Math.random().toString(36).substr(2, 9),
            name: item.name,
            roster: Array.isArray(item.roster) ? item.roster : []
          });
        });

        resolve({ targets, errors });
      } catch (err) {
        reject(new Error('KhÃ´ng thá»ƒ Ä‘á»c file JSON. Vui lÃ²ng kiá»ƒm tra Ä‘á»‹nh dáº¡ng.'));
      }
    };

    reader.onerror = () => reject(new Error('Lá»—i Ä‘á»c file'));
    reader.readAsText(file);
  });
};

/**
 * Import targets from Excel file
 * Supports multi-sheet format (each sheet = 1 target) or single sheet format
 */
export const importTargetsFromExcel = (
  file: File,
  existingEmployees: Employee[]
): Promise<{ targets: Target[]; errors: string[] }> => {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();

    reader.onload = (e) => {
      try {
        const data = new Uint8Array(e.target?.result as ArrayBuffer);
        const workbook = XLSX.read(data, { type: 'array' });

        const targets: Target[] = [];
        const errors: string[] = [];

        // Try multi-sheet format first
        if (workbook.SheetNames.length > 1 || !workbook.SheetNames.includes('Tá»•ng Quan')) {
          workbook.SheetNames.forEach((sheetName) => {
            if (sheetName === 'Tá»•ng Quan') return;

            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 }) as any[][];

            const roster: RosterItem[] = [];

            // Find header row
            let headerRowIndex = -1;
            let codeColIndex = -1;
            let shiftColIndex = -1;

            for (let i = 0; i < Math.min(5, jsonData.length); i++) {
              const row = jsonData[i];
              if (!row) continue;

              for (let j = 0; j < row.length; j++) {
                const cell = String(row[j] || '').toLowerCase();
                if (cell.includes('mÃ£')) codeColIndex = j;
                if (cell.includes('ca') || cell.includes('trá»±c') || cell.includes('giá»')) shiftColIndex = j;
              }

              if (codeColIndex >= 0) {
                headerRowIndex = i;
                break;
              }
            }

            // Parse data rows
            const startRow = headerRowIndex >= 0 ? headerRowIndex + 1 : 1;
            for (let i = startRow; i < jsonData.length; i++) {
              const row = jsonData[i];
              if (!row || row.length === 0) continue;

              const code = String(row[codeColIndex >= 0 ? codeColIndex : 1] || '').trim();
              const shift = shiftColIndex >= 0 ? String(row[shiftColIndex] || '').trim() : '';

              if (!code) continue;

              const emp = existingEmployees.find(e => e.code === code);
              if (emp) {
                roster.push({
                  employeeId: emp.id,
                  shift: shift || '08:00 - 17:00'
                });
              } else {
                errors.push(`Sheet "${sheetName}": KhÃ´ng tÃ¬m tháº¥y nhÃ¢n viÃªn mÃ£ "${code}"`);
              }
            }

            if (roster.length > 0) {
              targets.push({
                id: Math.random().toString(36).substr(2, 9),
                name: sheetName,
                roster
              });
            }
          });
        } else {
          // Single sheet format
          const worksheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 }) as any[][];

          // Find header
          let headerRowIndex = -1;
          let targetColIndex = -1;
          let codeColIndex = -1;
          let shiftColIndex = -1;

          for (let i = 0; i < Math.min(5, jsonData.length); i++) {
            const row = jsonData[i];
            if (!row) continue;

            for (let j = 0; j < row.length; j++) {
              const cell = String(row[j] || '').toLowerCase();
              if (cell.includes('má»¥c') || cell.includes('tiÃªu') || cell.includes('Ä‘á»‹a')) targetColIndex = j;
              if (cell.includes('mÃ£')) codeColIndex = j;
              if (cell.includes('ca') || cell.includes('trá»±c') || cell.includes('giá»')) shiftColIndex = j;
            }

            if (codeColIndex >= 0) {
              headerRowIndex = i;
              break;
            }
          }

          // Group by target name
          const targetMap = new Map<string, RosterItem[]>();

          const startRow = headerRowIndex >= 0 ? headerRowIndex + 1 : 1;
          for (let i = startRow; i < jsonData.length; i++) {
            const row = jsonData[i];
            if (!row || row.length === 0) continue;

            const targetName = targetColIndex >= 0 ? String(row[targetColIndex] || '').trim() : 'Má»¥c TiÃªu Má»›i';
            const code = String(row[codeColIndex >= 0 ? codeColIndex : 0] || '').trim();
            const shift = shiftColIndex >= 0 ? String(row[shiftColIndex] || '').trim() : '';

            if (!code) continue;

            const emp = existingEmployees.find(e => e.code === code);
            if (emp) {
              if (!targetMap.has(targetName)) {
                targetMap.set(targetName, []);
              }
              targetMap.get(targetName)!.push({
                employeeId: emp.id,
                shift: shift || '08h00 - 17h00'
              });
            } else {
              errors.push(`DÃ²ng ${i + 1}: KhÃ´ng tÃ¬m tháº¥y nhÃ¢n viÃªn mÃ£ "${code}"`);
            }
          }

          targetMap.forEach((roster, name) => {
            targets.push({
              id: Math.random().toString(36).substr(2, 9),
              name,
              roster
            });
          });
        }

        resolve({ targets, errors });
      } catch (err) {
        reject(new Error('KhÃ´ng thá»ƒ Ä‘á»c file Excel. Vui lÃ²ng kiá»ƒm tra Ä‘á»‹nh dáº¡ng.'));
      }
    };

    reader.onerror = () => reject(new Error('Lá»—i Ä‘á»c file'));
    reader.readAsArrayBuffer(file);
  });
};
</file>

<file path="src/utils/excel/timesheet-excel.ts">
/**
 * Timesheet Excel operations
 * Export and import timesheet/attendance data
 */

import * as XLSX from 'xlsx';
import type { Employee } from '../../types';
import { generateDaysInfo, calculateTotal } from './common';

/**
 * Export timesheet data to Excel file
 * Headers: ID, MSNV, Há» vÃ  tÃªn, Má»¥c tiÃªu, NÄƒm, ThÃ¡ng, 01-31, Tá»•ng CÃ´ng
 */
export const exportToExcel = (
  data: Employee[],
  year: number,
  month: number,
  filename?: string
): void => {
  const days = generateDaysInfo(year, month);
  const monthName = `Thang${month + 1}`;
  const defaultFilename = `BangChamCong_${monthName}_${year}.xlsx`;

  // Create header rows
  const titleRow = [`Báº¢NG CHáº¤M CÃ”NG THÃNG ${month + 1}/${year} - Báº CH Há»” SECURITY`];
  const emptyRow: string[] = [];

  // Header format: ID, MSNV, Há» vÃ  tÃªn, Má»¥c tiÃªu, NÄƒm, ThÃ¡ng, 01-31
  const headerRow1 = ['ID', 'MSNV', 'Há» vÃ  tÃªn', 'Má»¥c tiÃªu', 'NÄƒm', 'ThÃ¡ng'];
  days.forEach(day => {
    headerRow1.push(day.date.toString().padStart(2, '0'));
  });
  headerRow1.push('Tá»•ng CÃ´ng');

  // Day of week sub-header
  const headerRow2 = ['', '', '', '', '', ''];
  days.forEach(day => {
    headerRow2.push(day.dayOfWeek);
  });
  headerRow2.push('');

  // Data rows
  const dataRows = data.map((emp) => {
    const row: (string | number)[] = [
      emp.id || '',
      emp.code || '',
      emp.name || '',
      emp.department || '',
      year,
      month + 1
    ];

    days.forEach(day => {
      const val = emp.attendance?.[day.date] || '';
      row.push(val);
    });

    row.push(calculateTotal(emp.attendance));
    return row;
  });

  // Summary row
  const totalAttendance = data.reduce((acc, emp) => acc + calculateTotal(emp.attendance), 0);
  const summaryRow: (string | number)[] = ['', '', '', `Tá»•ng Sá»‘: ${totalAttendance} cÃ´ng`, '', ''];
  days.forEach(() => summaryRow.push(''));
  summaryRow.push(totalAttendance);

  // Combine all rows
  const wsData = [
    titleRow,
    emptyRow,
    headerRow1,
    headerRow2,
    ...dataRows,
    emptyRow,
    summaryRow
  ];

  // Create worksheet
  const ws = XLSX.utils.aoa_to_sheet(wsData);

  // Set column widths
  const colWidths = [
    { wch: 12 },  // ID
    { wch: 10 },  // MSNV
    { wch: 22 },  // Há» vÃ  tÃªn
    { wch: 15 },  // Má»¥c tiÃªu
    { wch: 6 },   // NÄƒm
    { wch: 6 },   // ThÃ¡ng
    ...days.map(() => ({ wch: 5 })),
    { wch: 10 }   // Tá»•ng CÃ´ng
  ];
  ws['!cols'] = colWidths;

  // Merge title cell
  const totalCols = 6 + days.length + 1;
  ws['!merges'] = [
    { s: { r: 0, c: 0 }, e: { r: 0, c: totalCols - 1 } }
  ];

  // Create workbook
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, `ThÃ¡ng ${month + 1}`);
  XLSX.writeFile(wb, filename || defaultFilename);
};

/**
 * Export timesheet with styling
 * Headers: ID, MSNV, Há» vÃ  tÃªn, Má»¥c tiÃªu, NÄƒm, ThÃ¡ng, 01-31, Tá»•ng CÃ´ng
 */
export const exportToExcelStyled = (
  data: Employee[],
  year: number,
  month: number,
  filename?: string
): void => {
  const days = generateDaysInfo(year, month);
  const monthName = `Thang${month + 1}`;
  const defaultFilename = `BangChamCong_${monthName}_${year}.xlsx`;

  const wb = XLSX.utils.book_new();
  const wsData: (string | number)[][] = [];

  // Title
  wsData.push([`Báº¢NG CHáº¤M CÃ”NG THÃNG ${month + 1}/${year}`]);
  wsData.push(['Báº CH Há»” SECURITY']);
  wsData.push([]);

  // Headers
  const header1: (string | number)[] = ['ID', 'MSNV', 'Há» vÃ  tÃªn', 'Má»¥c tiÃªu', 'NÄƒm', 'ThÃ¡ng'];
  days.forEach(day => header1.push(day.date));
  header1.push('Tá»•ng');
  wsData.push(header1);

  const header2: (string | number)[] = ['', '', '', '', '', ''];
  days.forEach(day => header2.push(day.dayOfWeek));
  header2.push('');
  wsData.push(header2);

  // Data rows
  data.forEach((emp) => {
    const row: (string | number)[] = [
      emp.id || '',
      emp.code || '',
      emp.name || '',
      emp.department || '',
      year,
      month + 1
    ];

    days.forEach(day => {
      const val = emp.attendance?.[day.date];
      row.push(val || '');
    });

    row.push(calculateTotal(emp.attendance));
    wsData.push(row);
  });

  wsData.push([]);

  // Summary
  const totalAttendance = data.reduce((acc, emp) => acc + calculateTotal(emp.attendance), 0);
  const summaryRow: (string | number)[] = ['', '', 'Tá»”NG Cá»˜NG:', '', '', ''];
  days.forEach(() => summaryRow.push(''));
  summaryRow.push(totalAttendance);
  wsData.push(summaryRow);

  const ws = XLSX.utils.aoa_to_sheet(wsData);
  ws['!cols'] = [
    { wch: 12 },  // ID
    { wch: 10 },  // MSNV
    { wch: 22 },  // Há» vÃ  tÃªn
    { wch: 15 },  // Má»¥c tiÃªu
    { wch: 6 },   // NÄƒm
    { wch: 6 },   // ThÃ¡ng
    ...days.map(() => ({ wch: 4 })),
    { wch: 8 }
  ];

  ws['!rows'] = [
    { hpt: 25 },
    { hpt: 20 },
    { hpt: 15 },
    { hpt: 22 },
    { hpt: 18 },
  ];

  XLSX.utils.book_append_sheet(wb, ws, `ThÃ¡ng ${month + 1}`);
  XLSX.writeFile(wb, filename || defaultFilename);
};

/**
 * Download timesheet import template
 */
export const downloadTimesheetTemplate = (year: number, month: number): void => {
  const days = generateDaysInfo(year, month);
  const wsData: (string | number)[][] = [];

  // Title
  wsData.push(['MáºªU NHáº¬P Báº¢NG CHáº¤M CÃ”NG']);
  wsData.push(['HÆ°á»›ng dáº«n: Äiá»n dá»¯ liá»‡u tá»« dÃ²ng 6 trá»Ÿ Ä‘i, khÃ´ng xÃ³a header']);
  wsData.push([]);

  // Headers
  const header1: (string | number)[] = ['ID', 'MSNV', 'Há» vÃ  tÃªn', 'Má»¥c tiÃªu', 'NÄƒm', 'ThÃ¡ng'];
  days.forEach(day => header1.push(day.date));
  header1.push('Tá»•ng');
  wsData.push(header1);

  // Day of week sub-header
  const header2: (string | number)[] = ['', '', '', '', '', ''];
  days.forEach(day => header2.push(day.dayOfWeek));
  header2.push('');
  wsData.push(header2);

  // Sample data rows
  const sample1: (string | number)[] = ['', '001', 'Nguyá»…n VÄƒn A', 'VÄƒn PhÃ²ng', year, month + 1];
  days.forEach((day, idx) => {
    // Sample pattern: weekdays = 1, weekends = empty, some holidays = P
    if (day.isWeekend) {
      sample1.push('');
    } else if (idx === 4 || idx === 15) {
      sample1.push('P'); // Sample leave days
    } else {
      sample1.push('1');
    }
  });
  sample1.push('');
  wsData.push(sample1);

  const sample2: (string | number)[] = ['', '002', 'Tráº§n Thá»‹ B', 'Kho HÃ ng', year, month + 1];
  days.forEach(day => {
    if (day.isWeekend) {
      sample2.push('');
    } else {
      sample2.push('1');
    }
  });
  sample2.push('');
  wsData.push(sample2);

  // Empty row for user to fill
  const emptyRow: (string | number)[] = ['', '', '', '', year, month + 1];
  days.forEach(() => emptyRow.push(''));
  emptyRow.push('');
  wsData.push(emptyRow);

  // Instructions
  wsData.push([]);
  wsData.push(['GHI CHÃš:']);
  wsData.push(['- MSNV: Báº¯t buá»™c, dÃ¹ng Ä‘á»ƒ khá»›p vá»›i nhÃ¢n viÃªn cÃ³ sáºµn']);
  wsData.push(['- Há» vÃ  tÃªn: TÃ¹y chá»n (dÃ¹ng MSNV Ä‘á»ƒ khá»›p)']);
  wsData.push(['- GiÃ¡ trá»‹ cháº¥m cÃ´ng: 1 (Ä‘á»§ cÃ´ng), 0.5 (ná»­a cÃ´ng), P (phÃ©p), K (khÃ´ng phÃ©p), X (nghá»‰)']);
  wsData.push(['- Cá»™t Tá»•ng sáº½ Ä‘Æ°á»£c tÃ­nh tá»± Ä‘á»™ng khi nháº­p']);

  const ws = XLSX.utils.aoa_to_sheet(wsData);
  ws['!cols'] = [
    { wch: 12 },  // ID
    { wch: 10 },  // MSNV
    { wch: 22 },  // Há» vÃ  tÃªn
    { wch: 15 },  // Má»¥c tiÃªu
    { wch: 6 },   // NÄƒm
    { wch: 6 },   // ThÃ¡ng
    ...days.map(() => ({ wch: 4 })),
    { wch: 8 }
  ];

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Máº«u Cháº¥m CÃ´ng');
  XLSX.writeFile(wb, `Mau_ChamCong_T${month + 1}_${year}.xlsx`);
};

/**
 * Import timesheet data from Excel
 */
export const importTimesheetFromExcel = (
  file: File,
  existingEmployees: Employee[]
): Promise<{ employees: Employee[]; errors: string[] }> => {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();

    reader.onload = (e) => {
      try {
        const data = new Uint8Array(e.target?.result as ArrayBuffer);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 }) as any[][];

        const employees: Employee[] = [];
        const errors: string[] = [];

        // Find header row
        let headerRowIndex = -1;
        let codeColIndex = -1;
        let nameColIndex = -1;
        let deptColIndex = -1;
        let dayStartColIndex = -1;

        for (let i = 0; i < Math.min(10, jsonData.length); i++) {
          const row = jsonData[i];
          if (!row) continue;

          for (let j = 0; j < row.length; j++) {
            const cell = String(row[j] || '').toLowerCase();
            if (cell.includes('mÃ£')) codeColIndex = j;
            if (cell.includes('tÃªn') || cell.includes('há»')) nameColIndex = j;
            if (cell.includes('má»¥c') || cell.includes('tiÃªu') || cell.includes('phÃ²ng')) deptColIndex = j;

            const numVal = parseInt(String(row[j]));
            if (numVal === 1 && dayStartColIndex < 0) {
              dayStartColIndex = j;
            }
          }

          if (codeColIndex >= 0 || nameColIndex >= 0) {
            headerRowIndex = i;
            break;
          }
        }

        if (headerRowIndex < 0) {
          resolve({ employees: [], errors: ['KhÃ´ng tÃ¬m tháº¥y header há»£p lá»‡.'] });
          return;
        }

        // Parse data rows
        for (let i = headerRowIndex + 2; i < jsonData.length; i++) {
          const row = jsonData[i];
          if (!row || row.length === 0) continue;

          const code = String(row[codeColIndex] || '').trim();
          const name = String(row[nameColIndex] || '').trim();

          if (!code && !name) continue;

          const existingEmp = existingEmployees.find(e => e.code === code || e.name === name);

          // Parse attendance
          const attendance: Record<number, string> = {};
          if (dayStartColIndex >= 0) {
            for (let day = 1; day <= 31; day++) {
              const colIndex = dayStartColIndex + day - 1;
              if (colIndex < row.length) {
                const val = String(row[colIndex] || '').trim();
                if (val) {
                  attendance[day] = val;
                }
              }
            }
          }

          employees.push({
            id: existingEmp?.id || Math.random().toString(36).substr(2, 9),
            code: code || existingEmp?.code || `NV${employees.length + 1}`,
            name: name || existingEmp?.name || '',
            department: (deptColIndex >= 0 ? String(row[deptColIndex] || '') : '') || existingEmp?.department || 'ChÆ°a xÃ¡c Ä‘á»‹nh',
            shift: existingEmp?.shift || '08:00 - 17:00',
            attendance,
            password: existingEmp?.password || '123',
            role: existingEmp?.role || 'staff'
          });
        }

        resolve({ employees, errors });
      } catch (err) {
        reject(new Error('KhÃ´ng thá»ƒ Ä‘á»c file Excel. Vui lÃ²ng kiá»ƒm tra Ä‘á»‹nh dáº¡ng.'));
      }
    };

    reader.onerror = () => reject(new Error('Lá»—i Ä‘á»c file'));
    reader.readAsArrayBuffer(file);
  });
};
</file>

<file path="src/utils/index.ts">
/**
 * Utils barrel export
 * Re-exports all utility functions
 */

// Excel utilities
export * from './excel';

// Date helpers
export {
  generateDaysInfo,
  calculateAttendanceTotal
} from './date-helpers';

// Auth utilities
export { hashPassword, verifyPassword } from './auth';

// Timesheet helpers
export {
  generateDaysInfo as generateTimesheetDays,
  calculateTotal,
  getCellColor,
  sortByTargetOrder,
  getStickyPositions,
  COL_WIDTHS,
  createRowsFromTarget
} from './timesheet-helpers';
</file>

<file path="src/utils/timesheet-helpers.ts">
/**
 * Timesheet Helper Functions
 * Common utilities for timesheet calculations and styling
 */

import type { Employee, DayInfo, Target } from '../types';
import { DAYS_OF_WEEK_EN } from '../constants';

/**
 * Generate day info for a specific month
 */
export const generateDaysInfo = (year: number, month: number): DayInfo[] => {
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const result: DayInfo[] = [];

  for (let i = 1; i <= daysInMonth; i++) {
    const date = new Date(year, month, i);
    const dayIndex = date.getDay(); // 0 = Sun, 1 = Mon...
    result.push({
      date: i,
      dayOfWeek: DAYS_OF_WEEK_EN[dayIndex],
      isWeekend: dayIndex === 0 || dayIndex === 6,
    });
  }
  return result;
};

/**
 * Calculate total attendance from attendance record
 */
export const calculateTotal = (attendance?: Record<number, string>): number => {
  if (!attendance) return 0;
  let total = 0;
  Object.values(attendance).forEach((val) => {
    const num = parseFloat(val);
    if (!isNaN(num)) {
      total += num;
    }
  });
  return total;
};

/**
 * Get cell background color based on value and weekend status
 */
export const getCellColor = (val: string, isWeekend: boolean): string => {
  if (val === 'CN' || val === 'Red') return 'bg-red-600 text-white font-bold';
  if (val === '0.5') return 'bg-blue-100 text-blue-800';
  if (val === '1') return isWeekend ? 'bg-yellow-200' : 'bg-green-100';
  if (val === 'P') return 'bg-orange-200';
  if (!val && isWeekend) return 'bg-yellow-50';
  return 'bg-white';
};

/**
 * Sort employees by target order
 */
export const sortByTargetOrder = (
  data: Employee[],
  targets: Target[],
  allEmployees: Employee[]
): Employee[] => {
  // Create a map: employeeCode -> { targetIndex, rosterIndex }
  const employeeTargetMap = new Map<string, { targetIndex: number; rosterIndex: number }>();

  targets.forEach((target, targetIndex) => {
    target.roster.forEach((rosterItem, rosterIndex) => {
      const emp = allEmployees.find(e => e.id === rosterItem.employeeId);
      if (emp && emp.code) {
        employeeTargetMap.set(emp.code, {
          targetIndex,
          rosterIndex
        });
      }
    });
  });

  // Sort data
  const sorted = [...data].sort((a, b) => {
    const targetInfoA = a.code ? employeeTargetMap.get(a.code) : undefined;
    const targetInfoB = b.code ? employeeTargetMap.get(b.code) : undefined;

    // Both employees are in targets
    if (targetInfoA && targetInfoB) {
      // Different targets - sort by target order
      if (targetInfoA.targetIndex !== targetInfoB.targetIndex) {
        return targetInfoA.targetIndex - targetInfoB.targetIndex;
      }
      // Same target - sort by roster order
      return targetInfoA.rosterIndex - targetInfoB.rosterIndex;
    }

    // Only A is in a target
    if (targetInfoA) return -1;

    // Only B is in a target
    if (targetInfoB) return 1;

    // Neither is in a target - sort by ID for stability (prevent reordering while typing)
    return (a.id || '').localeCompare(b.id || '');
  });

  return sorted;
};

/**
 * Column widths for sticky positioning
 */
export const COL_WIDTHS = {
  CHECK: 40,
  STT: 40,
  CODE: 70,
  NAME: 180,
  TARGET: 150
} as const;

/**
 * Calculate sticky positions for columns
 */
export const getStickyPositions = () => {
  const POS_CHECK = 0;
  const POS_STT = COL_WIDTHS.CHECK;
  const POS_CODE = POS_STT + COL_WIDTHS.STT;
  const POS_NAME = POS_CODE + COL_WIDTHS.CODE;
  const POS_TARGET = POS_NAME + COL_WIDTHS.NAME;

  return {
    CHECK: POS_CHECK,
    STT: POS_STT,
    CODE: POS_CODE,
    NAME: POS_NAME,
    TARGET: POS_TARGET
  };
};

/**
 * Create empty rows for target roster
 */
export const createRowsFromTarget = (
  target: Target,
  allEmployees: Employee[],
  existingCodes: string[]
): Employee[] => {
  const newRows: Employee[] = [];

  target.roster.forEach(rosterItem => {
    const empDetails = allEmployees.find(e => e.id === rosterItem.employeeId);

    if (empDetails) {
      // Check if employee already exists in grid
      const isAlreadyInGrid = existingCodes.some(c => c === empDetails.code);

      if (!isAlreadyInGrid) {
        const rowId = Math.random().toString(36).substr(2, 9);
        newRows.push({
          id: rowId,
          code: empDetails.code,
          name: empDetails.name,
          department: target.name,
          shift: '',
          attendance: {},
          password: '',
          role: 'staff'
        });
      }
    }
  });

  return newRows;
};
</file>

<file path="vercel.json">
{
  "buildCommand": "npm run build",
  "outputDirectory": "dist",
  "devCommand": "npm run dev",
  "installCommand": "npm install",
  "framework": "vite",
  "rewrites": [
    {
      "source": "/(.*)",
      "destination": "/index.html"
    }
  ]
}
</file>

<file path="index.html">
<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <title>Báº¡ch Há»• Security</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
      /* Custom scrollbar for Excel-like feel */
      ::-webkit-scrollbar {
        width: 10px;
        height: 10px;
      }
      ::-webkit-scrollbar-track {
        background: #f1f1f1;
      }
      ::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 5px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #555;
      }
      .no-spinner::-webkit-inner-spin-button,
      .no-spinner::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      body {
        font-family: 'Montserrat', sans-serif;
      }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        amber: {
                            50: '#fffbeb',
                            100: '#fef3c7',
                            400: '#fbbf24',
                            500: '#f59e0b',
                            600: '#d97706',
                            700: '#b45309',
                            800: '#92400e',
                            900: '#78350f',
                        },
                    }
                }
            }
        }
    </script>
  <script type="importmap">
{
  "imports": {
    "react/": "https://esm.sh/react@^19.2.3/",
    "react": "https://esm.sh/react@^19.2.3",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0",
    "@google/genai": "https://esm.sh/@google/genai@^1.34.0",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/"
  }
}
</script>
<link rel="stylesheet" href="/src/index.css">
</head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/index.tsx"></script>
  </body>
</html>
</file>

<file path="scripts/seed-attendance-data.js">
import { initializeApp } from 'firebase/app';
import { getDatabase, ref, get, update } from 'firebase/database';

// Firebase configuration - must match lib/firebase.ts
const firebaseConfig = {
  databaseURL: 'https://bachho-timesheet-2025-default-rtdb.asia-southeast1.firebasedatabase.app'
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const database = getDatabase(app);

// Parse command line arguments
// Usage: npm run seed-attendance -- --year=2025 --month=12
// Or:    npm run seed-attendance -- --year=2025 --all (for full year)
function parseArgs() {
  const args = process.argv.slice(2);
  const config = {
    year: 2025,
    month: null, // null means all months
    all: false
  };

  args.forEach(arg => {
    if (arg.startsWith('--year=')) {
      config.year = parseInt(arg.split('=')[1]) || 2025;
    }
    if (arg.startsWith('--month=')) {
      config.month = parseInt(arg.split('=')[1]);
    }
    if (arg === '--all') {
      config.all = true;
      config.month = null;
    }
  });

  // Default: if no args, seed all months of 2025
  if (args.length === 0) {
    config.all = true;
  }

  return config;
}

const CONFIG = parseArgs();
const YEAR = CONFIG.year;
const MONTHS_TO_SEED = CONFIG.month ? [CONFIG.month] : [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12];

// Get days in month
function getDaysInMonth(year, month) {
  return new Date(year, month, 0).getDate();
}

// Check if weekend
function isWeekend(year, month, day) {
  const date = new Date(year, month - 1, day);
  const dayOfWeek = date.getDay();
  return dayOfWeek === 0 || dayOfWeek === 6; // Sunday or Saturday
}

// Generate random attendance value
function generateAttendance(isWeekendDay) {
  const rand = Math.random();

  if (isWeekendDay) {
    // Weekend: 70% nghá»‰ (CN), 20% Ä‘i lÃ m (1), 10% ná»­a ngÃ y (0.5)
    if (rand < 0.7) return 'CN';
    if (rand < 0.9) return '1';
    return '0.5';
  } else {
    // Weekday: 85% Ä‘i lÃ m (1), 8% ná»­a ngÃ y (0.5), 5% nghá»‰ phÃ©p (P), 2% nghá»‰ (CN)
    if (rand < 0.85) return '1';
    if (rand < 0.93) return '0.5';
    if (rand < 0.98) return 'P';
    return 'CN';
  }
}

// Generate attendance for an employee for a specific month
function generateEmployeeAttendance(year, month) {
  const daysInMonth = getDaysInMonth(year, month);
  const attendance = {};

  for (let day = 1; day <= daysInMonth; day++) {
    const isWeekendDay = isWeekend(year, month, day);
    attendance[day] = generateAttendance(isWeekendDay);
  }

  return attendance;
}

// Calculate total work days from attendance
function calculateTotal(attendance) {
  return Object.values(attendance).reduce((sum, val) => {
    const num = parseFloat(val);
    return sum + (isNaN(num) ? 0 : num);
  }, 0);
}

async function seedAttendanceData() {
  const monthNames = ['', 'ThÃ¡ng 1', 'ThÃ¡ng 2', 'ThÃ¡ng 3', 'ThÃ¡ng 4', 'ThÃ¡ng 5', 'ThÃ¡ng 6',
                      'ThÃ¡ng 7', 'ThÃ¡ng 8', 'ThÃ¡ng 9', 'ThÃ¡ng 10', 'ThÃ¡ng 11', 'ThÃ¡ng 12'];

  console.log('ğŸš€ Seed Attendance Data - Bach Ho Security');
  console.log('==========================================');
  console.log(`ğŸ“† NÄƒm: ${YEAR}`);
  console.log(`ğŸ“… ThÃ¡ng: ${MONTHS_TO_SEED.length === 12 ? 'Táº¥t cáº£ (1-12)' : MONTHS_TO_SEED.join(', ')}\n`);

  try {
    // Fetch all employees
    const snapshot = await get(ref(database, 'employees'));
    if (!snapshot.exists()) {
      console.log('âŒ KhÃ´ng tÃ¬m tháº¥y nhÃ¢n viÃªn nÃ o trong database!');
      process.exit(1);
    }

    const employees = snapshot.val();
    const employeeIds = Object.keys(employees);

    console.log(`ğŸ“‹ TÃ¬m tháº¥y ${employeeIds.length} nhÃ¢n viÃªn\n`);

    let grandTotal = 0;

    // Seed each month
    for (const month of MONTHS_TO_SEED) {
      const daysInMonth = getDaysInMonth(YEAR, month);
      console.log(`\nğŸ“… ${monthNames[month]} ${YEAR} (${daysInMonth} ngÃ y)`);
      console.log('â”€'.repeat(40));

      let monthTotal = 0;

      // Update each employee with attendance data for this month
      for (const empId of employeeIds) {
        const emp = employees[empId];
        const attendance = generateEmployeeAttendance(YEAR, month);
        const total = calculateTotal(attendance);
        monthTotal += total;

        // For the currently selected month in the app (based on filter),
        // we store in employees/${empId}/attendance
        // This matches how the app currently reads data
        if (month === 12) {
          // December is the default view, update the main attendance field
          await update(ref(database, `employees/${empId}`), { attendance });
        }

        // Also store in timesheets collection for historical access
        await update(ref(database, `timesheets/${YEAR}/${month}/${empId}`), {
          employeeId: empId,
          employeeCode: emp.code,
          name: emp.name,
          attendance,
          total,
          year: YEAR,
          month
        });

        console.log(`  âœ“ ${emp.name || emp.code}: ${total.toFixed(1)} cÃ´ng`);
      }

      grandTotal += monthTotal;
      console.log(`  ğŸ“Š Tá»•ng thÃ¡ng: ${monthTotal.toFixed(1)} cÃ´ng`);
    }

    console.log('\n==========================================');
    console.log(`âœ… HoÃ n thÃ nh! ÄÃ£ seed ${MONTHS_TO_SEED.length} thÃ¡ng`);
    console.log(`ğŸ“Š Tá»•ng cá»™ng: ${grandTotal.toFixed(1)} cÃ´ng`);
    console.log('\nğŸ”„ Refresh trang web Ä‘á»ƒ xem dá»¯ liá»‡u má»›i.');
    console.log('\nğŸ’¡ Tip: Dá»¯ liá»‡u Ä‘Æ°á»£c lÆ°u táº¡i:');
    console.log('   - employees/{id}/attendance (thÃ¡ng 12 - hiá»ƒn thá»‹ máº·c Ä‘á»‹nh)');
    console.log('   - timesheets/{year}/{month}/{empId} (táº¥t cáº£ cÃ¡c thÃ¡ng)');

    process.exit(0);
  } catch (error) {
    console.error('\nâŒ Lá»—i khi seed dá»¯ liá»‡u:', error);
    process.exit(1);
  }
}

// Run seed
seedAttendanceData();
</file>

<file path="src/components/auth/index.ts">
/**
 * Auth components barrel export
 */

export { Login } from './login'
</file>

<file path="src/components/shared/index.ts">
/**
 * Shared components barrel export
 */

export { SyncStatus, SyncButton } from './sync-button'
export { BackupButton } from './backup-button'
export { Settings } from './settings'
export { ImageCapture } from './image-capture'
</file>

<file path="src/core/app-layout.tsx">
/**
 * App Layout
 * Main application shell with header and content area
 */

import React, { useState, useCallback } from 'react';
import { Loader2 } from 'lucide-react';
import { AppHeader } from './app-header';
import { useAuth } from '../features/auth';
import { useEmployees } from '../features/hr';
import { Login } from '../components/auth';
import { Settings } from '../components/shared';

type ViewType = 'timesheet' | 'hr' | 'targets';

interface AppLayoutProps {
  children: (props: { currentView: ViewType }) => React.ReactNode;
  headerControls?: React.ReactNode;
  isLoading?: boolean;
}

export const AppLayout: React.FC<AppLayoutProps> = ({
  children,
  headerControls,
  isLoading = false
}) => {
  const { currentUser, isLoggedIn, login, logout } = useAuth();
  const { employees, isLoading: employeesLoading } = useEmployees();
  const [currentView, setCurrentView] = useState<ViewType>('timesheet');
  const [showSettings, setShowSettings] = useState(false);

  // Handle login with code and password
  const handleLogin = useCallback(async (code: string, pass: string) => {
    const user = employees.find(e => e.code === code && e.password === pass);
    if (user) {
      login(user);
    } else {
      throw new Error("MÃ£ nhÃ¢n viÃªn hoáº·c máº­t kháº©u khÃ´ng Ä‘Ãºng.");
    }
  }, [employees, login]);

  // Loading state
  if (isLoading || employeesLoading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <Loader2 className="w-12 h-12 animate-spin text-blue-600 mx-auto mb-4" />
          <p className="text-gray-600">Äang táº£i dá»¯ liá»‡u...</p>
        </div>
      </div>
    );
  }

  // Login screen
  if (!isLoggedIn) {
    return <Login onLogin={handleLogin} />;
  }

  return (
    <div className="min-h-screen bg-gray-50 flex flex-col font-sans text-gray-800">
      <AppHeader
        currentView={currentView}
        onViewChange={setCurrentView}
        onSettingsClick={() => setShowSettings(true)}
        onLogout={logout}
      >
        {headerControls}
      </AppHeader>

      <main className="flex-1 p-4 overflow-hidden flex flex-col max-w-[1920px] mx-auto w-full">
        {children({ currentView })}

        <div className="mt-2 text-xs text-gray-500 flex justify-between">
          <p>* Dá»¯ liá»‡u Ä‘Æ°á»£c lÆ°u trá»¯ táº¡m thá»i trÃªn trÃ¬nh duyá»‡t.</p>
          <p>PhiÃªn báº£n 1.2.1 - Báº¡ch Há»• Security</p>
        </div>
      </main>

      <Settings isOpen={showSettings} onClose={() => setShowSettings(false)} />
    </div>
  );
};
</file>

<file path="src/features/targets/index.ts">
/**
 * Targets feature exports
 */

export { TargetsProvider, useTargets } from './targets-context';
export { TargetManagement } from './components';
export { useShiftOptions } from './hooks/use-shift-options';
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2022",
    "experimentalDecorators": true,
    "useDefineForClassFields": false,
    "module": "ESNext",
    "lib": [
      "ES2022",
      "DOM",
      "DOM.Iterable"
    ],
    "skipLibCheck": true,
    "types": [
      "node",
      "vite/client",
      "vitest/globals",
      "@testing-library/jest-dom"
    ],
    "moduleResolution": "bundler",
    "isolatedModules": true,
    "moduleDetection": "force",
    "allowJs": true,
    "jsx": "react-jsx",
    "paths": {
      "@/*": [
        "./src/*"
      ]
    },
    "allowImportingTsExtensions": true,
    "noEmit": true
  }
}
</file>

<file path="vite.config.ts">
/// <reference types="vitest" />
import path from 'path';
import { defineConfig, loadEnv } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig(({ mode }) => {
  const env = loadEnv(mode, '.', '');
  return {
    server: {
      port: 3005,
      host: '0.0.0.0',
    },
    plugins: [react()],
    define: {
      'process.env.API_KEY': JSON.stringify(env.GEMINI_API_KEY),
      'process.env.GEMINI_API_KEY': JSON.stringify(env.GEMINI_API_KEY)
    },
    resolve: {
      alias: {
        '@': path.resolve(__dirname, './src'),
      }
    },
    test: {
      globals: true,
      environment: "jsdom",
      setupFiles: ["./src/test/setup.ts"],
      coverage: {
        provider: "v8",
        reporter: ["text", "json", "html"],
        exclude: ["node_modules/", "src/test/", "**/*.test.{ts,tsx}", "scripts/"],
        thresholds: {
          lines: 60,
          functions: 60,
          branches: 60,
          statements: 60
        }
      },
      include: ["**/*.{test,spec}.{ts,tsx}"],
      exclude: ["node_modules", "dist"],
    }
  };
});
</file>

<file path="src/App.test.tsx">
import { describe, it, expect, vi } from 'vitest'
import { render, screen, waitFor } from '@testing-library/react'
import App from './App'

describe('App', () => {
  it('renders without crashing', () => {
    render(<App />)
    expect(document.body).toBeInTheDocument()
  })

  it('shows loading or login screen by default', async () => {
    render(<App />)
    // App may show loading state first, then login screen
    // Check for either loading text or login form
    await waitFor(() => {
      const hasLoading = screen.queryByText(/Äang táº£i/i)
      const hasLoginForm = document.querySelector('form')
      expect(hasLoading || hasLoginForm).toBeTruthy()
    }, { timeout: 3000 })
  })
})
</file>

<file path="src/App.tsx">
/**
 * App.tsx - Main Application Entry
 * Orchestrates features and handles cross-feature interactions
 */

import React, { useState, useRef, useCallback, useEffect } from 'react';
import { AppProviders, AppLayout } from './core';
import { useAuth } from './features/auth';
import { useEmployees } from './features/hr';
import { useTargets } from './features/targets';
import { useTimesheet } from './features/timesheet';
import { TimesheetGrid } from './components/timesheet';
import { HRManagement } from './components/hr';
import { TargetManagement } from './features/targets';
import { ImageCapture, SyncButton, BackupButton } from './components/shared';
import { Employee, Target } from './types';
import { FileDown, FileUp, AlertCircle, Camera, DollarSign, FileSpreadsheet } from 'lucide-react';
import { exportToExcel, importTimesheetFromExcel, exportPayrollToExcel, downloadTimesheetTemplate } from './utils/excel-export';
import { getAllEmployees, getAllTargets } from './services/realtime-database-service';

const AppContent: React.FC = () => {
  const { currentUser } = useAuth();
  const { employees, addEmployee, updateEmployee, removeEmployee, refreshEmployees } = useEmployees();
  const { targets, addTarget, updateTarget, removeTarget, refreshTargets, setTargets } = useTargets();
  const { gridData, year, month, setYear, setMonth, setGridData, saveTimesheet, refreshTimesheet } = useTimesheet();

  const [errorMsg, setErrorMsg] = useState<string | null>(null);
  const [showImageCapture, setShowImageCapture] = useState(false);
  const importFileRef = useRef<HTMLInputElement>(null);

  // Load Gemini API key
  useEffect(() => {
    const savedKey = localStorage.getItem('gemini_api_key');
    if (savedKey) (window as any).__GEMINI_API_KEY__ = savedKey;
  }, []);

  // Sync complete handler
  const handleSyncComplete = useCallback(async () => {
    await Promise.all([refreshEmployees(), refreshTargets()]);
  }, [refreshEmployees, refreshTargets]);

  // Image data extraction handler
  const handleImageDataExtracted = useCallback(async (extractedEmployees: Employee[]) => {
    for (const emp of extractedEmployees) {
      const existing = employees.find(e => e.code === emp.code);
      if (existing) {
        // Update attendance
        setGridData(prev => prev.map(e =>
          e.id === existing.id ? { ...e, attendance: { ...e.attendance, ...emp.attendance } } : e
        ));
      } else {
        // Add new employee
        const newEmp = await addEmployee(emp);
        // Auto-create target if needed
        if (emp.department && emp.department !== 'ChÆ°a xÃ¡c Ä‘á»‹nh') {
          const existingTarget = targets.find(t => t.name === emp.department);
          if (!existingTarget) {
            await addTarget({ name: emp.department, roster: [{ employeeId: newEmp.id, shift: emp.shift || '08:00 - 17:00' }] });
          }
        }
      }
    }
    await saveTimesheet();
  }, [employees, targets, addEmployee, addTarget, setGridData, saveTimesheet]);

  // Grid change handler
  const handleGridChange = useCallback(async (newData: Employee[]) => {
    setGridData(newData);
    // Auto-save with debounce handled by context
    await saveTimesheet();
  }, [setGridData, saveTimesheet]);

  // Import Excel handler
  const handleImportExcel = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;
    setErrorMsg(null);

    try {
      const { employees: imported, errors } = await importTimesheetFromExcel(file, employees);
      if (errors.length > 0) setErrorMsg(`Cáº£nh bÃ¡o: ${errors.join(', ')}`);

      for (const emp of imported) {
        const existing = gridData.find(e => e.code === emp.code);
        if (existing) {
          setGridData(prev => prev.map(e =>
            e.code === emp.code ? { ...e, attendance: { ...e.attendance, ...emp.attendance } } : e
          ));
        } else {
          await addEmployee(emp);
        }
      }
      await saveTimesheet();
      alert(`ÄÃ£ nháº­p thÃ nh cÃ´ng ${imported.length} nhÃ¢n viÃªn tá»« file Excel!`);
    } catch (err: any) {
      setErrorMsg(err.message);
    }
    if (importFileRef.current) importFileRef.current.value = '';
  };

  // Month/Year selector for header
  const headerControls = (
    <div className="hidden lg:flex items-center space-x-2 mr-4">
      <select
        value={month}
        onChange={(e) => setMonth(parseInt(e.target.value))}
        className="bg-blue-900 text-white border border-blue-600 rounded px-2 py-1 text-sm outline-none shadow-sm cursor-pointer hover:bg-blue-800 transition"
      >
        {Array.from({ length: 12 }).map((_, i) => (
          <option key={i} value={i}>ThÃ¡ng {i + 1}</option>
        ))}
      </select>
      <input
        type="number"
        value={year}
        onChange={(e) => setYear(parseInt(e.target.value))}
        className="bg-blue-900 text-white border border-blue-600 rounded px-2 py-1 w-20 text-sm outline-none shadow-sm hover:bg-blue-800 transition"
      />
    </div>
  );

  return (
    <AppLayout headerControls={headerControls}>
      {({ currentView }) => (
        <>
          {currentView === 'timesheet' && (
            <>
              {/* Actions Bar */}
              <div className="flex justify-end mb-4 space-x-2">
                <SyncButton onSyncComplete={handleSyncComplete} />
                <BackupButton />
                <button onClick={() => setShowImageCapture(true)} className="flex items-center space-x-2 bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded shadow transition text-sm font-medium text-white">
                  <Camera size={16} /><span>Chá»¥p áº¢nh & Nháº­p Dá»¯ Liá»‡u</span>
                </button>
                <button onClick={() => downloadTimesheetTemplate(year, month)} className="flex items-center space-x-2 bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded shadow transition text-sm font-medium text-white" title="Táº£i máº«u Excel">
                  <FileSpreadsheet size={16} /><span>Táº£i Máº«u</span>
                </button>
                <button onClick={() => importFileRef.current?.click()} className="flex items-center space-x-2 bg-green-600 hover:bg-green-700 px-4 py-2 rounded shadow transition text-sm font-medium text-white">
                  <FileUp size={16} /><span>Nháº­p Excel</span>
                </button>
                <button onClick={() => exportToExcel(gridData, year, month)} className="flex items-center space-x-2 bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded shadow transition text-sm font-medium text-white">
                  <FileDown size={16} /><span>Xuáº¥t Excel</span>
                </button>
                <button onClick={() => exportPayrollToExcel(gridData, year, month)} className="flex items-center space-x-2 bg-amber-600 hover:bg-amber-500 px-4 py-2 rounded shadow transition text-sm font-medium text-white" title="Xuáº¥t báº£ng lÆ°Æ¡ng">
                  <DollarSign size={16} /><span>Xuáº¥t LÆ°Æ¡ng</span>
                </button>
                <input ref={importFileRef} type="file" accept=".xlsx,.xls" onChange={handleImportExcel} className="hidden" />
              </div>

              {errorMsg && (
                <div className="mb-4 bg-red-50 border border-red-200 text-red-600 p-3 rounded">
                  <div className="flex items-center mb-2"><AlertCircle size={18} className="mr-2" /><span className="font-semibold">Lá»—i xá»­ lÃ½</span></div>
                  <div className="text-sm">{errorMsg}</div>
                </div>
              )}

              <TimesheetGrid
                year={year}
                month={month}
                data={gridData}
                targets={targets}
                allEmployees={employees}
                onDataChange={handleGridChange}
              />

              <ImageCapture
                isOpen={showImageCapture}
                onClose={() => setShowImageCapture(false)}
                onDataExtracted={handleImageDataExtracted}
                existingEmployees={employees}
              />
            </>
          )}

          {currentView === 'targets' && (
            <TargetManagement
              targets={targets}
              employees={employees}
              onUpdateTargets={setTargets}
            />
          )}

          {currentView === 'hr' && (
            <HRManagement
              employees={employees}
              gridData={gridData}
              year={year}
              month={month}
              currentUser={currentUser}
              onUpdateEmployee={(emp) => updateEmployee(emp.id, emp)}
              onDeleteEmployee={removeEmployee}
              onAddEmployee={addEmployee}
            />
          )}
        </>
      )}
    </AppLayout>
  );
};

const App: React.FC = () => (
  <AppProviders>
    <AppContent />
  </AppProviders>
);

export default App;
</file>

<file path="src/test/setup.ts">
import { expect, afterEach, vi } from 'vitest'
import { cleanup } from '@testing-library/react'
import '@testing-library/jest-dom'

// Mock Firebase packages BEFORE any imports
vi.mock('firebase/app', () => ({
  initializeApp: vi.fn(() => ({}))
}))

vi.mock('firebase/database', () => ({
  getDatabase: vi.fn(() => ({})),
  ref: vi.fn(() => ({})),
  get: vi.fn(() => Promise.resolve({ exists: () => false, val: () => null })),
  set: vi.fn(() => Promise.resolve()),
  update: vi.fn(() => Promise.resolve()),
  remove: vi.fn(() => Promise.resolve()),
  push: vi.fn(() => ({ key: 'mock-id' })),
  child: vi.fn(() => ({}))
}))

// Mock the lib/firebase module
vi.mock('../lib/firebase', () => ({
  app: null,
  db: null,
  isFirebaseAvailable: vi.fn(() => false),
  getFirebaseError: vi.fn(() => null)
}))

// Mock Firebase realtime-database-service
vi.mock('../services/realtime-database-service', () => ({
  getAllEmployees: vi.fn().mockResolvedValue([]),
  getEmployeeById: vi.fn().mockResolvedValue(null),
  createEmployee: vi.fn().mockResolvedValue('mock-id'),
  updateEmployee: vi.fn().mockResolvedValue(undefined),
  deleteEmployee: vi.fn().mockResolvedValue(undefined),
  getAllTargets: vi.fn().mockResolvedValue([]),
  getTargetById: vi.fn().mockResolvedValue(null),
  createTarget: vi.fn().mockResolvedValue('mock-id'),
  updateTarget: vi.fn().mockResolvedValue(undefined),
  deleteTarget: vi.fn().mockResolvedValue(undefined),
  getTimesheet: vi.fn().mockResolvedValue([]),
  saveTimesheet: vi.fn().mockResolvedValue(undefined),
  saveAllTimesheets: vi.fn().mockResolvedValue(undefined),
  importInitialData: vi.fn().mockResolvedValue(undefined)
}))

// Mock sheets service
vi.mock('../services/sheets-service', () => ({
  readSheetData: vi.fn().mockResolvedValue([]),
  getSheetMetadata: vi.fn().mockResolvedValue({ title: 'Test', headers: [], rowCount: 0 }),
  sheetRowToEmployee: vi.fn().mockImplementation(row => row),
  testSheetsConnection: vi.fn().mockResolvedValue({ success: true, message: 'OK' })
}))

// Mock sync service
vi.mock('../services/sync-service', () => ({
  syncFromSheets: vi.fn().mockResolvedValue({
    success: true,
    timestamp: new Date(),
    imported: 0,
    updated: 0,
    skipped: 0,
    errors: [],
    duration: 0
  }),
  getSyncLogs: vi.fn().mockResolvedValue([]),
  getLastSyncTime: vi.fn().mockResolvedValue(null)
}))

// Mock backup service
vi.mock('../services/backup-service', () => ({
  exportAsJson: vi.fn().mockResolvedValue(new Blob(['{}'], { type: 'application/json' })),
  downloadBackup: vi.fn(),
  createAndDownloadBackup: vi.fn().mockResolvedValue(undefined)
}))

afterEach(() => {
  cleanup()
  localStorage.clear()
})

// Mock matchMedia
Object.defineProperty(window, 'matchMedia', {
  writable: true,
  value: vi.fn().mockImplementation(query => ({
    matches: false,
    media: query,
    onchange: null,
    addListener: vi.fn(),
    removeListener: vi.fn(),
    addEventListener: vi.fn(),
    removeEventListener: vi.fn(),
    dispatchEvent: vi.fn(),
  })),
})

// Mock localStorage
const localStorageMock = {
  getItem: vi.fn(),
  setItem: vi.fn(),
  removeItem: vi.fn(),
  clear: vi.fn(),
}
Object.defineProperty(window, 'localStorage', { value: localStorageMock })
</file>

</files>
